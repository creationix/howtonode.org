<!DOCTYPE html>
<html lang="en">
<!-- Mirrored from localhost:8080/http-mock-testing by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 13 Jul 2021 13:57:07 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset="utf-8" /><title>Easy HTTP Mock Testing with Nock and node-tap - How To Node - NodeJS</title><meta name="description" content="Learn the zen of coding in NodeJS." /><meta name="viewport" content="width=device-width" /><link href="style.css" rel="stylesheet" /><link href="print.css" rel="stylesheet" media="print" /><link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="feed.xml" /><link href="favicon.ico" rel="icon" type="image/x-icon" /></head><body><div id="container"><div id="header"><a href="index.html"><img src="logo.png" alt="How to Node" class="logo" /><div class="tagline">The zen of coding in node.js</div></a></div><div id="main"><div class="article"><h1><a href="http-mock-testing.html">Easy HTTP Mock Testing with Nock and node-tap</a></h1><p class="old-node-warning">HEADS UP! This article was written for an older version of node.&nbsp;More up-to-date information may be available elsewhere.</p><p>One of my first node.js libraries was <a href="https://github.com/dscape/nano">nano</a>: A no fuss CouchDB client based on the super pervasive <a href="https://github.com/mikeal/request">request</a>. In foresight that was a good idea, even though there's a ton of clients for CouchDB none of them is as simple as <code>nano</code>, and the fact that its based on <code>request</code> is great.</p>

<p>When you are writing a HTTP client you need to test with one (or several) HTTP endpoints. I was lazy about it so I choose to point nano to <a href="http://iriscouch.com/">iriscouch</a> and run the tests on real HTTP requests. This was a problematic but overall ok approach.</p>

<p>Then some weeks ago I started automating the tests using <a href="http://travis-ci.org/#!/dscape/nano">travis</a>. And builds started to fail. To make this work and fix all the shortcomings of a direct connection to <code>iriscouch</code>. I needed a HTTP Mocking module.</p>

<p>By the way Travis is super cool. You should test all your node.js libraries with it. All you need to do is go to the site, sign in with github and place a <code>.travis.yml</code> file like this one in the root of your lib:</p>

<pre><code><span class="pln">&nbsp; language</span><span class="pun">:</span><span class="pln"> </span><span class="str">"node_js"</span><span class="pln"><br />&nbsp; node_js</span><span class="pun">:</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">-</span><span class="pln"> </span><span class="lit">0.4</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">-</span><span class="pln"> </span><span class="lit">0.6</span><span class="pln"><br /></span></code></pre>

<h2>Enter Nock</h2>

<p><a href="http://nodetuts.com/">Pedro Teixeira</a>'s <a href="https://github.com/pgte/nock">nock</a> allows you do HTTP Mock Testing while preserving the possibility to run the tests against a real http endpoint.</p>

<p>Let's start on this small <a href="https://github.com/isaacs/node-tap">tap</a> test <code>sudo npm install tap nano nock</code>:</p>

<pre><code><span class="pln">&nbsp; </span><span class="kwd">var</span><span class="pln"> nano </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'nano'</span><span class="pun">)(</span><span class="str">'http://nodejsbug.iriscouch.com'</span><span class="pun">)</span><span class="pln"> <br />&nbsp; </span><span class="kwd">var</span><span class="pln"> test </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'tap'</span><span class="pun">).</span><span class="pln">test</span><span class="pun">;</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> db &nbsp; </span><span class="pun">=</span><span class="pln"> nano</span><span class="pun">.</span><span class="kwd">use</span><span class="pun">(</span><span class="str">'testing_nock'</span><span class="pun">);</span><span class="pln"><br /><br />&nbsp; test</span><span class="pun">(</span><span class="str">'Insert a Document Into CouchDB'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">t</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; t</span><span class="pun">.</span><span class="pln">plan</span><span class="pun">(</span><span class="lit">4</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; nano</span><span class="pun">.</span><span class="pln">db</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span><span class="str">'testing_nock'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; db</span><span class="pun">.</span><span class="pln">insert</span><span class="pun">({</span><span class="pln">foo</span><span class="pun">:</span><span class="pln"> </span><span class="str">"bar"</span><span class="pun">},</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">function</span><span class="pln"> ensure_insert_worked_cb</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> doc</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t</span><span class="pun">.</span><span class="pln">notOk</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> </span><span class="str">'No errors'</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t</span><span class="pun">.</span><span class="pln">ok</span><span class="pun">(</span><span class="pln">doc</span><span class="pun">.</span><span class="pln">ok</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Contains ok'</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t</span><span class="pun">.</span><span class="pln">ok</span><span class="pun">(</span><span class="pln">doc</span><span class="pun">.</span><span class="pln">rev</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Rev exists'</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t</span><span class="pun">.</span><span class="pln">ok</span><span class="pun">(</span><span class="pln">doc</span><span class="pun">.</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Id exists'</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /></span></code></pre>

<p>If we save this in a file <code>test.js</code> we can run the tests and see they all work. We can even invoke the script with debugging turned on and inspect the HTTP requests/response flow <code>NANO_ENV=testing node test.js</code>:</p>

<pre><code><span class="pln">&nbsp; </span><span class="pun">{</span><span class="pln"> url</span><span class="pun">:</span><span class="pln"> </span><span class="str">'http://nodejsbug.iriscouch.com'</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br />&nbsp; </span><span class="pun">&gt;&gt;</span><span class="pln"><br />&nbsp; </span><span class="pun">{</span><span class="pln"> method</span><span class="pun">:</span><span class="pln"> </span><span class="str">'PUT'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; headers</span><span class="pun">:</span><span class="pln"> <br />&nbsp; &nbsp; &nbsp;</span><span class="pun">{</span><span class="pln"> </span><span class="str">'content-type'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'application/json'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;accept</span><span class="pun">:</span><span class="pln"> </span><span class="str">'application/json'</span><span class="pln"> </span><span class="pun">},</span><span class="pln"><br />&nbsp; &nbsp; uri</span><span class="pun">:</span><span class="pln"> </span><span class="str">'http://nodejsbug.iriscouch.com/testing_nock'</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br />&nbsp; </span><span class="pun">&lt;&lt;</span><span class="pln"><br />&nbsp; </span><span class="pun">{</span><span class="pln"> err</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; body</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> ok</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">true</span><span class="pln"> </span><span class="pun">},</span><span class="pln"><br />&nbsp; &nbsp; headers</span><span class="pun">:</span><span class="pln"> <br />&nbsp; &nbsp; &nbsp;</span><span class="pun">{</span><span class="pln"> location</span><span class="pun">:</span><span class="pln"> </span><span class="str">'http://nodejsbug.iriscouch.com/testing_nock'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;date</span><span class="pun">:</span><span class="pln"> </span><span class="str">'Thu, 01 Dec 2011 16:42:21 GMT'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="str">'content-type'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'application/json'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="str">'cache-control'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'must-revalidate'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="str">'status-code'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">201</span><span class="pln"> </span><span class="pun">}</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br />&nbsp; </span><span class="pun">&gt;&gt;</span><span class="pln"><br />&nbsp; </span><span class="pun">{</span><span class="pln"> method</span><span class="pun">:</span><span class="pln"> </span><span class="str">'POST'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; headers</span><span class="pun">:</span><span class="pln"> <br />&nbsp; &nbsp; &nbsp;</span><span class="pun">{</span><span class="pln"> </span><span class="str">'content-type'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'application/json'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;accept</span><span class="pun">:</span><span class="pln"> </span><span class="str">'application/json'</span><span class="pln"> </span><span class="pun">},</span><span class="pln"><br />&nbsp; &nbsp; uri</span><span class="pun">:</span><span class="pln"> </span><span class="str">'http://nodejsbug.iriscouch.com/testing_nock'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; body</span><span class="pun">:</span><span class="pln"> </span><span class="str">'{"foo":"bar"}'</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br />&nbsp; </span><span class="pun">&lt;&lt;</span><span class="pln"><br />&nbsp; </span><span class="pun">{</span><span class="pln"> err</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; body</span><span class="pun">:</span><span class="pln"> <br />&nbsp; &nbsp; &nbsp;</span><span class="pun">{</span><span class="pln"> ok</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;id</span><span class="pun">:</span><span class="pln"> </span><span class="str">'f191a858a66828d8de66b3c974005346'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;rev</span><span class="pun">:</span><span class="pln"> </span><span class="str">'1-4c6114c65e295552ab1019e2b046b10e'</span><span class="pln"> </span><span class="pun">},</span><span class="pln"><br />&nbsp; &nbsp; headers</span><span class="pun">:</span><span class="pln"> <br />&nbsp; &nbsp; &nbsp;</span><span class="pun">{</span><span class="pln"> location</span><span class="pun">:</span><span class="pln"> </span><span class="str">'http://nodejsbug.iriscouch.com/testing_nock/f191a858a66828d8de66b3c974005346'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;date</span><span class="pun">:</span><span class="pln"> </span><span class="str">'Thu, 01 Dec 2011 16:42:22 GMT'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="str">'content-type'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'application/json'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="str">'cache-control'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'must-revalidate'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="str">'status-code'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">201</span><span class="pln"> </span><span class="pun">}</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br />&nbsp; </span><span class="com"># Insert a Document Into CouchDB</span><span class="pln"><br />&nbsp; ok </span><span class="lit">1</span><span class="pln"> </span><span class="typ">No</span><span class="pln"> errors<br />&nbsp; ok </span><span class="lit">2</span><span class="pln"> </span><span class="typ">Contains</span><span class="pln"> ok<br />&nbsp; ok </span><span class="lit">3</span><span class="pln"> </span><span class="typ">Rev</span><span class="pln"> exists<br />&nbsp; ok </span><span class="lit">4</span><span class="pln"> </span><span class="typ">Id</span><span class="pln"> exists<br /><br />&nbsp; </span><span class="lit">1.</span><span class="pun">.</span><span class="lit">4</span><span class="pln"><br />&nbsp; </span><span class="com"># tests 4</span><span class="pln"><br />&nbsp; </span><span class="com"># pass &nbsp;4</span><span class="pln"><br /><br />&nbsp; </span><span class="com"># ok</span><span class="pln"><br /></span></code></pre>

<p>So <code>nano</code> gives you a way to actually see all the HTTP traffic that it creates and receives. This is great but I still need to write code to support these interactions.</p>

<p>With <code>nock</code> this is super simple:</p>

<pre><code><span class="pln">&nbsp; </span><span class="kwd">var</span><span class="pln"> nano </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'nano'</span><span class="pun">)(</span><span class="str">'http://nodejsbug.iriscouch.com'</span><span class="pun">)</span><span class="pln"> <br />&nbsp; </span><span class="kwd">var</span><span class="pln"> nock </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'nock'</span><span class="pun">);</span><span class="pln"> </span><span class="com">// we require nock</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> test </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'tap'</span><span class="pun">).</span><span class="pln">test</span><span class="pun">;</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> db &nbsp; </span><span class="pun">=</span><span class="pln"> nano</span><span class="pun">.</span><span class="kwd">use</span><span class="pun">(</span><span class="str">'testing_nock'</span><span class="pun">);</span><span class="pln"><br /><br />&nbsp; </span><span class="com">// tell nock to record the http interactions</span><span class="pln"><br />&nbsp; nock</span><span class="pun">.</span><span class="pln">recorder</span><span class="pun">.</span><span class="pln">rec</span><span class="pun">();</span><span class="pln"><br /><br />&nbsp; test</span><span class="pun">(</span><span class="str">'Insert a Document Into CouchDB'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">t</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; t</span><span class="pun">.</span><span class="pln">plan</span><span class="pun">(</span><span class="lit">4</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; nano</span><span class="pun">.</span><span class="pln">db</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span><span class="str">'testing_nock'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; db</span><span class="pun">.</span><span class="pln">insert</span><span class="pun">({</span><span class="pln">foo</span><span class="pun">:</span><span class="pln"> </span><span class="str">"bar"</span><span class="pun">},</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">function</span><span class="pln"> ensure_insert_worked_cb</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> doc</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t</span><span class="pun">.</span><span class="pln">notOk</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> </span><span class="str">'No errors'</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t</span><span class="pun">.</span><span class="pln">ok</span><span class="pun">(</span><span class="pln">doc</span><span class="pun">.</span><span class="pln">ok</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Contains ok'</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t</span><span class="pun">.</span><span class="pln">ok</span><span class="pun">(</span><span class="pln">doc</span><span class="pun">.</span><span class="pln">rev</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Rev exists'</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t</span><span class="pun">.</span><span class="pln">ok</span><span class="pun">(</span><span class="pln">doc</span><span class="pun">.</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Id exists'</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /></span></code></pre>

<p>Running the tests returns:</p>

<pre><code><span class="pln">&nbsp; $ node test</span><span class="pun">.</span><span class="pln">js <br /><br />&nbsp; </span><span class="pun">&lt;&lt;&lt;&lt;&lt;&lt;--</span><span class="pln"> cut here </span><span class="pun">--&gt;&gt;&gt;&gt;&gt;&gt;</span><span class="pln"><br /><br />&nbsp; nock</span><span class="pun">(</span><span class="str">'nodejsbug.iriscouch.com'</span><span class="pun">)</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">.</span><span class="pln">put</span><span class="pun">(</span><span class="str">'/testing_nock'</span><span class="pun">)</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">.</span><span class="pln">reply</span><span class="pun">(</span><span class="lit">412</span><span class="pun">,</span><span class="pln"> </span><span class="str">"{\"error\":\"file_exists\",\"reason\":\"The database could not be created, the file already exists.\"}\n"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> server</span><span class="pun">:</span><span class="pln"> </span><span class="str">'CouchDB/1.1.1 (Erlang OTP/R14B04)'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; date</span><span class="pun">:</span><span class="pln"> </span><span class="str">'Thu, 01 Dec 2011 17:43:30 GMT'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">'content-type'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'application/json'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">'content-length'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'95'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">'cache-control'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'must-revalidate'</span><span class="pln"> </span><span class="pun">});</span><span class="pln"><br /><br />&nbsp; </span><span class="pun">&lt;&lt;&lt;&lt;&lt;&lt;--</span><span class="pln"> cut here </span><span class="pun">--&gt;&gt;&gt;&gt;&gt;&gt;</span><span class="pln"><br /><br />&nbsp; </span><span class="pun">&lt;&lt;&lt;&lt;&lt;&lt;--</span><span class="pln"> cut here </span><span class="pun">--&gt;&gt;&gt;&gt;&gt;&gt;</span><span class="pln"><br /><br />&nbsp; nock</span><span class="pun">(</span><span class="str">'nodejsbug.iriscouch.com'</span><span class="pun">)</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">.</span><span class="pln">post</span><span class="pun">(</span><span class="str">'/testing_nock'</span><span class="pun">,</span><span class="pln"> </span><span class="str">"{\"foo\":\"bar\"}"</span><span class="pun">)</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">.</span><span class="pln">reply</span><span class="pun">(</span><span class="lit">201</span><span class="pun">,</span><span class="pln"> </span><span class="str">"{\"ok\":true,\"id\":\"8b787a6a1c2476ef9a2eed069e000ff0\",\"rev\":\"1-4c6114c65e295552ab1019e2b046b10e\"}\n"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> server</span><span class="pun">:</span><span class="pln"> </span><span class="str">'CouchDB/1.1.1 (Erlang OTP/R14B04)'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; location</span><span class="pun">:</span><span class="pln"> </span><span class="str">'http://nodejsbug.iriscouch.com/testing_nock/8b787a6a1c2476ef9a2eed069e000ff0'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; date</span><span class="pun">:</span><span class="pln"> </span><span class="str">'Thu, 01 Dec 2011 17:43:31 GMT'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">'content-type'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'application/json'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">'content-length'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'95'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">'cache-control'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'must-revalidate'</span><span class="pln"> </span><span class="pun">});</span><span class="pln"><br /><br />&nbsp; </span><span class="pun">&lt;&lt;&lt;&lt;&lt;&lt;--</span><span class="pln"> cut here </span><span class="pun">--&gt;&gt;&gt;&gt;&gt;&gt;</span><span class="pln"><br /><br />&nbsp; </span><span class="com"># Insert a Document Into CouchDB</span><span class="pln"><br />&nbsp; ok </span><span class="lit">1</span><span class="pln"> </span><span class="typ">No</span><span class="pln"> errors<br />&nbsp; ok </span><span class="lit">2</span><span class="pln"> </span><span class="typ">Contains</span><span class="pln"> ok<br />&nbsp; ok </span><span class="lit">3</span><span class="pln"> </span><span class="typ">Rev</span><span class="pln"> exists<br />&nbsp; ok </span><span class="lit">4</span><span class="pln"> </span><span class="typ">Id</span><span class="pln"> exists<br /><br />&nbsp; </span><span class="lit">1.</span><span class="pun">.</span><span class="lit">4</span><span class="pln"><br />&nbsp; </span><span class="com"># tests 4</span><span class="pln"><br />&nbsp; </span><span class="com"># pass &nbsp;4</span><span class="pln"><br /><br />&nbsp; </span><span class="com"># ok</span><span class="pln"><br /></span></code></pre>

<p>So now all we need to do is add these nock http mocks and we are done:</p>

<pre><code><span class="pln">&nbsp; </span><span class="kwd">var</span><span class="pln"> nano </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'nano'</span><span class="pun">)(</span><span class="str">'http://nodejsbug.iriscouch.com'</span><span class="pun">)</span><span class="pln"> <br />&nbsp; </span><span class="kwd">var</span><span class="pln"> nock </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'nock'</span><span class="pun">);</span><span class="pln"> </span><span class="com">// we require nock</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> test </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'tap'</span><span class="pun">).</span><span class="pln">test</span><span class="pun">;</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> db &nbsp; </span><span class="pun">=</span><span class="pln"> nano</span><span class="pun">.</span><span class="kwd">use</span><span class="pun">(</span><span class="str">'testing_nock'</span><span class="pun">);</span><span class="pln"><br /><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> couch </span><span class="pun">=</span><span class="pln"> nock</span><span class="pun">(</span><span class="str">'nodejsbug.iriscouch.com'</span><span class="pun">)</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">.</span><span class="pln">put</span><span class="pun">(</span><span class="str">'/testing_nock'</span><span class="pun">)</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">.</span><span class="pln">reply</span><span class="pun">(</span><span class="pln"> </span><span class="lit">412</span><span class="pln"><br />&nbsp; &nbsp; &nbsp;</span><span class="pun">,</span><span class="pln"> </span><span class="str">"{ \"error\":\"file_exists\""</span><span class="pun">+</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">", \"reason\":\"The database could not be created, the file"</span><span class="pln"> </span><span class="pun">+</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">" already exists.\"}\n"</span><span class="pln"><br />&nbsp; &nbsp; &nbsp;</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> server</span><span class="pun">:</span><span class="pln"> </span><span class="str">'CouchDB/1.1.1 (Erlang OTP/R14B04)'</span><span class="pln"><br />&nbsp; &nbsp; &nbsp;</span><span class="pun">,</span><span class="pln"> date</span><span class="pun">:</span><span class="pln"> </span><span class="str">'Thu, 01 Dec 2011 17:43:30 GMT'</span><span class="pln"><br />&nbsp; &nbsp; &nbsp;</span><span class="pun">,</span><span class="pln"> </span><span class="str">'content-type'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'application/json'</span><span class="pln"><br />&nbsp; &nbsp; &nbsp;</span><span class="pun">,</span><span class="pln"> </span><span class="str">'content-length'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'95'</span><span class="pln"><br />&nbsp; &nbsp; &nbsp;</span><span class="pun">,</span><span class="pln"> </span><span class="str">'cache-control'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'must-revalidate'</span><span class="pln"> </span><span class="pun">})</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">.</span><span class="pln">post</span><span class="pun">(</span><span class="str">'/testing_nock'</span><span class="pun">,</span><span class="pln"> </span><span class="str">"{\"foo\":\"bar\"}"</span><span class="pun">)</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">.</span><span class="pln">reply</span><span class="pun">(</span><span class="lit">201</span><span class="pln"><br />&nbsp; &nbsp; &nbsp;</span><span class="pun">,</span><span class="pln"> </span><span class="str">"{ \"ok\":true"</span><span class="pln"> </span><span class="pun">+</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="str">", \"id\":\"8b787a6a1c2476ef9a2eed069e000ff0\""</span><span class="pln"> </span><span class="pun">+</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="str">", \"rev\":\"1-4c6114c65e295552ab1019e2b046b10e\"}\n"</span><span class="pln"><br />&nbsp; &nbsp; &nbsp;</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> server</span><span class="pun">:</span><span class="pln"> </span><span class="str">'CouchDB/1.1.1 (Erlang OTP/R14B04)'</span><span class="pln"><br />&nbsp; &nbsp; &nbsp;</span><span class="pun">,</span><span class="pln"> location</span><span class="pun">:</span><span class="pln"> </span><span class="str">'http://nodejsbug.iriscouch.com/testing_nock/'</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">+</span><span class="pln"> </span><span class="str">'8b787a6a1c2476ef9a2eed069e000ff0'</span><span class="pln"><br />&nbsp; &nbsp; &nbsp;</span><span class="pun">,</span><span class="pln"> date</span><span class="pun">:</span><span class="pln"> </span><span class="str">'Thu, 01 Dec 2011 17:43:31 GMT'</span><span class="pln"><br />&nbsp; &nbsp; &nbsp;</span><span class="pun">,</span><span class="pln"> </span><span class="str">'content-type'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'application/json'</span><span class="pln"><br />&nbsp; &nbsp; &nbsp;</span><span class="pun">,</span><span class="pln"> </span><span class="str">'content-length'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'95'</span><span class="pln"><br />&nbsp; &nbsp; &nbsp;</span><span class="pun">,</span><span class="pln"> </span><span class="str">'cache-control'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'must-revalidate'</span><span class="pln"> </span><span class="pun">});</span><span class="pln"><br /><br />&nbsp; test</span><span class="pun">(</span><span class="str">'Insert a Document Into CouchDB'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">t</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; t</span><span class="pun">.</span><span class="pln">plan</span><span class="pun">(</span><span class="lit">4</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; nano</span><span class="pun">.</span><span class="pln">db</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span><span class="str">'testing_nock'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; db</span><span class="pun">.</span><span class="pln">insert</span><span class="pun">({</span><span class="pln">foo</span><span class="pun">:</span><span class="pln"> </span><span class="str">"bar"</span><span class="pun">},</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">function</span><span class="pln"> ensure_insert_worked_cb</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> doc</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t</span><span class="pun">.</span><span class="pln">notOk</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> </span><span class="str">'No errors'</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t</span><span class="pun">.</span><span class="pln">ok</span><span class="pun">(</span><span class="pln">doc</span><span class="pun">.</span><span class="pln">ok</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Contains ok'</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t</span><span class="pun">.</span><span class="pln">ok</span><span class="pun">(</span><span class="pln">doc</span><span class="pun">.</span><span class="pln">rev</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Rev exists'</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t</span><span class="pun">.</span><span class="pln">ok</span><span class="pun">(</span><span class="pln">doc</span><span class="pun">.</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Id exists'</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /></span></code></pre>

<p>All working, happy nocking! :)</p>

<pre><code><span class="pln">&nbsp; $ node test</span><span class="pun">.</span><span class="pln">js <br />&nbsp; </span><span class="com"># Insert a Document Into CouchDB</span><span class="pln"><br />&nbsp; ok </span><span class="lit">1</span><span class="pln"> </span><span class="typ">No</span><span class="pln"> errors<br />&nbsp; ok </span><span class="lit">2</span><span class="pln"> </span><span class="typ">Contains</span><span class="pln"> ok<br />&nbsp; ok </span><span class="lit">3</span><span class="pln"> </span><span class="typ">Rev</span><span class="pln"> exists<br />&nbsp; ok </span><span class="lit">4</span><span class="pln"> </span><span class="typ">Id</span><span class="pln"> exists<br /><br />&nbsp; </span><span class="lit">1.</span><span class="pun">.</span><span class="lit">4</span><span class="pln"><br />&nbsp; </span><span class="com"># tests 4</span><span class="pln"><br />&nbsp; </span><span class="com"># pass &nbsp;4</span><span class="pln"><br /><br />&nbsp; </span><span class="com"># ok</span><span class="pln"><br /></span></code></pre>

<p>For the inquisitive types this is how nock intercepts the http requests: Nock uses the the fact that <code>node</code> caches modules that you <code>require</code> and overrides the behavior of the default HTTP request in node. So any request you do will be filtered by Nock. Check out the <a href="https://github.com/pgte/nock/blob/master/lib/intercept.js">source code</a> if you want to see more details.</p><hr style="clear:both" /><div class="body" id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
var disqus_url = "http://howtonode.org/http-mock-testing";
//]]>
</script>
<script src="http://disqus.com/forums/howtonodeorg/embed.js" type="text/javascript"></script><a href="http://disqus.com/forums/howtonodeorg/?url=ref" class="view-thread">View the discussion thread.</a><a href="http://disqus.com/" class="dsq-brlink">blog comments powered by<span class="logo-disqus">Disqus</span></a>
<script type="text/javascript">
//<![CDATA[
(function() {
  var links = document.getElementsByTagName('a');
  var query = '?';
  for(var i = 0; i < links.length; i++) {
    if(links[i].href.indexOf('#disqus_thread') >= 0) {
      query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&amp;';
    }
  }
  document.write('<script charset="utf-8" type="text/javascript" src="//disqus.com/forums/howtonodeorg/get_num_replies.js' + query + '"></' + 'script>');
})();


//]]>
</script>
</div></div><div id="sidebar"><div class="aside author"><h4>About the Author</h4><img src="https://www.gravatar.com/avatar/a998795c23a775e72ee28643c482a1f4?r=pg&amp;s=200.jpg&amp;d=identicon" class="headshot" /><dl><dt>Name:</dt><dd>Nuno Job</dd></dl><dl><dt>Github:</dt><dd><a href="https://github.com/dscape">dscape</a></dd></dl><dl><dt>Twitter:</dt><dd><a href="https://twitter.com/dscape">dscape</a></dd></dl><dl><dt>Links:</dt><dd><a href="http://nunojob.com/">Homepage</a></dd></dl></div><div class="aside"><h4>About this Article</h4><a href="http://twitter.com/share" data-count="horizontal" data-via="creationix" class="twitter-share-button">Tweet</a><script src="http://platform.twitter.com/widgets.js"></script><dl title="Tue Dec 06 2011 10:15:00 GMT"><dt>Date Released:</dt><dd>Tuesday, December  6, 2011</dd></dl><dl><dt>Node Version:</dt><dd><a href="http://github.com/joyent/node/tree/v0.6.5">node v0.6.5</a></dd></dl><dl><dt>Revisions:</dt><dd><ul></ul></dd></dl></div><div class="bubble"><h3>About HowToNode.org</h3>

<p>HowToNode.org is a community supported blog created by <a href="http://creationix.com/">Tim Caswell</a>. The purpose of the blog is to teach how to do various tasks in <a href="http://nodejs.org/">node.js</a> as well as teach fundamental concepts that are needed to write effective code.</p>

<p>This site is powered by <a href="http://github.com/creationix/wheat">Wheat</a>, a git based blogging engine written in <a href="http://nodejs.org/">node.JS</a>.</p>

<p>The content for this site is stored in a <a href="http://github.com/creationix/howtonode.org">git repository</a> that anyone can fork, write an article, and send a pull request. If your article passes the quality standards it will be published and help support the greater node community.</p></div></div><div id="footer"><p>&copy; 2011-2014 Tim Caswell under the MIT license.</p><p>Content and articles are copyrighted to the individual authors. Design by&nbsp;<a href="https://bengourley.co.uk/">Ben Gourley</a>. All code snippets used in the examples are in the public domain.</p><p>Wheat v2 running on node.js v16.4.2</p></div></div>
<script type="text/javascript">
//<![CDATA[
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
//]]>
</script>

<script type="text/javascript">
//<![CDATA[
try {
var pageTracker = _gat._getTracker("UA-12824411-1");
pageTracker._trackPageview();
} catch(err) {}
//]]>
</script>
</body>
<!-- Mirrored from localhost:8080/http-mock-testing by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 13 Jul 2021 13:57:07 GMT -->
</html>