<!DOCTYPE html>
<html lang="en">
<!-- Mirrored from localhost:8080/redis-pubsub by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 13 Jul 2021 13:57:19 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset="utf-8" /><title>Node.js and Redis Pub-Sub - How To Node - NodeJS</title><meta name="description" content="Learn the zen of coding in NodeJS." /><meta name="viewport" content="width=device-width" /><link href="style.css" rel="stylesheet" /><link href="print.css" rel="stylesheet" media="print" /><link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="feed.xml" /><link href="favicon.ico" rel="icon" type="image/x-icon" /></head><body><div id="container"><div id="header"><a href="index.html"><img src="logo.png" alt="How to Node" class="logo" /><div class="tagline">The zen of coding in node.js</div></a></div><div id="main"><div class="article"><h1><a href="redis-pubsub.html">Node.js and Redis Pub-Sub</a></h1><p class="old-node-warning">HEADS UP! This article was written for an older version of node.&nbsp;More up-to-date information may be available elsewhere.</p><blockquote>
  <p>This is the 7th in a series of posts leading up to <a href="http://nodeknockout.com/">Node.js Knockout</a> on how to use <a href="http://nodejs.org/">node.js</a>. This post, <a href="http://github.com/waratuman/flight-stream">cross-posted from GitHub</a>, was written by <a href="http://github.com/waratuman">James Bracy</a>, founder of <a href="http://redistogo.com/">Redis To Go</a>. <a href="http://redistogo.com/">Redis To Go</a> is a dead simple solution for managed Redis instances.</p>
</blockquote>

<h2>Node.js and Redis Pub-Sub</h2>

<p><a href="http://nodejs.org/">Node.js</a> is a perfect platform for creating event driven
applications. <a href="http://code.google.com/p/redis/">Redis</a> and <a href="http://en.wikipedia.org/wiki/WebSockets">WebSockets</a>
are great companions to Node.js. The following tutorial will walk through the
steps to build a web application that streams real time flight information
using Node.js, Redis, and WebSockets.</p>

<h2>Dependencies</h2>

<p>Node.js, Redis, and a WebSocket enabled browser (<a href="http://www.mozilla.com/en-US/firefox/beta/">Firefox 4</a>,
<a href="http://www.google.com/chrome">Google Chrome 4</a>, or <a href="http://www.apple.com/safari/">Safari 5</a>)
are required. A tutorial covering the installation of Node.js can be found
<a href="http://nodeknockout.posterous.com/countdown-to-knockout-post-1-how-to-install-n">here</a>.</p>

<p>The easiest way to get a Redis instance would be to use <a href="http://redistogo.com/">Redis To Go</a>.
The free plan is all that is needed for this tutorial. If you wish to install
locally run the following commands:</p>

<pre><code><span class="pln">$ git clone http</span><span class="pun">:</span><span class="com">//github.com/antirez/redis.git</span><span class="pln"><br />$ cd redis</span><span class="pun">/</span><span class="pln">src<br />$ make<br />$ sudo make install<br />$ cd </span><span class="pun">../..</span><span class="pln"><br />$ rm </span><span class="pun">-</span><span class="pln">rf redis<br /></span></code></pre>

<p>Now you can start a Redis instance locally using the <code>redis-server</code> command.</p>

<h2>Create the Project</h2>

<p>Create a directory for the project. We will name the project "Flight Stream".</p>

<pre><code><span class="pln">$ mkdir flight</span><span class="pun">-</span><span class="pln">stream<br />$ cd flight</span><span class="pun">-</span><span class="pln">stream<br /></span></code></pre>

<p>The project will require the Node.js Redis client <a href="http://github.com/fictorial/redis-node-client"><code>redis-client</code></a>,
the WebSocket library <a href="http://github.com/miksago/node-websocket-server"><code>node-websocket-server</code></a>,
and the MIME library <a href="http://github.com/bentomas/node-mime">node-mime</a>. Create
a <code>lib</code> directory and copy the libraries to this directory.</p>

<pre><code><span class="pln">$ mkdir lib<br />$ cd lib<br />$ curl </span><span class="pun">-</span><span class="pln">O http</span><span class="pun">:</span><span class="com">//github.com/fictorial/redis-node-client/raw/master/lib/redis-client.js \</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">-</span><span class="pln">O http</span><span class="pun">:</span><span class="com">//github.com/bentomas/node-mime/raw/master/mime.js \</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">-</span><span class="pln">O http</span><span class="pun">:</span><span class="com">//github.com/miksago/node-websocket-server/raw/master/lib/ws.js</span><span class="pln"><br />$ mkdir ws<br />$ cd ws<br />$ curl </span><span class="pun">-</span><span class="pln">O http</span><span class="pun">:</span><span class="com">//github.com/miksago/node-websocket-server/raw/master/lib/ws/connection.js \</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">-</span><span class="pln">O http</span><span class="pun">:</span><span class="com">//github.com/miksago/node-websocket-server/raw/master/lib/ws/manager.js</span><span class="pln"><br />$ cd </span><span class="pun">../..</span><span class="pln"><br /></span></code></pre>

<h2>Create the Server</h2>

<p>Initially the Node.js server will simply server the static index.html file that
will be create. Create the <code>server.js</code> file and add the following code:</p>

<div class="snippet"><a href="redis-pubsub/server.js" class="code-link">server.js</a><pre><code><span class="kwd">require</span><span class="pun">.</span><span class="pln">paths</span><span class="pun">.</span><span class="pln">unshift</span><span class="pun">(</span><span class="pln">__dirname </span><span class="pun">+</span><span class="pln"> </span><span class="str">'/lib'</span><span class="pun">);</span><span class="pln"><br /><br /></span><span class="kwd">var</span><span class="pln"> fs </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'fs'</span><span class="pun">),</span><span class="pln"><br />&nbsp; &nbsp; ws </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'ws'</span><span class="pun">),</span><span class="pln"><br />&nbsp; &nbsp; sys </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'sys'</span><span class="pun">),</span><span class="pln"><br />&nbsp; &nbsp; url </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'url'</span><span class="pun">),</span><span class="pln"><br />&nbsp; &nbsp; http </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'http'</span><span class="pun">),</span><span class="pln"><br />&nbsp; &nbsp; path </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'path'</span><span class="pun">),</span><span class="pln"><br />&nbsp; &nbsp; mime </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'mime'</span><span class="pun">),</span><span class="pln"><br />&nbsp; &nbsp; redis </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'redis-client'</span><span class="pun">);</span><span class="pln"><br /><br /></span><span class="kwd">var</span><span class="pln"> httpServer </span><span class="pun">=</span><span class="pln"> http</span><span class="pun">.</span><span class="pln">createServer</span><span class="pun">(</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">request</span><span class="pun">,</span><span class="pln"> response</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> pathname </span><span class="pun">=</span><span class="pln"> url</span><span class="pun">.</span><span class="pln">parse</span><span class="pun">(</span><span class="pln">request</span><span class="pun">.</span><span class="pln">url</span><span class="pun">).</span><span class="pln">pathname</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">pathname </span><span class="pun">==</span><span class="pln"> </span><span class="str">"/"</span><span class="pun">)</span><span class="pln"> pathname </span><span class="pun">=</span><span class="pln"> </span><span class="str">"index.html"</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> filename </span><span class="pun">=</span><span class="pln"> path</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="pln">process</span><span class="pun">.</span><span class="pln">cwd</span><span class="pun">(),</span><span class="pln"> </span><span class="str">'public'</span><span class="pun">,</span><span class="pln"> pathname</span><span class="pun">);</span><span class="pln"><br /><br />&nbsp; &nbsp; path</span><span class="pun">.</span><span class="pln">exists</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">exists</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">exists</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; response</span><span class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span class="lit">404</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/plain"</span><span class="pun">});</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; response</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="str">"404 Not Found"</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; response</span><span class="pun">.</span><span class="kwd">end</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">return</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br /><br />&nbsp; &nbsp; &nbsp; &nbsp; response</span><span class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="str">'Content-Type'</span><span class="pun">:</span><span class="pln"> mime</span><span class="pun">.</span><span class="pln">lookup</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)});</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; fs</span><span class="pun">.</span><span class="pln">createReadStream</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">'flags'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'r'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">'encoding'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'binary'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">'mode'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0666</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">'bufferSize'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">4</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">1024</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">}).</span><span class="pln">addListener</span><span class="pun">(</span><span class="str">"data"</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">chunk</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; response</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">chunk</span><span class="pun">,</span><span class="pln"> </span><span class="str">'binary'</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">}).</span><span class="pln">addListener</span><span class="pun">(</span><span class="str">"close"</span><span class="pun">,</span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; response</span><span class="pun">.</span><span class="kwd">end</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /><br /><br /></span><span class="kwd">var</span><span class="pln"> server </span><span class="pun">=</span><span class="pln"> ws</span><span class="pun">.</span><span class="pln">createServer</span><span class="pun">({</span><span class="pln">server</span><span class="pun">:</span><span class="pln"> httpServer</span><span class="pun">});</span><span class="pln"><br /><br />server</span><span class="pun">.</span><span class="pln">listen</span><span class="pun">(</span><span class="lit">8000</span><span class="pun">);</span></code></pre></div>

<p>The <code>httpServer</code> serves the static files in the <code>public</code> directory. The
<code>server</code> is what will be handling the WebSocket connections.</p>

<p>Create the <code>public</code> directory:</p>

<pre><code><span class="pln">$ mkdir </span><span class="kwd">public</span><span class="pln"><br /></span></code></pre>

<p>Now copy the source for the index and stylesheets from <a href="http://github.com/waratuman/flight-stream">github</a>.</p>

<pre><code><span class="pln">$ cd </span><span class="kwd">public</span><span class="pln"><br />$ curl </span><span class="pun">-</span><span class="pln">O http</span><span class="pun">:</span><span class="com">//github.com/waratuman/flight-stream/raw/master/public/application.css \</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">-</span><span class="pln">O http</span><span class="pun">:</span><span class="com">//github.com/waratuman/flight-stream/raw/master/public/reset.css \</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">-</span><span class="pln">O http</span><span class="pun">:</span><span class="com">//github.com/waratuman/flight-stream/raw/master/public/jquery.js \</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">-</span><span class="pln">O http</span><span class="pun">:</span><span class="com">//github.com/waratuman/flight-stream/raw/master/public/text.css \</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">-</span><span class="pln">O http</span><span class="pun">:</span><span class="com">//github.com/waratuman/flight-stream/raw/master/public/index.html</span><span class="pln"><br />$ mkdir images<br />$ cd images<br />$ curl </span><span class="pun">-</span><span class="pln">O http</span><span class="pun">:</span><span class="com">//github.com/waratuman/flight-stream/raw/master/public/images/background.png \</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">-</span><span class="pln">O http</span><span class="pun">:</span><span class="com">//github.com/waratuman/flight-stream/raw/master/public/images/red.png \</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">-</span><span class="pln">O http</span><span class="pun">:</span><span class="com">//github.com/waratuman/flight-stream/raw/master/public/images/orange.png \</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">-</span><span class="pln">O http</span><span class="pun">:</span><span class="com">//github.com/waratuman/flight-stream/raw/master/public/images/green.png \</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">-</span><span class="pln">O http</span><span class="pun">:</span><span class="com">//github.com/waratuman/flight-stream/raw/master/public/images/blue.png</span><span class="pln"><br /></span></code></pre>

<p>At this point you should be able to run <code>node server.js</code> and see the index
page when you got to <code>localhost:8000</code>.</p>

<p>Now lets get <code>redis-client</code> working in the server. The following lines
establish a connection to Redis. The <code>connected</code> and <code>reconnected</code> listeners
authenticate the connection after it has been established.</p>

<div class="snippet"><a href="redis-pubsub/redis-client.js" class="code-link">redis-client.js</a><pre><code><span class="kwd">var</span><span class="pln"> db </span><span class="pun">=</span><span class="pln"> redis</span><span class="pun">.</span><span class="pln">createClient</span><span class="pun">(</span><span class="lit">9281</span><span class="pun">,</span><span class="pln"> </span><span class="str">'goosefish.redistogo.com'</span><span class="pun">);</span><span class="pln"><br /></span><span class="kwd">var</span><span class="pln"> dbAuth </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">auth</span><span class="pun">(</span><span class="str">'dc64f7b818f4e3ec2e3d3d033e3e5ff4'</span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br />db</span><span class="pun">.</span><span class="pln">addListener</span><span class="pun">(</span><span class="str">'connected'</span><span class="pun">,</span><span class="pln"> dbAuth</span><span class="pun">);</span><span class="pln"><br />db</span><span class="pun">.</span><span class="pln">addListener</span><span class="pun">(</span><span class="str">'reconnected'</span><span class="pun">,</span><span class="pln"> dbAuth</span><span class="pun">);</span><span class="pln"><br />dbAuth</span><span class="pun">();</span></code></pre></div>

<p><cite style="float: right;">View the full source <a href="http://github.com/waratuman/flight-stream/blob/master/server.js">here</a></cite>
<br /><br /></p>

<p>Now subscribe to the <code>flight_stream</code> channel on Redis.</p>

<div class="snippet"><a href="redis-pubsub/redis-subscribe.js" class="code-link">redis-subscribe.js</a><pre><code><span class="pln">db</span><span class="pun">.</span><span class="pln">subscribeTo</span><span class="pun">(</span><span class="str">"flight_stream"</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">channel</span><span class="pun">,</span><span class="pln"> message</span><span class="pun">,</span><span class="pln"> pattern</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">try</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">var</span><span class="pln"> flight </span><span class="pun">=</span><span class="pln"> JSON</span><span class="pun">.</span><span class="pln">parse</span><span class="pun">(</span><span class="pln">message</span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">catch</span><span class="pln"> </span><span class="pun">(</span><span class="typ">SyntaxError</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br /><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> flight</span><span class="pun">.</span><span class="pln">origin</span><span class="pun">.</span><span class="pln">iata </span><span class="pun">==</span><span class="pln"> </span><span class="str">"BOS"</span><span class="pln"> </span><span class="pun">||</span><span class="pln"> flight</span><span class="pun">.</span><span class="pln">destination</span><span class="pun">.</span><span class="pln">iata </span><span class="pun">==</span><span class="pln"> </span><span class="str">"BOS"</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; server</span><span class="pun">.</span><span class="pln">broadcast</span><span class="pun">(</span><span class="pln">message</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br /></span><span class="pun">});</span></code></pre></div>

<p><cite style="float: right;">View the full source <a href="http://github.com/waratuman/flight-stream/blob/master/server.js">here</a></cite>
<br /><br /></p>

<p>Whenever a message is published the function passed to the <code>subscribeTo</code>
method will get called. In this case we try to parse the message as JSON then
publish it to all of the clients if the flight is leaving Boston or arriving
at Boston.</p>

<h1>Client</h1>

<p>Next the client will need to be coded. I previously created the HTML for this
app, so all that we need to do is set up the WebSockets.</p>

<p>Open <code>public/application.js</code> and insert the following code. This code will
create a WebSocket if the browser supports it and if it does, create a
connection with the server. When a message is received, another row will be
inserted on the page displaying the flight.</p>

<div class="snippet"><a href="redis-pubsub/application.js" class="code-link">application.js</a><pre><code><span class="kwd">function</span><span class="pln"> delay_color</span><span class="pun">(</span><span class="pln">mins</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> min </span><span class="pun">=</span><span class="pln"> parseInt</span><span class="pun">(</span><span class="pln">mins</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">min </span><span class="pun">&lt;=</span><span class="pln"> </span><span class="pun">-</span><span class="lit">15</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="str">'green'</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">else</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">min </span><span class="pun">&lt;=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="str">'green'</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">else</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">min </span><span class="pun">&lt;=</span><span class="pln"> </span><span class="lit">15</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="str">'orange'</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">else</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="str">'red'</span><span class="pun">;</span><span class="pln"><br /></span><span class="pun">}</span><span class="pln"><br /><br /></span><span class="kwd">function</span><span class="pln"> delay_name</span><span class="pun">(</span><span class="pln">mins</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> min </span><span class="pun">=</span><span class="pln"> parseInt</span><span class="pun">(</span><span class="pln">mins</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">min </span><span class="pun">&lt;=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="str">'On-Time'</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">else</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="str">'Delayed'</span><span class="pun">;</span><span class="pln"><br /></span><span class="pun">}</span><span class="pln"><br /><br /></span><span class="kwd">var</span><span class="pln"> ws</span><span class="pun">;</span><span class="pln"><br /></span><span class="kwd">var</span><span class="pln"> connect </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">window</span><span class="pun">[</span><span class="str">'WebSocket'</span><span class="pun">])</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; alert</span><span class="pun">(</span><span class="str">"No WebSocket support."</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">return</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br /><br />&nbsp; &nbsp; ws </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">WebSocket</span><span class="pun">(</span><span class="str">'ws://'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> window</span><span class="pun">.</span><span class="pln">location</span><span class="pun">.</span><span class="pln">host</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; ws</span><span class="pun">.</span><span class="pln">onmessage </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">evt</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">try</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">var</span><span class="pln"> flight </span><span class="pun">=</span><span class="pln"> JSON</span><span class="pun">.</span><span class="pln">parse</span><span class="pun">(</span><span class="pln">evt</span><span class="pun">.</span><span class="pln">data</span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">catch</span><span class="pln"> </span><span class="pun">(</span><span class="typ">SyntaxError</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br /><br />&nbsp; &nbsp; &nbsp; &nbsp; $</span><span class="pun">(</span><span class="str">'table.flight-updates &gt; tbody'</span><span class="pun">).</span><span class="pln">prepend</span><span class="pun">(</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">'&lt;tr&gt;'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">'&lt;td&gt;'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> flight</span><span class="pun">.</span><span class="pln">airline</span><span class="pun">.</span><span class="pln">icao </span><span class="pun">+</span><span class="pln"> </span><span class="str">' '</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> flight</span><span class="pun">.</span><span class="pln">number </span><span class="pun">+</span><span class="pln"> </span><span class="str">'&lt;/td&gt;'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">'&lt;td&gt;'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> flight</span><span class="pun">.</span><span class="pln">origin</span><span class="pun">.</span><span class="pln">iata </span><span class="pun">+</span><span class="pln"> </span><span class="str">'&lt;/td&gt;'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">'&lt;td&gt;'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> flight</span><span class="pun">.</span><span class="pln">destination</span><span class="pun">.</span><span class="pln">iata </span><span class="pun">+</span><span class="pln"> </span><span class="str">'&lt;/td&gt;'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">'&lt;td&gt;'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">'&lt;div class="tag '</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> delay_color</span><span class="pun">(</span><span class="pln">flight</span><span class="pun">.</span><span class="pln">destination</span><span class="pun">.</span><span class="pln">gate_delay</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">'"&gt;'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; delay_name</span><span class="pun">(</span><span class="pln">flight</span><span class="pun">.</span><span class="pln">destination</span><span class="pun">.</span><span class="pln">gate_delay</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">'&lt;span&gt;'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> flight</span><span class="pun">.</span><span class="pln">destination</span><span class="pun">.</span><span class="pln">gate_delay </span><span class="pun">+</span><span class="pln"> </span><span class="str">' min&lt;/span&gt;'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">'&lt;/div&gt;'</span><span class="pun">+</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">'&lt;/td&gt;'</span><span class="pun">+</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">'&lt;td&gt;'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> flight</span><span class="pun">.</span><span class="pln">destination</span><span class="pun">.</span><span class="pln">gate </span><span class="pun">+</span><span class="pln"> </span><span class="str">'&lt;/td&gt;'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">'&lt;/tr&gt;'</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">};</span><span class="pln"><br /></span><span class="pun">};</span><span class="pln"><br /><br />$</span><span class="pun">(</span><span class="pln">document</span><span class="pun">).</span><span class="pln">ready</span><span class="pun">(</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; connect</span><span class="pun">();</span><span class="pln"><br /></span><span class="pun">});</span></code></pre></div>

<p>The functions <code>delay_color</code> and <code>delay_name</code> are helper functions for
displaying text and selecting the right class for styling.</p>

<p>Now you can start the server, go to <a href="http://localhost:8000/">http://localhost:8000/</a>
and you should start seeing updates roll in. If you are using your own Redis,
you are going to need to publish something to the <code>flight_stream</code>. Here is a 
sample message that you can use:</p>

<pre><code><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">"number"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"482"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">"status"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"Scheduled"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">"origin"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"gate_delay"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"icao"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"KSFO"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"name"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"San Francisco International Airport"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"iata"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"SFO"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"gate"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"3-88"</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">},</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">"destination"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"gate_delay"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"icao"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"KBOS"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"name"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"Denver International Airport"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"iata"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"BOS"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"gate"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"-"</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">},</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">"airline"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"icao"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"UAL"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"name"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"United Airlines"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"iata"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"UA"</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br /></span><span class="pun">}</span><span class="pln"><br /></span></code></pre>

<p>If you are using the Redis instance used throughout the tutorial, you will
start seeing flight come up. I will be publishing some data every few seconds
to the instance for the coming days.</p>

<h2>Basic Operations</h2>

<p>Basic operations were not really covered in this tutorial, so here are some
examples to get you started.</p>

<div class="snippet"><a href="redis-pubsub/basic-operations.js" class="code-link">basic-operations.js</a><pre><code><span class="pln">db</span><span class="pun">.</span><span class="kwd">set</span><span class="pun">(</span><span class="str">"foo"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span><span class="pln"><br />db</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">"foo"</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> value</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> sys</span><span class="pun">.</span><span class="pln">puts</span><span class="pun">(</span><span class="pln">value</span><span class="pun">);</span><span class="pln"> </span><span class="pun">});</span><span class="pln"><br />db</span><span class="pun">.</span><span class="pln">randomkey</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> key</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> sys</span><span class="pun">.</span><span class="pln">puts</span><span class="pun">(</span><span class="pln">key</span><span class="pun">);</span><span class="pln"> </span><span class="pun">});</span><span class="pln"><br />db</span><span class="pun">.</span><span class="pln">hset</span><span class="pun">(</span><span class="str">"bar"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"hi"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"world"</span><span class="pun">);</span><span class="pln"><br />db</span><span class="pun">.</span><span class="pln">hget</span><span class="pun">(</span><span class="str">"bar"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"hi"</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> value</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> sys</span><span class="pun">.</span><span class="pln">puts</span><span class="pun">(</span><span class="pln">value</span><span class="pun">);</span><span class="pln"> </span><span class="pun">});</span><span class="pln"><br />db</span><span class="pun">.</span><span class="pln">hgetall</span><span class="pun">(</span><span class="str">"bar"</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> sys</span><span class="pun">.</span><span class="pln">puts</span><span class="pun">(</span><span class="pln">data</span><span class="pun">[</span><span class="str">"hi"</span><span class="pun">]);</span><span class="pln"> </span><span class="pun">});</span></code></pre></div><hr style="clear:both" /><div class="body" id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
var disqus_url = "http://howtonode.org/redis-pubsub";
//]]>
</script>
<script src="http://disqus.com/forums/howtonodeorg/embed.js" type="text/javascript"></script><a href="http://disqus.com/forums/howtonodeorg/?url=ref" class="view-thread">View the discussion thread.</a><a href="http://disqus.com/" class="dsq-brlink">blog comments powered by<span class="logo-disqus">Disqus</span></a>
<script type="text/javascript">
//<![CDATA[
(function() {
  var links = document.getElementsByTagName('a');
  var query = '?';
  for(var i = 0; i < links.length; i++) {
    if(links[i].href.indexOf('#disqus_thread') >= 0) {
      query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&amp;';
    }
  }
  document.write('<script charset="utf-8" type="text/javascript" src="//disqus.com/forums/howtonodeorg/get_num_replies.js' + query + '"></' + 'script>');
})();


//]]>
</script>
</div></div><div id="sidebar"><div class="aside author"><h4>About the Author</h4><img src="https://www.gravatar.com/avatar/07949fed3b1168425027bb9423c665ff?r=pg&amp;s=200.jpg&amp;d=identicon" class="headshot" /><dl><dt>Name:</dt><dd>James R. Bracy</dd></dl><dl><dt>Github:</dt><dd><a href="https://github.com/waratuman">waratuman</a></dd></dl><dl><dt>Twitter:</dt><dd><a href="https://twitter.com/waratuman">waratuman</a></dd></dl><dl><dt>Links:</dt><dd><a href="http://www.waratuman.com/">Homepage</a></dd></dl></div><div class="aside"><h4>About this Article</h4><a href="http://twitter.com/share" data-count="horizontal" data-via="creationix" class="twitter-share-button">Tweet</a><script src="http://platform.twitter.com/widgets.js"></script><dl title="Wed Dec 01 2010 20:36:43 GMT-0800 (PST)"><dt>Date Released:</dt><dd>Wednesday, December  1, 2010</dd></dl><dl><dt>Node Version:</dt><dd><a href="http://github.com/joyent/node/tree/v0.2.0">node v0.2.0</a></dd></dl><dl><dt>Code Samples:</dt><dd><ul><li><a href="redis-pubsub/server.js">server.js</a></li><li><a href="redis-pubsub/redis-client.js">redis-client.js</a></li><li><a href="redis-pubsub/redis-subscribe.js">redis-subscribe.js</a></li><li><a href="redis-pubsub/application.js">application.js</a></li><li><a href="redis-pubsub/basic-operations.js">basic-operations.js</a></li></ul></dd></dl><dl><dt>Revisions:</dt><dd><ul></ul></dd></dl></div><div class="bubble"><h3>About HowToNode.org</h3>

<p>HowToNode.org is a community supported blog created by <a href="http://creationix.com/">Tim Caswell</a>. The purpose of the blog is to teach how to do various tasks in <a href="http://nodejs.org/">node.js</a> as well as teach fundamental concepts that are needed to write effective code.</p>

<p>This site is powered by <a href="http://github.com/creationix/wheat">Wheat</a>, a git based blogging engine written in <a href="http://nodejs.org/">node.JS</a>.</p>

<p>The content for this site is stored in a <a href="http://github.com/creationix/howtonode.org">git repository</a> that anyone can fork, write an article, and send a pull request. If your article passes the quality standards it will be published and help support the greater node community.</p></div></div><div id="footer"><p>&copy; 2011-2014 Tim Caswell under the MIT license.</p><p>Content and articles are copyrighted to the individual authors. Design by&nbsp;<a href="https://bengourley.co.uk/">Ben Gourley</a>. All code snippets used in the examples are in the public domain.</p><p>Wheat v2 running on node.js v16.4.2</p></div></div>
<script type="text/javascript">
//<![CDATA[
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
//]]>
</script>

<script type="text/javascript">
//<![CDATA[
try {
var pageTracker = _gat._getTracker("UA-12824411-1");
pageTracker._trackPageview();
} catch(err) {}
//]]>
</script>
</body>
<!-- Mirrored from localhost:8080/redis-pubsub by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 13 Jul 2021 13:57:24 GMT -->
</html>