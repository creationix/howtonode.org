<!DOCTYPE html>
<html lang="en">
<!-- Mirrored from localhost:8080/tasks-and-prompts by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 13 Jul 2021 13:59:35 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset="utf-8" /><title>Tasks and Prompts -- Implementing Simple Work Queues - How To Node - NodeJS</title><meta name="description" content="Learn the zen of coding in NodeJS." /><meta name="viewport" content="width=device-width" /><link href="style.css" rel="stylesheet" /><link href="print.css" rel="stylesheet" media="print" /><link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="feed.xml" /><link href="favicon.ico" rel="icon" type="image/x-icon" /></head><body><div id="container"><div id="header"><a href="index.html"><img src="logo.png" alt="How to Node" class="logo" /><div class="tagline">The zen of coding in node.js</div></a></div><div id="main"><div class="article"><h1><a href="tasks-and-prompts.html">Tasks and Prompts -- Implementing Simple Work Queues</a></h1><p class="old-node-warning">HEADS UP! This article was written for an older version of node.&nbsp;More up-to-date information may be available elsewhere.</p><p>Sometimes all you really need is orderly execution not blocking I/O to get the job done.  Tasks and prompts is a light weight implementation of the work queue design pattern.</p>

<h2>Implementing Simple Work Queues</h2>

<p>The other day I was converting a couple Bash installer scripts to node scripts. I recognized a familiar design pattern -- the work queue. Here's the requirements for a typical work queue approach -</p>

<ul>
<li>tasks are queued, first in first out (i.e. tracked)</li>
<li>tasks once started continue without further intervention</li>
<li>tasks are independent (i.e. task A does not depend on task B or visa versa)</li>
<li>tasks are execute once</li>
</ul>

<h2>My requirements</h2>

<ul>
<li>tasks fired in sequence without concern for when they complete</li>
<li>some tasks required a prompt and response before firing</li>
<li>I wanted to queue tasks and prompts before running the work queue</li>
</ul>

<p>A simple JavaScript array works fine as a first in first out queue (i.e. shift() pops the zeroth position off). An object's properties can keep track of what text I wanted to displayed; the callback to be fired; and if I need to show a prompt or get a response when firing a callback. tasks-and-prompts.js is a simple example of doing that:</p>

<div class="snippet"><a href="tasks-and-prompts/tasks-and-prompts.js" class="code-link">tasks-and-prompts.js</a><pre><code><span class="kwd">var</span><span class="pln"> work_queue </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[];</span><span class="pln"> </span><span class="com">/* This holds our first in, first out queue of prompts and tasks */</span><span class="pln"><br /><br /></span><span class="com">/* This is the method we used to put prompted items into the work queue.<br />&nbsp; &nbsp; prompts will pass a response to the callback method. */</span><span class="pln"><br />prompt </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">msg</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="com">/* A queued item has some text, a callback and a work queue type (i.e. work_type) */</span><span class="pln"><br />&nbsp; work_queue</span><span class="pun">.</span><span class="pln">push</span><span class="pun">({</span><span class="str">'text'</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> msg</span><span class="pun">,</span><span class="pln"> </span><span class="str">'callback'</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> callback</span><span class="pun">,</span><span class="pln"> </span><span class="str">'work_type'</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="str">'prompt'</span><span class="pun">})</span><span class="pln"><br /></span><span class="pun">};</span><span class="pln"><br /><br /></span><span class="com">/* task puts items into the work queue that don't require a prompt and response.<br />&nbsp; &nbsp; tasks don't wait for an answer, they just get fired. Since no response is<br />&nbsp; &nbsp; pending the callback will get called without any parameters. */</span><span class="pln"><br />task </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">label</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; work_queue</span><span class="pun">.</span><span class="pln">push</span><span class="pun">({</span><span class="str">'text'</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> label</span><span class="pun">,</span><span class="pln"> </span><span class="str">'callback'</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> callback</span><span class="pun">,</span><span class="pln"> </span><span class="str">'work_type'</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="str">'task'</span><span class="pln"> </span><span class="pun">});</span><span class="pln"><br /></span><span class="pun">};</span><span class="pln"><br /><br /></span><span class="com">/* This is our work horse function. &nbsp;It runs all the tasks and prompts */</span><span class="pln"><br />run </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="com">/* this is just a convenience inner function to make the code easier to read. <br />&nbsp; &nbsp; &nbsp; it fires off tasks until it finds a prompt or nothing is left in the<br />&nbsp; &nbsp; &nbsp; work queue. */</span><span class="pln"><br />&nbsp; taskRunner </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> action</span><span class="pun">;</span><span class="pln"> </span><span class="com">/* Place holder for action we shift out of the queue */</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln">work_queue</span><span class="pun">.</span><span class="pln">length </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="com">/* If next queued item is a prompt, show the prompt and exit taskRunner. */</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">work_queue</span><span class="pun">[</span><span class="lit">0</span><span class="pun">].</span><span class="pln">work_type </span><span class="pun">===</span><span class="pln"> </span><span class="str">'prompt'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; process</span><span class="pun">.</span><span class="pln">stdout</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">work_queue</span><span class="pun">[</span><span class="lit">0</span><span class="pun">].</span><span class="pln">text </span><span class="pun">+</span><span class="pln"> </span><span class="str">"\n"</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">return</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="com">/* If we have a task we show the text associated with the task and<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fire off the callback. Notice we don't wait for it to return.<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Work queue only insures the order of firing not anything else. */</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">work_queue</span><span class="pun">[</span><span class="lit">0</span><span class="pun">].</span><span class="pln">work_type </span><span class="pun">===</span><span class="pln"> </span><span class="str">'task'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; action </span><span class="pun">=</span><span class="pln"> work_queue</span><span class="pun">.</span><span class="pln">shift</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; process</span><span class="pun">.</span><span class="pln">stdout</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">action</span><span class="pun">.</span><span class="pln">text </span><span class="pun">+</span><span class="pln"> </span><span class="str">"\n"</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; action</span><span class="pun">.</span><span class="pln">callback</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; </span><span class="pun">};</span><span class="pln"><br /><br />&nbsp; </span><span class="com">/* Process any tasks in the work queue that might be ahead of prompts */</span><span class="pln"><br />&nbsp; taskRunner</span><span class="pun">();</span><span class="pln"><br />&nbsp; </span><span class="com">/* We only open stdio and add a listener if we have items which prompt. */</span><span class="pln"><br />&nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">work_queue</span><span class="pun">.</span><span class="pln">length </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="com">/* Open the standard input stream and set the encoding to UTF-8 */</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> stdin </span><span class="pun">=</span><span class="pln"> process</span><span class="pun">.</span><span class="pln">openStdin</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; stdin</span><span class="pun">.</span><span class="pln">setEncoding</span><span class="pun">(</span><span class="str">'utf8'</span><span class="pun">);</span><span class="pln"><br /><br />&nbsp; &nbsp; &nbsp; </span><span class="com">/* This is the callback for handing data events from standard input. */</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; inputHandler </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">response</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">/* Now that we're listening we either handle a prompt or handle a task<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; until the work queue is empty. */</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln">work_queue</span><span class="pun">.</span><span class="pln">length </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">work_queue</span><span class="pun">[</span><span class="lit">0</span><span class="pun">].</span><span class="pln">work_type </span><span class="pun">===</span><span class="pln"> </span><span class="str">'prompt'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; action </span><span class="pun">=</span><span class="pln"> work_queue</span><span class="pun">.</span><span class="pln">shift</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; action</span><span class="pun">.</span><span class="pln">callback</span><span class="pun">(</span><span class="pln">response</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">/* If any tasks, prompts run next */</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; taskRunner</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">work_queue</span><span class="pun">.</span><span class="pln">length </span><span class="pun">===</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; process</span><span class="pun">.</span><span class="kwd">exit</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">};</span><span class="pln"><br /><br />&nbsp; &nbsp; &nbsp; </span><span class="com">/* Now that we have defined out handlers, add them as listeners for data and end events. */</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; stdin</span><span class="pun">.</span><span class="pln">on</span><span class="pun">(</span><span class="str">'data'</span><span class="pun">,</span><span class="pln"> inputHandler</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}());</span><span class="pln"><br />&nbsp; </span><span class="pun">}</span><span class="pln"><br /></span><span class="pun">};</span><span class="pln"><br /><br /></span><span class="com">/*<br />&nbsp; * Now let's setup some tasks and prompts to do some work<br />&nbsp; */</span><span class="pln"><br /><br /></span><span class="com">/* You might prompt to do some setup before firing your tasks */</span><span class="pln"><br />prompt</span><span class="pun">(</span><span class="str">"Are you there? "</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; process</span><span class="pun">.</span><span class="pln">stdout</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="str">"Answer was: "</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> data </span><span class="pun">+</span><span class="pln"> </span><span class="str">"\n"</span><span class="pun">);</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"> <br /><br /></span><span class="com">/* Tasks run unattended. work_queue only ensures the order <br />&nbsp; &nbsp; the callbacks are fired not order of completion */</span><span class="pln"><br />task</span><span class="pun">(</span><span class="str">'Count to three:'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">&lt;=</span><span class="pln"> </span><span class="lit">3</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">+=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; process</span><span class="pun">.</span><span class="pln">stdout</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="str">"count: "</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> i </span><span class="pun">+</span><span class="pln"> </span><span class="str">"\n"</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">}</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /><br /></span><span class="com">/* Since run might open/close stdio it needs to be the last thing called. */</span><span class="pln"><br />run</span><span class="pun">();</span></code></pre></div>

<h2>Explanations</h2>

<p>In this simple example I prompt the user to answer a question then count to three. Pretty trivial but it's an implantation of a the work queue pattern. That pattern is common in installation or management scripts.  The only problem with the example above is that it isn't setup as a node module ... wait I did that already! See <a href="http://github.com/rsdoiel/nshtools">github.com/rsdoiel/nshtools</a>. nshtools.js includes a more elaborate implementation and with features like command line option processing and high level file commands like cp and mv. The github wiki and the README.md file for nshtools have some more short examples for your enjoyment.</p>

<p>Have fun!</p><hr style="clear:both" /><div class="body" id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
var disqus_url = "http://howtonode.org/tasks-and-prompts";
//]]>
</script>
<script src="http://disqus.com/forums/howtonodeorg/embed.js" type="text/javascript"></script><a href="http://disqus.com/forums/howtonodeorg/?url=ref" class="view-thread">View the discussion thread.</a><a href="http://disqus.com/" class="dsq-brlink">blog comments powered by<span class="logo-disqus">Disqus</span></a>
<script type="text/javascript">
//<![CDATA[
(function() {
  var links = document.getElementsByTagName('a');
  var query = '?';
  for(var i = 0; i < links.length; i++) {
    if(links[i].href.indexOf('#disqus_thread') >= 0) {
      query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&amp;';
    }
  }
  document.write('<script charset="utf-8" type="text/javascript" src="//disqus.com/forums/howtonodeorg/get_num_replies.js' + query + '"></' + 'script>');
})();


//]]>
</script>
</div></div><div id="sidebar"><div class="aside author"><h4>About the Author</h4><img src="https://www.gravatar.com/avatar/60c7b20527f236c7156a85772a97430f?r=pg&amp;s=200.jpg&amp;d=identicon" class="headshot" /><dl><dt>Name:</dt><dd>R. S. Doiel</dd></dl><dl><dt>Github:</dt><dd><a href="https://github.com/rsdoiel">rsdoiel</a></dd></dl><dl><dt>Links:</dt><dd><a href="http://phizcode.blogspot.com/">Homepage</a></dd></dl></div><div class="aside"><h4>About this Article</h4><a href="http://twitter.com/share" data-count="horizontal" data-via="creationix" class="twitter-share-button">Tweet</a><script src="http://platform.twitter.com/widgets.js"></script><dl title="Sun, 28 Feb 2010 00:50:22 GMT"><dt>Date Released:</dt><dd>Saturday, February 27, 2010</dd></dl><dl><dt>Node Version:</dt><dd><a href="http://github.com/joyent/node/tree/v0.1.103">node v0.1.103</a></dd></dl><dl><dt>Code Samples:</dt><dd><ul><li><a href="tasks-and-prompts/tasks-and-prompts.js">tasks-and-prompts.js</a></li></ul></dd></dl><dl><dt>Revisions:</dt><dd><ul></ul></dd></dl></div><div class="bubble"><h3>About HowToNode.org</h3>

<p>HowToNode.org is a community supported blog created by <a href="http://creationix.com/">Tim Caswell</a>. The purpose of the blog is to teach how to do various tasks in <a href="http://nodejs.org/">node.js</a> as well as teach fundamental concepts that are needed to write effective code.</p>

<p>This site is powered by <a href="http://github.com/creationix/wheat">Wheat</a>, a git based blogging engine written in <a href="http://nodejs.org/">node.JS</a>.</p>

<p>The content for this site is stored in a <a href="http://github.com/creationix/howtonode.org">git repository</a> that anyone can fork, write an article, and send a pull request. If your article passes the quality standards it will be published and help support the greater node community.</p></div></div><div id="footer"><p>&copy; 2011-2014 Tim Caswell under the MIT license.</p><p>Content and articles are copyrighted to the individual authors. Design by&nbsp;<a href="https://bengourley.co.uk/">Ben Gourley</a>. All code snippets used in the examples are in the public domain.</p><p>Wheat v2 running on node.js v16.4.2</p></div></div>
<script type="text/javascript">
//<![CDATA[
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
//]]>
</script>

<script type="text/javascript">
//<![CDATA[
try {
var pageTracker = _gat._getTracker("UA-12824411-1");
pageTracker._trackPageview();
} catch(err) {}
//]]>
</script>
</body>
<!-- Mirrored from localhost:8080/tasks-and-prompts by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 13 Jul 2021 13:59:36 GMT -->
</html>