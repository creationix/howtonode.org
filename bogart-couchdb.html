<!DOCTYPE html>
<html lang="en">
<!-- Mirrored from localhost:8080/bogart-couchdb by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 13 Jul 2021 13:57:07 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset="utf-8" /><title>A Simple Blog with CouchDB, Bogart, and Node.js - How To Node - NodeJS</title><meta name="description" content="Learn the zen of coding in NodeJS." /><meta name="viewport" content="width=device-width" /><link href="style.css" rel="stylesheet" /><link href="print.css" rel="stylesheet" media="print" /><link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="feed.xml" /><link href="favicon.ico" rel="icon" type="image/x-icon" /></head><body><div id="container"><div id="header"><a href="index.html"><img src="logo.png" alt="How to Node" class="logo" /><div class="tagline">The zen of coding in node.js</div></a></div><div id="main"><div class="article"><h1><a href="bogart-couchdb.html">A Simple Blog with CouchDB, Bogart, and Node.js</a></h1><p class="old-node-warning">HEADS UP! This article was written for an older version of node.&nbsp;More up-to-date information may be available elsewhere.</p><p><em>Update:</em> By request I have posted a <a href="https://gist.github.com/1232272">gist of the app.js</a>
using <em>MongoDB</em> instead of <em>CouchDB</em>.  This gist also serves as a beginning example
for how to use non-promise-based APIs with bogart.</p>

<p>In this article, you will learn how to use Bogart and CouchDB to create a minimal
blogging engine. The Express with MongoDB article was a huge hit. This article has
similar goals but shows a different way of using Node.JS.</p>

<h2>Pre-Requisites</h2>

<h3>npm</h3>

<p><a href="http://github.com/isaacs/npm">npm</a> is the most popular package manager for Node.js.
Installing npm is easy.</p>

<pre><code><span class="pln">curl http</span><span class="pun">:</span><span class="com">//npmjs.org/install.sh | sh</span><span class="pln"><br /></span></code></pre>

<p>A note for windows users: npm does not currently work on windows. It will in the future.</p>

<h3>Bogart</h3>

<p><a href="http://github.com/nrstott/bogart">Bogart</a> is a Sinatra-like framework designed 
to make it easy to create JSGI compliant web applications for node.js.</p>

<p>Bogart is in the npm registry.</p>

<pre><code><span class="pln">npm install bogart<br /></span></code></pre>

<h3>CouchDB</h3>

<p><a href="http://couchdb.apache.org/">CouchDB</a> is a document-oriented database with 
a RESTful interface. CouchDB works well with JavaScript since CouchDB speaks JSON.
Also, CouchDB is queried using 'views' that are, by default, written in JavaScript.
<a href="http://couchdb.apache.org/downloads.html">Download the latest release</a> from here.
CouchBase also maintains <a href="http://www.couchbase.com/downloads">debian and rpm packages</a> 
for the community.</p>

<h2>JSGI</h2>

<p>Bogart is a JSGI-based framework. JSGI is specified by the CommonJS mailing list. Knowledge
of JSGI is helpful when dealing with Bogart; however, it is not necessary. You can find
<a href="http://wiki.commonjs.org/wiki/JSGI">more information about JSGI</a> on the 
<a href="http://wiki.commonjs.org/">CommonJS wiki</a>.</p>

<h2>Mustache</h2>

<p><a href="http://github.com/janl/mustache.js">Mustache</a> is a minimal templating engine 
with {{mustaches}}. Mustache is the default templating engine of Bogart. 
When you install Bogart, you will also be installing Mustache.</p>

<h2>CouchDB-CommonJS</h2>

<p><a href="http://github.com/nrstott/couchdb-commonjs">CouchDB-CommonJS</a> is a promise-based 
CouchDB library available in the npm registry. It can also be used in the browser 
or with Narhwal.</p>

<pre><code><span class="pln">npm install couchdb<br /></span></code></pre>

<h2>What will our application do?</h2>

<p>To keep things simple, we're going to only tackle basic functionality. Our blog
application will support the following methods:</p>

<ul>
<li>Create a new post (POST /posts)</li>
<li>Show a list of all the posts (GET /posts)</li>
<li>Show a single post (GET /posts/:id)</li>
<li>Comment on a post (POST /posts/:id/comments)</li>
</ul>

<h2>Lets get started!</h2>

<p>A Bogart application consists of a JSGI server with one or more pieces of middleware and 
one or more Bogart routers each containing any number of routes.</p>

<p>The canonical 'Hello World' application in Bogart can be written as follows:</p>

<div class="snippet"><a href="bogart-couchdb/hello-world.js" class="code-link">hello-world.js</a><pre><code><span class="kwd">var</span><span class="pln"> bogart </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'bogart'</span><span class="pun">);</span><span class="pln"><br /><br /></span><span class="kwd">var</span><span class="pln"> router </span><span class="pun">=</span><span class="pln"> bogart</span><span class="pun">.</span><span class="pln">router</span><span class="pun">();</span><span class="pln"><br /><br />router</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">return</span><span class="pln"> bogart</span><span class="pun">.</span><span class="pln">html</span><span class="pun">(</span><span class="str">'Hello World'</span><span class="pun">);</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /><br />bogart</span><span class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span class="pln">app</span><span class="pun">);</span></code></pre></div>

<p>This JavaScript program defines a single route that accepts <code>GET</code> requests to the root of the
site and returns a simple HTML greeting.</p>

<p>To run this program, first execute the following commands to setup your blog directory:</p>

<pre><code><span class="pln">mkdir bogart</span><span class="pun">-</span><span class="pln">couchdb</span><span class="pun">-</span><span class="pln">blog<br />cd bogart</span><span class="pun">-</span><span class="pln">couchdb</span><span class="pun">-</span><span class="pln">blog<br />npm install bogart<br /></span></code></pre>

<p>This will create a new directory named bogart-couchdb-blog and install bogart to the 
node_modules subdirectory of this directory. Next, copy the JavaScript into a file into
bogart-couchdb-blog and name it <code>hello-world.js</code> and then execute</p>

<pre><code><span class="pln">node hello</span><span class="pun">-</span><span class="pln">world</span><span class="pun">.</span><span class="pln">js<br /></span></code></pre>

<p>Visit <a href="index.html">http://localhost:8080</a> in your browser.</p>

<h2>Creating the package.json file</h2>

<p>In order to manage dependencies, it is useful to create a <code>package.json</code> file. This file
provides details on the packages you depend on so that you can more easily use <code>npm</code> to manage
these dependencies.</p>

<p>Create a file named <code>package.json</code> in your <code>bogart-couchdb-blog</code> directory.</p>

<div class="snippet"><a href="bogart-couchdb/package.json" class="code-link">package.json</a><pre><code><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">"name"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"blog"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">"description"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"Simple Blogging Engine"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">"version"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"0.1.0"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">"author"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"Nathan Stott"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">"email"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"nathan.stott@whiteboard-it.com"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">"main"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"./app"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">"directories"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="str">"lib"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"./lib"</span><span class="pln"> </span><span class="pun">},</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">"dependencies"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="str">"bogart"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"&gt;=0.2.0"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="str">"mustache"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"0.3.1-dev"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="str">"couchdb"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"&gt;=0.1.2"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="str">"promised-io"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"=0.2.3"</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br /></span><span class="pun">}</span></code></pre></div>

<p>The most important field in this JSON file is the <code>dependencies</code> field. This field will allow
you to execute <code>npm install</code> to install the dependencies for your project.</p>

<h2>Creating a Post</h2>

<p>There are two routes that we will need in order to create a post.</p>

<ul>
<li>GET /posts/new -> returns a form to create a new post</li>
<li>POST /posts -> creates a new post from the form parameters provided</li>
</ul>

<p>The mustache template to create a new post is as follows:</p>

<div class="snippet"><a href="bogart-couchdb/new-post.html" class="code-link">new-post.html</a><pre><code><span class="tag">&lt;form</span><span class="pln"> </span><span class="atn">method</span><span class="pun">=</span><span class="atv">'post'</span><span class="pln"> </span><span class="atn">action</span><span class="pun">=</span><span class="atv">'/posts'</span><span class="tag">&gt;</span><span class="pln"><br />&nbsp; </span><span class="tag">&lt;fieldset&gt;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="tag">&lt;legend&gt;</span><span class="pln">New Post</span><span class="tag">&lt;/legend&gt;</span><span class="pln"><br /><br />&nbsp; &nbsp; </span><span class="tag">&lt;div&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;label</span><span class="pln"> </span><span class="atn">for</span><span class="pun">=</span><span class="atv">'title'</span><span class="tag">&gt;</span><span class="pln">Title</span><span class="tag">&lt;/label&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;input</span><span class="pln"> </span><span class="atn">name</span><span class="pun">=</span><span class="atv">'title'</span><span class="pln"> </span><span class="tag">/&gt;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="tag">&lt;/div&gt;</span><span class="pln"><br /><br />&nbsp; &nbsp; </span><span class="tag">&lt;div&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;label</span><span class="pln"> </span><span class="atn">for</span><span class="pun">=</span><span class="atv">'body'</span><span class="tag">&gt;</span><span class="pln">Body</span><span class="tag">&lt;/label&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;textarea</span><span class="pln"> </span><span class="atn">name</span><span class="pun">=</span><span class="atv">'body'</span><span class="pln"> </span><span class="atn">rows</span><span class="pun">=</span><span class="atv">'15'</span><span class="pln"> </span><span class="atn">columns</span><span class="pun">=</span><span class="atv">'25'</span><span class="tag">&gt;&lt;/textarea&gt;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="tag">&lt;/div&gt;</span><span class="pln"><br /><br />&nbsp; &nbsp; </span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">'buttons'</span><span class="tag">&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;input</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">'submit'</span><span class="pln"> </span><span class="atn">value</span><span class="pun">=</span><span class="atv">'Save Post'</span><span class="pln"> </span><span class="tag">/&gt;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="tag">&lt;/div&gt;</span><span class="pln"><br />&nbsp; </span><span class="tag">&lt;/fieldset&gt;</span><span class="pln"><br /></span><span class="tag">&lt;/form&gt;</span></code></pre></div>

<p>This post will be rendered inside of a layout to keep the look of the site consistant.
By convention, Bogart's view engine uses a file called <code>layout.html</code> as the layout if
it exists. A Bogart layout is a template with a <code>{{{body}}}</code> tag to include the
view inside of the layout.</p>

<div class="snippet"><a href="bogart-couchdb/layout.html" class="code-link">layout.html</a><pre><code><span class="dec">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;</span><span class="pln"><br /><br /></span><span class="tag">&lt;html&gt;</span><span class="pln"><br /></span><span class="tag">&lt;head&gt;</span><span class="pln"><br />&nbsp; </span><span class="tag">&lt;title&gt;</span><span class="pln">{{title}}</span><span class="tag">&lt;/title&gt;</span><span class="pln"><br /></span><span class="tag">&lt;/head&gt;</span><span class="pln"><br /></span><span class="tag">&lt;body&gt;</span><span class="pln"><br />&nbsp; {{{body}}}<br /></span><span class="tag">&lt;/body&gt;</span><span class="pln"><br /></span><span class="tag">&lt;/html&gt;</span></code></pre></div>

<p>The route to return the new post template makes use of the <code>bogart.respond</code> helper. 
Even though it is not strictly necesarry to understand JSGI in order to use Bogart, 
lets go over the basic concept of a JSGI response. Bogart routes expect a JSGI response 
or a promise that will resolve to a JSGI response to be returned. A JSGI response is an 
object that contains three attributes: status (required), body (required), and headers (optional).</p>

<p>A simple JSGI response:</p>

<pre><code><span class="pun">{</span><span class="pln"><br />&nbsp; status</span><span class="pun">:</span><span class="pln"> </span><span class="lit">200</span><span class="pun">,</span><span class="pln"><br />&nbsp; body</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span><span class="pln"> </span><span class="str">'Hello World'</span><span class="pln"> </span><span class="pun">]</span><span class="pln"><br /></span><span class="pun">}</span><span class="pln"><br /></span></code></pre>

<p>The Bogart route to render new-post.html is as follows:</p>

<pre><code><span class="pln">router</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'/posts/new'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">req</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">return</span><span class="pln"> viewEngine</span><span class="pun">.</span><span class="pln">respond</span><span class="pun">(</span><span class="str">'new-post.html'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; locals</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; title</span><span class="pun">:</span><span class="pln"> </span><span class="str">'New Post'</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; </span><span class="pun">})</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /></span></code></pre>

<p><code>viewEngine</code> should be defined at the beginning of the Bogart configuartion closure as</p>

<pre><code><span class="pln">viewEngine </span><span class="pun">=</span><span class="pln"> bogart</span><span class="pun">.</span><span class="pln">viewEngine</span><span class="pun">(</span><span class="str">'mustache'</span><span class="pun">);</span><span class="pln"><br /></span></code></pre>

<p>Bogart supports <code>mustache</code> out of the box. There is a <code>jade</code> view engine in the package
bogart-jade. If you want to use <code>jade</code> then <code>npm install bogart-jade</code> and 
<code>require('bogart-jade')</code>. After that, <code>bogart.viewEngine('jade')</code> will work. It is easy to add
support for more view engines as well.</p>

<p>Bogart includes useful middleware to make working with forms easy. Normally, <code>req.body</code> will
contain the raw body of a form post. It is more conveniant if this is automatically converted to
a JSON object for us. The Bogart middleware <code>Parted</code> accomplishes this.</p>

<p>Adding middleware is easiest using a Bogart Application object.
JSGI <code>Parted</code> middleware wraps the streaming multipart, json, and urlencoded parsing utility
<a href="https://github.com/chjj/parted">Parted</a>.</p>

<pre><code><span class="kwd">var</span><span class="pln"> app </span><span class="pun">=</span><span class="pln"> bogart</span><span class="pun">.</span><span class="pln">app</span><span class="pun">();</span><span class="pln"><br />app</span><span class="pun">.</span><span class="kwd">use</span><span class="pun">(</span><span class="pln">bogart</span><span class="pun">.</span><span class="pln">middleware</span><span class="pun">.</span><span class="typ">Parted</span><span class="pun">);</span><span class="pln"><br />app</span><span class="pun">.</span><span class="kwd">use</span><span class="pun">(</span><span class="pln">router</span><span class="pun">);</span><span class="pln"><br />app</span><span class="pun">.</span><span class="pln">start</span><span class="pun">();</span><span class="pln"><br /></span></code></pre>

<p>Lets take a side-step to discuss how we can work with CouchDB using the <code>couchdb</code> package
from the npm registry.</p>

<p>At the top of our <code>app.js</code> add the following:</p>

<pre><code><span class="kwd">var</span><span class="pln"> couchdb </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'couchdb'</span><span class="pun">);</span><span class="pln"><br /></span></code></pre>

<p>In the closure that configures Bogart routes, create a couchdb client and a database representation.</p>

<pre><code><span class="kwd">var</span><span class="pln"> app </span><span class="pun">=</span><span class="pln"> bogart</span><span class="pun">.</span><span class="pln">router</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="kwd">get</span><span class="pun">,</span><span class="pln"> post</span><span class="pun">,</span><span class="pln"> put</span><span class="pun">,</span><span class="pln"> destroy</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br /><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> client &nbsp; &nbsp; </span><span class="pun">=</span><span class="pln"> couchdb</span><span class="pun">.</span><span class="pln">createClient</span><span class="pun">(</span><span class="lit">5984</span><span class="pun">,</span><span class="pln"> </span><span class="str">'127.0.0.1'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> user</span><span class="pun">:</span><span class="pln"> </span><span class="str">'myuser'</span><span class="pun">,</span><span class="pln"> password</span><span class="pun">:</span><span class="pln"> </span><span class="str">'mypass'</span><span class="pln"> </span><span class="pun">})</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">,</span><span class="pln"> db &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">=</span><span class="pln"> client</span><span class="pun">.</span><span class="pln">db</span><span class="pun">(</span><span class="str">'blog'</span><span class="pun">)</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">,</span><span class="pln"> viewEngine </span><span class="pun">=</span><span class="pln"> bogart</span><span class="pun">.</span><span class="pln">viewEngine</span><span class="pun">(</span><span class="str">'mustache'</span><span class="pun">);</span><span class="pln"><br /><br />&nbsp; </span><span class="com">// configure routes...</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /></span></code></pre>

<p>This creates a couchdb client connecting to '127.0.0.1' and port 5984. If your CouchDB is in
Admin Party, you do not need to supply the user and password in an options hash. If you have a 
CouchDB users setup, please provide your username and password.</p>

<p>Now we will create a route to handle the <code>POST</code> of our form.</p>

<pre><code><span class="pln">router</span><span class="pun">.</span><span class="pln">post</span><span class="pun">(</span><span class="str">'/posts'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">req</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> post </span><span class="pun">=</span><span class="pln"> req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">;</span><span class="pln"><br />&nbsp; post</span><span class="pun">.</span><span class="pln">type </span><span class="pun">=</span><span class="pln"> </span><span class="str">'post'</span><span class="pun">;</span><span class="pln"><br /><br />&nbsp; </span><span class="kwd">return</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">saveDoc</span><span class="pun">.</span><span class="kwd">then</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">resp</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> bogart</span><span class="pun">.</span><span class="pln">redirect</span><span class="pun">(</span><span class="str">'/posts'</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /></span></code></pre>

<p>We add the <code>type</code> attribute to the <code>post</code> so that as we add more document types in the future,
we can easily create CouchDB views to find only specific document types. This is not a built-in
CouchDB concept. It is a useful convention that makes creating views simpler.</p>

<h2>Adding a CouchDB view to retrieve posts</h2>

<p>CouchDB is queried using <a href="http://wiki.apache.org/couchdb/HTTP_view_API">map/reduce views</a> 
that are defined on design documents. This means that we need to create a design
document before we can query a list of the posts in our database.</p>

<p>Lets create a JavaScript file <code>syncDesignDoc.js</code> in the <code>lib</code> directory of our project.</p>

<div class="snippet"><a href="bogart-couchdb/syncDesignDoc.js" class="code-link">syncDesignDoc.js</a><pre><code><span class="kwd">var</span><span class="pln"> couchdb </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'couchdb'</span><span class="pun">)</span><span class="pln"><br />&nbsp; </span><span class="pun">,</span><span class="pln"> settings </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'../settings'</span><span class="pun">);</span><span class="pln"><br /><br /></span><span class="kwd">var</span><span class="pln"> client &nbsp;</span><span class="pun">=</span><span class="pln"> couchdb</span><span class="pun">.</span><span class="pln">createClient</span><span class="pun">(</span><span class="pln">settings</span><span class="pun">.</span><span class="pln">port</span><span class="pun">,</span><span class="pln"> settings</span><span class="pun">.</span><span class="pln">host</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> user</span><span class="pun">:</span><span class="pln"> settings</span><span class="pun">.</span><span class="pln">user</span><span class="pun">,</span><span class="pln"> password</span><span class="pun">:</span><span class="pln"> settings</span><span class="pun">.</span><span class="pln">password </span><span class="pun">});</span><span class="pln"><br /></span><span class="kwd">var</span><span class="pln"> db &nbsp; &nbsp; &nbsp;</span><span class="pun">=</span><span class="pln"> client</span><span class="pun">.</span><span class="pln">db</span><span class="pun">(</span><span class="pln">settings</span><span class="pun">.</span><span class="pln">db</span><span class="pun">);</span><span class="pln"><br /><br /></span><span class="kwd">var</span><span class="pln"> designDoc </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; _id</span><span class="pun">:</span><span class="pln"> </span><span class="str">'_design/blog'</span><span class="pun">,</span><span class="pln"><br /><br />&nbsp; language</span><span class="pun">:</span><span class="pln"> </span><span class="str">'javascript'</span><span class="pun">,</span><span class="pln"><br /><br />&nbsp; views</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">'posts_by_date'</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; map</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">doc</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">doc</span><span class="pun">.</span><span class="pln">type </span><span class="pun">===</span><span class="pln"> </span><span class="str">'post'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; emit</span><span class="pun">(</span><span class="pln">doc</span><span class="pun">.</span><span class="pln">postedAt</span><span class="pun">,</span><span class="pln"> doc</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">}.</span><span class="pln">toString</span><span class="pun">()</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; </span><span class="pun">}</span><span class="pln"><br /></span><span class="pun">};</span><span class="pln"><br /><br />db</span><span class="pun">.</span><span class="pln">saveDoc</span><span class="pun">(</span><span class="pln">designDoc</span><span class="pun">).</span><span class="kwd">then</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">resp</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">'updated design doc!'</span><span class="pun">);</span><span class="pln"><br /></span><span class="pun">},</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">'error updating design doc: '</span><span class="pun">+</span><span class="kwd">require</span><span class="pun">(</span><span class="str">'util'</span><span class="pun">).</span><span class="pln">inspect</span><span class="pun">(</span><span class="pln">err</span><span class="pun">));</span><span class="pln"><br /></span><span class="pun">});</span></code></pre></div>

<p>Execute <code>node lib/syncDesignDoc.js</code> to update the database with the latest design document.</p>

<h2>Listing Posts</h2>

<p>Lets create a Mustache template to list the posts from our database.</p>

<div class="snippet"><a href="bogart-couchdb/posts.html" class="code-link">posts.html</a><pre><code><span class="tag">&lt;h2&gt;</span><span class="pln">Posts</span><span class="tag">&lt;/h2&gt;</span><span class="pln"><br /><br /></span><span class="tag">&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">'/posts/new'</span><span class="tag">&gt;</span><span class="pln">New Post</span><span class="tag">&lt;/a&gt;</span><span class="pln"><br /><br /></span><span class="tag">&lt;ul&gt;</span><span class="pln"><br />&nbsp; {{#posts}}<br />&nbsp; &nbsp; </span><span class="tag">&lt;li&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">'post'</span><span class="tag">&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;h2&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">'/posts/{{_id}}'</span><span class="tag">&gt;</span><span class="pln">{{title}}</span><span class="tag">&lt;/a&gt;&lt;/h2&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;p&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {{body}}<br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;/p&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;/div&gt;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="tag">&lt;/li&gt;</span><span class="pln"><br />&nbsp; {{/posts}}<br /></span><span class="tag">&lt;/ul&gt;</span></code></pre></div>

<p>Next, lets create a Bogart route to render this template. We will query the database using
<code>db.view</code>, process the response from CouchDB, and respond with the rendered template. Bogart
makes this easy:</p>

<pre><code><span class="pln">&nbsp; router</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'/posts'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">req</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br /><br />&nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">view</span><span class="pun">(</span><span class="str">'blog'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'posts_by_date'</span><span class="pun">).</span><span class="kwd">then</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">resp</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> posts </span><span class="pun">=</span><span class="pln"> resp</span><span class="pun">.</span><span class="pln">rows</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">x</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> x</span><span class="pun">.</span><span class="pln">value</span><span class="pun">;</span><span class="pln"> </span><span class="pun">});</span><span class="pln"><br /><br />&nbsp; &nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> viewEngine</span><span class="pun">.</span><span class="pln">respond</span><span class="pun">(</span><span class="str">'posts.html'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; locals</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; posts</span><span class="pun">:</span><span class="pln"> posts<br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /></span></code></pre>

<h2>Show an Individaul Post</h2>

<p>It's time to create a route to show an individual post. This page will also contain
a form for adding comments.</p>

<p>The template will be as follows:</p>

<div class="snippet"><a href="bogart-couchdb/post.html" class="code-link">post.html</a><pre><code><span class="tag">&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">'/posts'</span><span class="tag">&gt;</span><span class="pln">Home</span><span class="tag">&lt;/a&gt;</span><span class="pln"><br /><br /></span><span class="tag">&lt;h1&gt;</span><span class="pln">{{title}}</span><span class="tag">&lt;/h1&gt;</span><span class="pln"><br /><br /></span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">'post-content'</span><span class="tag">&gt;</span><span class="pln"><br />&nbsp; {{body}}<br /></span><span class="tag">&lt;/div&gt;</span><span class="pln"><br /><br /></span><span class="tag">&lt;div&gt;</span><span class="pln"><br />&nbsp; </span><span class="tag">&lt;h2&gt;</span><span class="pln">Comments</span><span class="tag">&lt;/h2&gt;</span><span class="pln"><br />&nbsp; </span><span class="tag">&lt;ul</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">'comments'</span><span class="tag">&gt;</span><span class="pln"><br />&nbsp; &nbsp; {{#comments}}<br />&nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;li&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;div&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Author: </span><span class="tag">&lt;span</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">'author'</span><span class="tag">&gt;</span><span class="pln">{{author}}</span><span class="tag">&lt;/span&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;/div&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;div&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {{body}}<br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;/div&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;/li&gt;</span><span class="pln"><br />&nbsp; &nbsp; {{/comments}}<br /><br />&nbsp; &nbsp; {{^comments}}<br />&nbsp; &nbsp; &nbsp; No Comments Yet<br />&nbsp; &nbsp; {{/comments}}<br />&nbsp; </span><span class="tag">&lt;/ul&gt;</span><span class="pln"><br /></span><span class="tag">&lt;/div&gt;</span><span class="pln"><br /><br /></span><span class="tag">&lt;form</span><span class="pln"> </span><span class="atn">method</span><span class="pun">=</span><span class="atv">'post'</span><span class="pln"> </span><span class="atn">action</span><span class="pun">=</span><span class="atv">'/posts/{{_id}}/comments'</span><span class="tag">&gt;</span><span class="pln"><br />&nbsp; </span><span class="tag">&lt;fieldset&gt;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="tag">&lt;legend&gt;</span><span class="pln">Leave a Comment</span><span class="tag">&lt;/legend&gt;</span><span class="pln"><br /><br />&nbsp; &nbsp; </span><span class="tag">&lt;div&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;label</span><span class="pln"> </span><span class="atn">for</span><span class="pun">=</span><span class="atv">'author'</span><span class="tag">&gt;</span><span class="pln">Your Name</span><span class="tag">&lt;/label&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;input</span><span class="pln"> </span><span class="atn">name</span><span class="pun">=</span><span class="atv">'author'</span><span class="pln"> </span><span class="tag">/&gt;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="tag">&lt;/div&gt;</span><span class="pln"><br /><br />&nbsp; &nbsp; </span><span class="tag">&lt;div&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;label</span><span class="pln"> </span><span class="atn">for</span><span class="pun">=</span><span class="atv">'body'</span><span class="tag">&gt;</span><span class="pln">Your Comment</span><span class="tag">&lt;/label&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;input</span><span class="pln"> </span><span class="atn">name</span><span class="pun">=</span><span class="atv">'body'</span><span class="pln"> </span><span class="tag">/&gt;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="tag">&lt;/div&gt;</span><span class="pln"><br /><br />&nbsp; &nbsp; </span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">'buttons'</span><span class="tag">&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;input</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">'submit'</span><span class="pln"> </span><span class="atn">value</span><span class="pun">=</span><span class="atv">'Post Comment'</span><span class="pln"> </span><span class="tag">/&gt;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="tag">&lt;/div&gt;</span><span class="pln"><br />&nbsp; </span><span class="tag">&lt;/fieldset&gt;</span><span class="pln"><br /></span><span class="tag">&lt;/form&gt;</span></code></pre></div>

<p>The Bogart route to display this is as simple as the route to display the form
for creating new posts.</p>

<pre><code><span class="pln">router</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'/posts/:id'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">req</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">return</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">openDoc</span><span class="pun">(</span><span class="pln">req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">.</span><span class="pln">id</span><span class="pun">).</span><span class="kwd">then</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">post</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> viewEngine</span><span class="pun">.</span><span class="pln">respond</span><span class="pun">(</span><span class="str">'post.html'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> locals</span><span class="pun">:</span><span class="pln"> post </span><span class="pun">});</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /></span></code></pre>

<p>The route to accept the <code>POST</code> from the comments form is similar to the route to accept
a new blog post:</p>

<pre><code><span class="pln">router</span><span class="pun">.</span><span class="pln">post</span><span class="pun">(</span><span class="str">'/posts/:id/comments'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">req</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> comment </span><span class="pun">=</span><span class="pln"> req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">;</span><span class="pln"><br /><br />&nbsp; </span><span class="kwd">return</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">openDoc</span><span class="pun">(</span><span class="pln">req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">.</span><span class="pln">id</span><span class="pun">).</span><span class="kwd">then</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">post</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; post</span><span class="pun">.</span><span class="pln">comments </span><span class="pun">=</span><span class="pln"> post</span><span class="pun">.</span><span class="pln">comments </span><span class="pun">||</span><span class="pln"> </span><span class="pun">[];</span><span class="pln"><br />&nbsp; &nbsp; post</span><span class="pun">.</span><span class="pln">comments</span><span class="pun">.</span><span class="pln">push</span><span class="pun">(</span><span class="pln">comment</span><span class="pun">);</span><span class="pln"><br /><br />&nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">saveDoc</span><span class="pun">(</span><span class="pln">post</span><span class="pun">).</span><span class="kwd">then</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">resp</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> bogart</span><span class="pun">.</span><span class="pln">redirect</span><span class="pun">(</span><span class="str">'/posts/'</span><span class="pun">+</span><span class="pln">req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">.</span><span class="pln">id</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /></span></code></pre>

<h2>Summing it up</h2>

<p>As you can see, getting started with Bogart and CouchDB is simple. We are a long way from 
having a full-featured blog, but hopefully this will inspire some out there to try
working with Node.JS, Bogart, and CouchDB!</p>

<p>The full source code of the finished <code>app.js</code> is below:</p>

<div class="snippet"><a href="bogart-couchdb/app.js" class="code-link">app.js</a><pre><code><span class="kwd">var</span><span class="pln"> bogart &nbsp;</span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'bogart'</span><span class="pun">)</span><span class="pln"><br />&nbsp; </span><span class="pun">,</span><span class="pln"> couchdb </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'couchdb'</span><span class="pun">)</span><span class="pln"><br />&nbsp; </span><span class="pun">,</span><span class="pln"> settings </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'./settings'</span><span class="pun">);</span><span class="pln"><br /><br /></span><span class="kwd">var</span><span class="pln"> client &nbsp; &nbsp; </span><span class="pun">=</span><span class="pln"> couchdb</span><span class="pun">.</span><span class="pln">createClient</span><span class="pun">(</span><span class="pln">settings</span><span class="pun">.</span><span class="pln">port</span><span class="pun">,</span><span class="pln"> settings</span><span class="pun">.</span><span class="pln">host</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> user</span><span class="pun">:</span><span class="pln"> settings</span><span class="pun">.</span><span class="pln">user</span><span class="pun">,</span><span class="pln"> password</span><span class="pun">:</span><span class="pln"> settings</span><span class="pun">.</span><span class="pln">password </span><span class="pun">})</span><span class="pln"><br />&nbsp; </span><span class="pun">,</span><span class="pln"> db &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">=</span><span class="pln"> client</span><span class="pun">.</span><span class="pln">db</span><span class="pun">(</span><span class="pln">settings</span><span class="pun">.</span><span class="pln">db</span><span class="pun">)</span><span class="pln"><br />&nbsp; </span><span class="pun">,</span><span class="pln"> viewEngine </span><span class="pun">=</span><span class="pln"> bogart</span><span class="pun">.</span><span class="pln">viewEngine</span><span class="pun">(</span><span class="str">'mustache'</span><span class="pun">)</span><span class="pln"><br />&nbsp; </span><span class="pun">,</span><span class="pln"> router &nbsp; &nbsp; </span><span class="pun">=</span><span class="pln"> bogart</span><span class="pun">.</span><span class="pln">router</span><span class="pun">();</span><span class="pln"><br /><br />router</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">req</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">return</span><span class="pln"> bogart</span><span class="pun">.</span><span class="pln">redirect</span><span class="pun">(</span><span class="str">'/posts'</span><span class="pun">);</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /><br />router</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'/posts'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">req</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br /><br />&nbsp; </span><span class="kwd">return</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">view</span><span class="pun">(</span><span class="str">'blog'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'posts_by_date'</span><span class="pun">).</span><span class="kwd">then</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">resp</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> posts </span><span class="pun">=</span><span class="pln"> resp</span><span class="pun">.</span><span class="pln">rows</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">x</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> x</span><span class="pun">.</span><span class="pln">value</span><span class="pun">;</span><span class="pln"> </span><span class="pun">});</span><span class="pln"><br /><br />&nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> viewEngine</span><span class="pun">.</span><span class="pln">respond</span><span class="pun">(</span><span class="str">'posts.html'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; locals</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; posts</span><span class="pun">:</span><span class="pln"> posts</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; title</span><span class="pun">:</span><span class="pln"> </span><span class="str">'Blog Home'</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; </span><span class="pun">},</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">err</span><span class="pun">.</span><span class="pln">error </span><span class="pun">&amp;&amp;</span><span class="pln"> err</span><span class="pun">.</span><span class="pln">error </span><span class="pun">===</span><span class="pln"> </span><span class="str">'not_found'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> bogart</span><span class="pun">.</span><span class="pln">error</span><span class="pun">(</span><span class="str">'execute syncDesignDoc before trying to use the blog'</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">throw</span><span class="pln"> err</span><span class="pun">;</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /><br />router</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'/posts/new'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">req</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">return</span><span class="pln"> viewEngine</span><span class="pun">.</span><span class="pln">respond</span><span class="pun">(</span><span class="str">'new-post.html'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; locals</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; title</span><span class="pun">:</span><span class="pln"> </span><span class="str">'New Post'</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /><br />router</span><span class="pun">.</span><span class="pln">post</span><span class="pun">(</span><span class="str">'/posts'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">req</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> post </span><span class="pun">=</span><span class="pln"> req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">;</span><span class="pln"><br />&nbsp; post</span><span class="pun">.</span><span class="pln">type </span><span class="pun">=</span><span class="pln"> </span><span class="str">'post'</span><span class="pun">;</span><span class="pln"><br />&nbsp; post</span><span class="pun">.</span><span class="pln">postedAt </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Date</span><span class="pun">();</span><span class="pln"><br /><br />&nbsp; </span><span class="kwd">return</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">saveDoc</span><span class="pun">(</span><span class="pln">post</span><span class="pun">).</span><span class="kwd">then</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">resp</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> bogart</span><span class="pun">.</span><span class="pln">redirect</span><span class="pun">(</span><span class="str">'/posts'</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /><br />router</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'/posts/:id'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">req</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">return</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">openDoc</span><span class="pun">(</span><span class="pln">req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">.</span><span class="pln">id</span><span class="pun">).</span><span class="kwd">then</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">post</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> viewEngine</span><span class="pun">.</span><span class="pln">respond</span><span class="pun">(</span><span class="str">'post.html'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> locals</span><span class="pun">:</span><span class="pln"> post </span><span class="pun">});</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /><br />router</span><span class="pun">.</span><span class="pln">post</span><span class="pun">(</span><span class="str">'/posts/:id/comments'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">req</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> comment </span><span class="pun">=</span><span class="pln"> req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">;</span><span class="pln"><br /><br />&nbsp; </span><span class="kwd">return</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">openDoc</span><span class="pun">(</span><span class="pln">req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">.</span><span class="pln">id</span><span class="pun">).</span><span class="kwd">then</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">post</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; post</span><span class="pun">.</span><span class="pln">comments </span><span class="pun">=</span><span class="pln"> post</span><span class="pun">.</span><span class="pln">comments </span><span class="pun">||</span><span class="pln"> </span><span class="pun">[];</span><span class="pln"><br />&nbsp; &nbsp; post</span><span class="pun">.</span><span class="pln">comments</span><span class="pun">.</span><span class="pln">push</span><span class="pun">(</span><span class="pln">comment</span><span class="pun">);</span><span class="pln"><br /><br />&nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">saveDoc</span><span class="pun">(</span><span class="pln">post</span><span class="pun">).</span><span class="kwd">then</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">resp</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> bogart</span><span class="pun">.</span><span class="pln">redirect</span><span class="pun">(</span><span class="str">'/posts/'</span><span class="pun">+</span><span class="pln">req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">.</span><span class="pln">id</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /><br /></span><span class="kwd">var</span><span class="pln"> app </span><span class="pun">=</span><span class="pln"> bogart</span><span class="pun">.</span><span class="pln">app</span><span class="pun">();</span><span class="pln"><br /><br /></span><span class="com">// Include batteries, a default JSGI stack.</span><span class="pln"><br />app</span><span class="pun">.</span><span class="kwd">use</span><span class="pun">(</span><span class="pln">bogart</span><span class="pun">.</span><span class="pln">batteries</span><span class="pun">);</span><span class="pln"><br /><br /></span><span class="com">// Include our router, it is significant that this is included after batteries.</span><span class="pln"><br />app</span><span class="pun">.</span><span class="kwd">use</span><span class="pun">(</span><span class="pln">router</span><span class="pun">);</span><span class="pln"><br /><br />app</span><span class="pun">.</span><span class="pln">start</span><span class="pun">();</span></code></pre></div><hr style="clear:both" /><div class="body" id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
var disqus_url = "http://howtonode.org/bogart-couchdb";
//]]>
</script>
<script src="http://disqus.com/forums/howtonodeorg/embed.js" type="text/javascript"></script><a href="http://disqus.com/forums/howtonodeorg/?url=ref" class="view-thread">View the discussion thread.</a><a href="http://disqus.com/" class="dsq-brlink">blog comments powered by<span class="logo-disqus">Disqus</span></a>
<script type="text/javascript">
//<![CDATA[
(function() {
  var links = document.getElementsByTagName('a');
  var query = '?';
  for(var i = 0; i < links.length; i++) {
    if(links[i].href.indexOf('#disqus_thread') >= 0) {
      query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&amp;';
    }
  }
  document.write('<script charset="utf-8" type="text/javascript" src="//disqus.com/forums/howtonodeorg/get_num_replies.js' + query + '"></' + 'script>');
})();


//]]>
</script>
</div></div><div id="sidebar"><div class="aside author"><h4>About the Author</h4><img src="https://www.gravatar.com/avatar/67b36dc8be45af469b4538f86bee144f?r=pg&amp;s=200.jpg&amp;d=identicon" class="headshot" /><dl><dt>Name:</dt><dd>Nathan Stott</dd></dl><dl><dt>Github:</dt><dd><a href="https://github.com/nrstott">nrstott</a></dd></dl><dl><dt>Twitter:</dt><dd><a href="https://twitter.com/nathan_stott">nathan_stott</a></dd></dl><dl><dt>Location:</dt><dd>Birmingham, AL</dd></dl><dl><dt>Links:</dt><dd><a href="http://whiteboard-it.com/">Homepage</a></dd></dl></div><div class="aside"><h4>About this Article</h4><a href="http://twitter.com/share" data-count="horizontal" data-via="creationix" class="twitter-share-button">Tweet</a><script src="http://platform.twitter.com/widgets.js"></script><dl title="Mon Sep 19 2011 08:53:58 GMT-0700 (PDT)"><dt>Date Released:</dt><dd>Monday, September 19, 2011</dd></dl><dl><dt>Node Version:</dt><dd><a href="http://github.com/joyent/node/tree/v0.4.12">node v0.4.12</a></dd></dl><dl><dt>Code Samples:</dt><dd><ul><li><a href="bogart-couchdb/hello-world.js">hello-world.js</a></li><li><a href="bogart-couchdb/package.json">package.json</a></li><li><a href="bogart-couchdb/new-post.html">new-post.html</a></li><li><a href="bogart-couchdb/layout.html">layout.html</a></li><li><a href="bogart-couchdb/syncDesignDoc.js">syncDesignDoc.js</a></li><li><a href="bogart-couchdb/posts.html">posts.html</a></li><li><a href="bogart-couchdb/post.html">post.html</a></li><li><a href="bogart-couchdb/app.js">app.js</a></li></ul></dd></dl><dl><dt>Revisions:</dt><dd><ul></ul></dd></dl></div><div class="bubble"><h3>About HowToNode.org</h3>

<p>HowToNode.org is a community supported blog created by <a href="http://creationix.com/">Tim Caswell</a>. The purpose of the blog is to teach how to do various tasks in <a href="http://nodejs.org/">node.js</a> as well as teach fundamental concepts that are needed to write effective code.</p>

<p>This site is powered by <a href="http://github.com/creationix/wheat">Wheat</a>, a git based blogging engine written in <a href="http://nodejs.org/">node.JS</a>.</p>

<p>The content for this site is stored in a <a href="http://github.com/creationix/howtonode.org">git repository</a> that anyone can fork, write an article, and send a pull request. If your article passes the quality standards it will be published and help support the greater node community.</p></div></div><div id="footer"><p>&copy; 2011-2014 Tim Caswell under the MIT license.</p><p>Content and articles are copyrighted to the individual authors. Design by&nbsp;<a href="https://bengourley.co.uk/">Ben Gourley</a>. All code snippets used in the examples are in the public domain.</p><p>Wheat v2 running on node.js v16.4.2</p></div></div>
<script type="text/javascript">
//<![CDATA[
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
//]]>
</script>

<script type="text/javascript">
//<![CDATA[
try {
var pageTracker = _gat._getTracker("UA-12824411-1");
pageTracker._trackPageview();
} catch(err) {}
//]]>
</script>
</body>
<!-- Mirrored from localhost:8080/bogart-couchdb by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 13 Jul 2021 13:57:15 GMT -->
</html>