<!DOCTYPE html>
<html lang="en">
<!-- Mirrored from localhost:8080/deploying-node-with-spark by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 13 Jul 2021 13:58:48 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset="utf-8" /><title>Deploying Node Apps with Spark - How To Node - NodeJS</title><meta name="description" content="Learn the zen of coding in NodeJS." /><meta name="viewport" content="width=device-width" /><link href="style.css" rel="stylesheet" /><link href="print.css" rel="stylesheet" media="print" /><link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="feed.xml" /><link href="favicon.ico" rel="icon" type="image/x-icon" /></head><body><div id="container"><div id="header"><a href="index.html"><img src="logo.png" alt="How to Node" class="logo" /><div class="tagline">The zen of coding in node.js</div></a></div><div id="main"><div class="article"><h1><a href="deploying-node-with-spark.html">Deploying Node Apps with Spark</a></h1><p class="old-node-warning">HEADS UP! This article was written for an older version of node.&nbsp;More up-to-date information may be available elsewhere.</p><p>This article will go through building a simple RESTful key/value store using <a href="http://senchalabs.github.com/connect/">Connect</a>.  Then I'll explain my favorite way to host apps on <a href="http://www.ubuntu.com/server">Ubuntu Server</a>.  This will use <a href="http://upstart.ubuntu.com/getting-started.html">upstart</a> and <a href="http://github.com/senchalabs/spark">Spark</a>.  We'll setup the <a href="http://nodejs.org/">node.js</a> environment using the super easy <a href="http://github.com/creationix/ivy">Ivy</a> distribution.</p>

<h2>Quick Node Install using the Ivy Distribution</h2>

<p>Ivy is a my simple node distribution.  It contains pre-built node binaries and several node modules bundled with it.</p>

<h3>On the Server</h3>

<p>Assuming you have a fresh host with Ubuntu Server 32bit, we'll get a node environment up and running in a matter of minutes.  Just install git and run the Ivy installer in your home directory.</p>

<pre><code><span class="pln">sudo apt</span><span class="pun">-</span><span class="kwd">get</span><span class="pln"> install git</span><span class="pun">-</span><span class="pln">core<br />wget </span><span class="pun">-</span><span class="pln">O</span><span class="pun">-</span><span class="pln"> http</span><span class="pun">:</span><span class="com">//github.com/creationix/ivy/raw/master/utils/setup.sh | sh</span><span class="pln"><br /></span></code></pre>

<p>Now for this to work correctly Ivy's <code>bin</code> folder needs to be in your <code>$PATH</code>.  Add a line to your <code>.profile</code> file to make it automatic on login.</p>

<pre><code><span class="pln">PATH</span><span class="pun">=</span><span class="pln">$HOME</span><span class="pun">/</span><span class="pln">ivy</span><span class="pun">/</span><span class="pln">bin</span><span class="pun">:</span><span class="pln">$PATH<br /></span></code></pre>

<p>Then source your <code>.profile</code> file to get the new settings.</p>

<pre><code><span class="pun">.</span><span class="pln"> </span><span class="pun">.</span><span class="pln">profile<br /></span></code></pre>

<p>Test it by launching node and inspecting the <code>require.paths</code>.  Make sure ivy's lib folder is in there.:</p>

<pre><code><span class="pln">tim@TimBook</span><span class="pun">:~</span><span class="pln">$ node<br /></span><span class="typ">Type</span><span class="pln"> </span><span class="str">'.help'</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> options</span><span class="pun">.</span><span class="pln"><br />node</span><span class="pun">&gt;</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">.</span><span class="pln">paths<br /></span><span class="pun">[</span><span class="pln"> </span><span class="str">'/Users/tim/.node_libraries'</span><span class="pln"><br /></span><span class="pun">,</span><span class="pln"> </span><span class="str">'/Users/tim/ivy/lib/node'</span><span class="pln"><br /></span><span class="pun">]</span><span class="pln"><br />node</span><span class="pun">&gt;</span><span class="pln"><br /></span></code></pre>

<h3>On your Development Machine</h3>

<p>For developing I like to write apps on my laptop and then push them to my server using git.  The steps are the same here with the exception that OSX has <code>curl</code> instead of <code>wget</code>.</p>

<pre><code><span class="pln">curl </span><span class="pun">-</span><span class="com"># http://github.com/creationix/ivy/raw/master/utils/setup.sh | sh</span><span class="pln"><br /></span></code></pre>

<h2>Writing an Application</h2>

<p>Ok, now to get some real work done.  In this tutorial we'll make a simple RESTful key/value store.</p>

<p>First create a basic app structure like this.</p>

<pre><code><span class="pln">memory_bank</span><span class="pun">/</span><span class="pln"><br /></span><span class="pun">|--</span><span class="pln"> app</span><span class="pun">.</span><span class="pln">js<br /></span><span class="pun">|--</span><span class="pln"> memory_bank</span><span class="pun">.</span><span class="pln">js<br /></span><span class="str">`-- public/<br />&nbsp; &nbsp; `</span><span class="pun">--</span><span class="pln"> index</span><span class="pun">.</span><span class="pln">html<br /></span></code></pre>

<h3>Stack it up with Connect</h3>

<p>Connect makes it easy to build fully features HTTP servers complete with logging, gzipping, smart caching, and all the other goodies that Connect provides out of the box.</p>

<div class="snippet"><a href="deploying-node-with-spark/app.js" class="code-link">app.js</a><pre><code><span class="com">// Define a simple connect app stack using the new createApp helper</span><span class="pln"><br /></span><span class="kwd">module</span><span class="pun">.</span><span class="pln">exports </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'connect'</span><span class="pun">).</span><span class="pln">createApp</span><span class="pun">(</span><span class="kwd">require</span><span class="pun">(</span><span class="str">'./memory_bank'</span><span class="pun">));</span></code></pre></div>

<p>That's it, one line!</p>

<h3>RESTful Interface</h3>

<p>Now lets build the <code>memory_bank.js</code> file mentioned in the Connect setup.</p>

<p>This app will provide the following RESTful interface.</p>

<pre><code><span class="pln">GET </span><span class="pun">/:</span><span class="pln">key </span><span class="pun">-</span><span class="pln"> </span><span class="typ">Retrieve</span><span class="pln"> a value based on key</span><span class="pun">.</span><span class="pln"><br />PUT </span><span class="pun">/:</span><span class="pln">key </span><span class="pun">-</span><span class="pln"> </span><span class="typ">Update</span><span class="pln"> </span><span class="kwd">or</span><span class="pln"> insert a value based on key</span><span class="pun">.</span><span class="pln"><br />DELETE </span><span class="pun">/:</span><span class="pln">key </span><span class="pun">-</span><span class="pln"> </span><span class="typ">Remove</span><span class="pln"> a value </span><span class="kwd">by</span><span class="pln"> key<br /></span></code></pre>

<p>Here we'll write these three request handlers. Since we set the <code>Last-Modified</code> header, we'll even get 304 response support through the Connect stack.</p>

<div class="snippet"><a href="deploying-node-with-spark/memory_bank.js" class="code-link">memory_bank.js<span class="hash">#routes</span></a><pre><code><span class="kwd">module</span><span class="pun">.</span><span class="pln">exports </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">app</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br /><br />&nbsp; </span><span class="com">// Read a value from the database</span><span class="pln"><br />&nbsp; app</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">"/:key"</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">req</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// Load from the database</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> item </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">[</span><span class="pln">req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">.</span><span class="pln">key</span><span class="pun">];</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// 404 if it doesn't exist</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">item</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">();</span><span class="pln"> </span><span class="kwd">return</span><span class="pun">;</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// Serve the item to the client</span><span class="pln"><br />&nbsp; &nbsp; sendItem</span><span class="pun">(</span><span class="pln">res</span><span class="pun">,</span><span class="pln"> item</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /><br />&nbsp; </span><span class="com">// Save a value to the database</span><span class="pln"><br />&nbsp; app</span><span class="pun">.</span><span class="pln">put</span><span class="pun">(</span><span class="str">"/:key"</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">req</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// Create/insert the item in the database</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> item </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">[</span><span class="pln">req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">.</span><span class="pln">key</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; value</span><span class="pun">:</span><span class="pln"> req</span><span class="pun">.</span><span class="pln">body</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; mtime</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Date</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">};</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// Serve the item to the client</span><span class="pln"><br />&nbsp; &nbsp; sendItem</span><span class="pun">(</span><span class="pln">res</span><span class="pun">,</span><span class="pln"> item</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /><br />&nbsp; </span><span class="com">// Remove a value from the database</span><span class="pln"><br />&nbsp; app</span><span class="pun">.</span><span class="kwd">del</span><span class="pun">(</span><span class="str">"/:key"</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">req</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> key </span><span class="pun">=</span><span class="pln"> req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">.</span><span class="pln">key</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// Load from the database</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> item </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">[</span><span class="pln">key</span><span class="pun">];</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// 404 if it doesn't exist</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">item</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">();</span><span class="pln"> </span><span class="kwd">return</span><span class="pun">;</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// Delete it</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">delete</span><span class="pln"> data</span><span class="pun">[</span><span class="pln">key</span><span class="pun">];</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// Send an empty OK response</span><span class="pln"><br />&nbsp; &nbsp; res</span><span class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span class="lit">204</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{});</span><span class="pln"><br />&nbsp; &nbsp; res</span><span class="pun">.</span><span class="kwd">end</span><span class="pun">();</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /><br /></span><span class="pun">};</span></code></pre></div>

<p>See the actual file for the definition of <code>data</code> and <code>sendItem</code>.</p>

<h3>Web Interface</h3>

<p>Connect will serve the static files in the <code>public</code> for you.  There is no need for Apache or Nginx.  Even if you use those for deployment, this makes development easy.</p>

<h2>Launching the App with Spark</h2>

<p>To test the server on your laptop, simply <code>cd</code> into the directory with <code>app.js</code> and type <code>spark</code>.  Type <code>spark -h</code> for options.</p>

<pre><code><span class="pln">tim@TimBook</span><span class="pun">:~/</span><span class="pln">memory_bank$ spark<br /></span><span class="typ">Spark</span><span class="pln"> server</span><span class="pun">(</span><span class="lit">42611</span><span class="pun">)</span><span class="pln"> listening on http</span><span class="pun">:</span><span class="com">//*:3000 in development mode</span><span class="pln"><br /></span></code></pre>

<h3>Deployment</h3>

<p>To deploy this, copy it to your linux server.  My favorite way is to push the code to github, and then clone it on the server.  This way you have backup of the code and two-way synchronization.</p>

<h4>Add a Connect Config File</h4>

<p>I like to specify a config file instead of using command-line args in the <code>spark</code> command. Create a <code>config.js</code> file like this:</p>

<div class="snippet"><a href="deploying-node-with-spark/config.js" class="code-link">config.js</a><pre><code><span class="kwd">module</span><span class="pun">.</span><span class="pln">exports </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; port</span><span class="pun">:</span><span class="pln"> </span><span class="lit">80</span><span class="pun">,</span><span class="pln"><br />&nbsp; user</span><span class="pun">:</span><span class="pln"> </span><span class="str">"nobody"</span><span class="pun">,</span><span class="pln"><br />&nbsp; env</span><span class="pun">:</span><span class="pln"> </span><span class="str">"production"</span><span class="pln"><br /></span><span class="pun">};</span></code></pre></div>

<p>You don't want this config file on your development environment.  The easiest way is to create a <code>.gitignore</code> file and remove <code>config.js</code> from version control.</p>

<h4>Add an Upstart Config File</h4>

<p>Then go to <code>/etc/init</code> and create an upstart config file.  In this file you want to set up the environment for spark to run and tell it to start your server using spark.</p>

<div class="snippet"><a href="deploying-node-with-spark/memory_bank.conf" class="code-link">memory_bank.conf</a><pre><code><span class="pln">description </span><span class="str">"Memory Bank server for RESTful key/value storage"</span><span class="pln"><br />version </span><span class="str">"1.0"</span><span class="pln"><br />author </span><span class="str">"Tim Caswell"</span><span class="pln"><br /><br /></span><span class="com"># Upstart has nothing in $PATH by default</span><span class="pln"><br />env PATH</span><span class="pun">=</span><span class="str">/home/</span><span class="pln">tim</span><span class="pun">/</span><span class="pln">ivy</span><span class="pun">/</span><span class="pln">bin</span><span class="pun">:</span><span class="str">/usr/</span><span class="kwd">local</span><span class="pun">/</span><span class="pln">sbin</span><span class="pun">:</span><span class="str">/usr/</span><span class="kwd">local</span><span class="pun">/</span><span class="pln">bin</span><span class="pun">:</span><span class="str">/usr/</span><span class="pln">sbin</span><span class="pun">:</span><span class="str">/usr/</span><span class="pln">bin</span><span class="pun">:</span><span class="str">/sbin:/</span><span class="pln">bin<br /><br /></span><span class="com"># Keep the server running on crash or machine reboot</span><span class="pln"><br />respawn<br />start on runlevel </span><span class="pun">[</span><span class="lit">23</span><span class="pun">]</span><span class="pln"><br /><br /></span><span class="com"># Start the server using spark and redirect output to log files</span><span class="pln"><br />script<br />&nbsp; cd </span><span class="pun">/</span><span class="pln">home</span><span class="pun">/</span><span class="pln">tim</span><span class="pun">/</span><span class="pln">memory_bank<br />&nbsp; </span><span class="kwd">exec</span><span class="pln"> spark </span><span class="pun">--</span><span class="pln">comment memory_bank </span><span class="pun">&gt;</span><span class="pln"> access</span><span class="pun">.</span><span class="pln">log </span><span class="lit">2</span><span class="pun">&gt;</span><span class="pln"> error</span><span class="pun">.</span><span class="pln">log<br /></span><span class="kwd">end</span><span class="pln"> script</span></code></pre></div>

<p>Save this file at <code>/etc/init/memory_bank.conf</code> and set it as executable.  Now you can start your node server using upstart commands.</p>

<pre><code><span class="pln">sudo start memory_bank<br /></span></code></pre>

<p>If all went well you should see a message stating it started successfully and give you the pid.  Now hit your server on the port you specified and see your app.</p>

<p><em>NOTE</em> - If you didn't design a front-end in <code>/public</code> you'll just see the blank index.html page.</p>

<h2>Conclusion</h2>

<p>Ivy, Spark, and Connect are a powerful combination that has worked great for me.  They are also useful on their own.</p>

<p>If you want to use Spark for a raw tcp server, go ahead, Spark works for <em>any</em> <code>net.Server</code> or <code>http.Server</code> instance as long as it's exported as <code>app.js</code>.  Connect even allows for embedding an <code>http.Server</code> instance as a last middleware layer.</p>

<p>I've set up a few sites this way on more than one server and I find it very useful.  I hope this article fits your use case as well, or at least gets you in the right direction.</p><hr style="clear:both" /><div class="body" id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
var disqus_url = "http://howtonode.org/deploying-node-with-spark";
//]]>
</script>
<script src="http://disqus.com/forums/howtonodeorg/embed.js" type="text/javascript"></script><a href="http://disqus.com/forums/howtonodeorg/?url=ref" class="view-thread">View the discussion thread.</a><a href="http://disqus.com/" class="dsq-brlink">blog comments powered by<span class="logo-disqus">Disqus</span></a>
<script type="text/javascript">
//<![CDATA[
(function() {
  var links = document.getElementsByTagName('a');
  var query = '?';
  for(var i = 0; i < links.length; i++) {
    if(links[i].href.indexOf('#disqus_thread') >= 0) {
      query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&amp;';
    }
  }
  document.write('<script charset="utf-8" type="text/javascript" src="//disqus.com/forums/howtonodeorg/get_num_replies.js' + query + '"></' + 'script>');
})();


//]]>
</script>
</div></div><div id="sidebar"><div class="aside author"><h4>About the Author</h4><img src="https://www.gravatar.com/avatar/c953ddd239707998340e1a6fbb3eeb46?r=pg&amp;s=200.jpg&amp;d=identicon" class="headshot" /><dl><dt>Name:</dt><dd>Tim Caswell</dd></dl><dl><dt>Github:</dt><dd><a href="https://github.com/creationix">creationix</a></dd></dl><dl><dt>Twitter:</dt><dd><a href="https://twitter.com/creationix">creationix</a></dd></dl><dl><dt>Location:</dt><dd>Red Lick, TX</dd></dl><dl><dt>Links:</dt><dd><a href="http://creationix.com/">Homepage</a></dd></dl></div><div class="aside"><h4>About this Article</h4><a href="http://twitter.com/share" data-count="horizontal" data-via="creationix" class="twitter-share-button">Tweet</a><script src="http://platform.twitter.com/widgets.js"></script><dl title="Thu, 22 Jul 2010 20:44:44 GMT"><dt>Date Released:</dt><dd>Thursday, July 22, 2010</dd></dl><dl><dt>Node Version:</dt><dd><a href="http://github.com/joyent/node/tree/v0.1.102">node v0.1.102</a></dd></dl><dl><dt>Code Samples:</dt><dd><ul><li><a href="deploying-node-with-spark/app.js">app.js</a></li><li><a href="deploying-node-with-spark/memory_bank.js">memory_bank.js</a></li><li><a href="deploying-node-with-spark/config.js">config.js</a></li><li><a href="deploying-node-with-spark/memory_bank.conf">memory_bank.conf</a></li></ul></dd></dl><dl><dt>Revisions:</dt><dd><ul></ul></dd></dl></div><div class="bubble"><h3>About HowToNode.org</h3>

<p>HowToNode.org is a community supported blog created by <a href="http://creationix.com/">Tim Caswell</a>. The purpose of the blog is to teach how to do various tasks in <a href="http://nodejs.org/">node.js</a> as well as teach fundamental concepts that are needed to write effective code.</p>

<p>This site is powered by <a href="http://github.com/creationix/wheat">Wheat</a>, a git based blogging engine written in <a href="http://nodejs.org/">node.JS</a>.</p>

<p>The content for this site is stored in a <a href="http://github.com/creationix/howtonode.org">git repository</a> that anyone can fork, write an article, and send a pull request. If your article passes the quality standards it will be published and help support the greater node community.</p></div></div><div id="footer"><p>&copy; 2011-2014 Tim Caswell under the MIT license.</p><p>Content and articles are copyrighted to the individual authors. Design by&nbsp;<a href="https://bengourley.co.uk/">Ben Gourley</a>. All code snippets used in the examples are in the public domain.</p><p>Wheat v2 running on node.js v16.4.2</p></div></div>
<script type="text/javascript">
//<![CDATA[
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
//]]>
</script>

<script type="text/javascript">
//<![CDATA[
try {
var pageTracker = _gat._getTracker("UA-12824411-1");
pageTracker._trackPageview();
} catch(err) {}
//]]>
</script>
</body>
<!-- Mirrored from localhost:8080/deploying-node-with-spark by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 13 Jul 2021 13:58:52 GMT -->
</html>