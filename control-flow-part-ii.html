<!DOCTYPE html>
<html lang="en">
<!-- Mirrored from localhost:8080/control-flow-part-ii by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 13 Jul 2021 14:00:19 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset="utf-8" /><title>Control Flow in Node Part II - How To Node - NodeJS</title><meta name="description" content="Learn the zen of coding in NodeJS." /><meta name="viewport" content="width=device-width" /><link href="style.css" rel="stylesheet" /><link href="print.css" rel="stylesheet" media="print" /><link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="feed.xml" /><link href="favicon.ico" rel="icon" type="image/x-icon" /></head><body><div id="container"><div id="header"><a href="index.html"><img src="logo.png" alt="How to Node" class="logo" /><div class="tagline">The zen of coding in node.js</div></a></div><div id="main"><div class="article"><h1><a href="control-flow-part-ii.html">Control Flow in Node Part II</a></h1><p class="old-node-warning">HEADS UP! This article was written for an older version of node.&nbsp;More up-to-date information may be available elsewhere.</p><p>I had so much fun writing the last article on control flow, that I decided to play around with the feedback I received.  One thing in particular I want to talk about is the good work <a href="http://inimino.org/~inimino/blog/fileio_first_release">inimino</a> is doing.</p>

<p>Node has two constructs that are used currently to handle async return values, namely callbacks and event emitters.  You can read all about those on the <a href="http://nodejs.org/">nodejs.org</a> website.  I'm going to talk about these and another way to manage asynchronous return values and streaming events.</p>

<p><strong>UPDATE</strong> Promises were removed from node a while back, this article has been updated to show callbacks instead of promises.  For promises see <a href="http://github.com/kriszyp/node-promise">node-promise</a>.</p>

<h2>Why the distinction between Callback and EventEmitter?</h2>

<p>In node there are two event handling techniques.  They are called callbacks, and EventEmitter.  Callbacks are for the async equivalent of a function.</p>

<div class="snippet"><a href="control-flow-part-ii/callback.js" class="code-link">callback.js</a><pre><code><span class="kwd">var</span><span class="pln"> fs </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'fs'</span><span class="pun">);</span><span class="pln"><br /><br />fs</span><span class="pun">.</span><span class="pln">readFile</span><span class="pun">(</span><span class="str">'mydata.txt'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> buffer</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// Handle error</span><span class="pln"><br />&nbsp; &nbsp; console</span><span class="pun">.</span><span class="pln">error</span><span class="pun">(</span><span class="pln">err</span><span class="pun">.</span><span class="pln">stack</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">return</span><span class="pun">;</span><span class="pln"><br />&nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; </span><span class="com">// Do something</span><span class="pln"><br />&nbsp; console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">);</span><span class="pln"><br /></span><span class="pun">});</span></code></pre></div>

<p><code>fs.readFile()</code> takes a filename and "<em>returns</em>" the contents of the file.  It doesn't actually return it, but passes it to the passed in callback function.</p>

<p>Sometimes you want to listen for events that can happen several times.  For example in a web server, when processing a web request, the <code>data</code> event is fired one or more times and then the <code>end</code> event gets fired:</p>

<div class="snippet"><a href="control-flow-part-ii/http-body.js" class="code-link">http-body.js</a><pre><code><span class="kwd">var</span><span class="pln"> http </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'http'</span><span class="pun">);</span><span class="pln"><br /><br />http</span><span class="pun">.</span><span class="pln">createServer</span><span class="pun">(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">req</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> chunks </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[];</span><span class="pln"><br />&nbsp; req</span><span class="pun">.</span><span class="pln">addListener</span><span class="pun">(</span><span class="str">'data'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">chunk</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; chunks</span><span class="pun">.</span><span class="pln">push</span><span class="pun">(</span><span class="pln">chunk</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; req</span><span class="pun">.</span><span class="pln">addListener</span><span class="pun">(</span><span class="str">'end'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// Do something with body text</span><span class="pln"><br />&nbsp; &nbsp; console</span><span class="pun">.</span><span class="pln">dir</span><span class="pun">(</span><span class="pln">chunks</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /></span><span class="pun">}).</span><span class="pln">listen</span><span class="pun">(</span><span class="lit">8080</span><span class="pun">);</span><span class="pln"><br /><br />console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Server started on http://localhost:8080/"</span><span class="pun">);</span></code></pre></div>

<p>The difference is that with a callback you're either going to get an error or a result.  Never both, and never more than one event.  For cases where there are more than two events and/or they can be called multiple times, then you need the more powerful and flexible EventEmitters.</p>

<h2>The Node.js Callback style</h2>

<p>Node originally had promises instead of callbacks.  Read the older versions of this article for more information.  After much debate, node decided to drop Promises for simple callbacks.</p>

<p>Any async function in node accepts a callback as it's last parameter.  Most the functions in the <code>'fs'</code> module are like this.  Then that callback is going to get the error (if any) as the first parameter.</p>

<pre><code><span class="com">// You call async functions like this.</span><span class="pln"><br />someAsyncFunction</span><span class="pun">(</span><span class="pln">param1</span><span class="pun">,</span><span class="pln"> param2</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">);</span><span class="pln"><br /><br /></span><span class="com">// And define your callback like this</span><span class="pln"><br /></span><span class="kwd">function</span><span class="pln"> callback</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> result</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{...}</span><span class="pln"><br /></span></code></pre>

<h2>There could be another way</h2>

<p>Promises worked well, but after reading about continuables from <a href="http://inimino.org/~inimino/blog/fileio_first_release">inimino</a>, I was inspired to try another way.</p>

<p>Remember our first example? Suppose that fs.readFile was used like this:</p>

<div class="snippet"><a href="control-flow-part-ii/continuable.js" class="code-link">continuable.js</a><pre><code><span class="kwd">var</span><span class="pln"> fs </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'./continuable-style-fs'</span><span class="pun">);</span><span class="pln"><br /><br />fs</span><span class="pun">.</span><span class="pln">readFile</span><span class="pun">(</span><span class="str">'mydata.txt'</span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">text</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="com">// Do something</span><span class="pln"><br />&nbsp; console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">text</span><span class="pun">);</span><span class="pln"><br /></span><span class="pun">},</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">error</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="com">// Handle error</span><span class="pln"><br />&nbsp; </span><span class="kwd">throw</span><span class="pln"> error<br /></span><span class="pun">});</span></code></pre></div>

<p>Instead of expecting a callback, it returns a function that's expecting two callback methods:  One for success and one for error.  I call this the <code>Do</code> style, and you'll soon see why.</p>

<h2>Making callback style actions</h2>

<p>Often we will want to make custom functions that don't return a value right away.  Using this new style, let's make a <code>fileWrite</code> function that looks like this (assuming that the fs functions were converted to this style too):</p>

<div class="snippet"><a href="control-flow-part-ii/file-write.js" class="code-link">file-write.js</a><pre><code><span class="kwd">var</span><span class="pln"> fs </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'./continuable-style-fs'</span><span class="pun">);</span><span class="pln"><br /><br /></span><span class="kwd">function</span><span class="pln"> fileWrite </span><span class="pun">(</span><span class="pln">filename</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">callback</span><span class="pun">,</span><span class="pln"> errback</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; fs</span><span class="pun">.</span><span class="pln">open</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">,</span><span class="pln"> </span><span class="str">"w"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0666</span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">fd</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> totalWritten </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">function</span><span class="pln"> doWrite </span><span class="pun">(</span><span class="pln">_data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; fs</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">fd</span><span class="pun">,</span><span class="pln"> _data</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="str">'utf8'</span><span class="pun">)(</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">written</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; totalWritten </span><span class="pun">+=</span><span class="pln"> written<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">totalWritten </span><span class="pun">===</span><span class="pln"> _data</span><span class="pun">.</span><span class="pln">length</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fs</span><span class="pun">.</span><span class="pln">close</span><span class="pun">(</span><span class="pln">fd</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; callback</span><span class="pun">(</span><span class="pln">totalWritten</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; doWrite</span><span class="pun">(</span><span class="pln">_data</span><span class="pun">.</span><span class="pln">slice</span><span class="pun">(</span><span class="pln">totalWritten</span><span class="pun">));</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">},</span><span class="pln"> errback</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; doWrite</span><span class="pun">(</span><span class="pln">data</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">},</span><span class="pln"> errback</span><span class="pun">);</span><span class="pln"><br /></span><span class="pun">}}</span><span class="pln"><br /><br /></span><span class="com">// Use it!</span><span class="pln"><br />fileWrite</span><span class="pun">(</span><span class="str">'test'</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Hello"</span><span class="pun">)(</span><span class="pln"><br />&nbsp; </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">written</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">written </span><span class="pun">+</span><span class="pln"> </span><span class="str">" bytes successfully written"</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">},</span><span class="pln"><br />&nbsp; </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">throw</span><span class="pln"> err</span><span class="pun">;</span><span class="pln"><br />&nbsp; </span><span class="pun">}</span><span class="pln"><br /></span><span class="pun">);</span></code></pre></div>

<p>Notice how easy it is to chain the error messages back up to our caller.  Also this code is much shorter, and easier to read. (Than the original promise version, not the callback version)</p>

<p>The key to making these actions is to, instead of creating a promise and returning, return a function that takes two callbacks and then call them directly when needed.</p>

<h2>The Do library</h2>

<p>I came up with a small library called <code>Do</code> earlier today.  Actually it's not much, just a single function that does parallel actions much like the Combo Library from the last article.</p>

<h3>Implementation</h3>

<p>Here is the entire library:</p>

<div class="snippet"><a href="control-flow-part-ii/do.js" class="code-link">do.js</a><pre><code><span class="kwd">var</span><span class="pln"> </span><span class="typ">Do</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; parallel</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">fns</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> results </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[],</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; counter </span><span class="pun">=</span><span class="pln"> fns</span><span class="pun">.</span><span class="pln">length</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">callback</span><span class="pun">,</span><span class="pln"> errback</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; fns</span><span class="pun">.</span><span class="pln">forEach</span><span class="pun">(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">fn</span><span class="pun">,</span><span class="pln"> i</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; fn</span><span class="pun">(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">result</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; results</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> result</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; counter</span><span class="pun">--;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">counter </span><span class="pun">&lt;=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; callback</span><span class="pun">.</span><span class="pln">apply</span><span class="pun">(</span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> results</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">},</span><span class="pln"> errback</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; </span><span class="pun">}</span><span class="pln"><br /></span><span class="pun">};</span><span class="pln"><br /><br /></span><span class="kwd">module</span><span class="pun">.</span><span class="pln">exports </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Do</span><span class="pun">;</span></code></pre></div>

<p>But combined with the callback style actions, this can lead to some very powerful and concise code.</p>

<h3>Single Action</h3>

<p>Lets assume that we have a function <code>readFile</code> that uses this new technique.  Here is how it's used:</p>

<pre><code><span class="com">// A single async action with error handling</span><span class="pln"><br />readFile</span><span class="pun">(</span><span class="str">'secretplans.txt'</span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">secrets</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="com">// Do something</span><span class="pln"><br /></span><span class="pun">},</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">error</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="com">// Handle Error</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /></span></code></pre>

<h3>Parallel actions</h3>

<p>Now let's combine that with the Do library:</p>

<pre><code><span class="typ">Do</span><span class="pun">.</span><span class="pln">parallel</span><span class="pun">([</span><span class="pln"><br />&nbsp; &nbsp; readFile</span><span class="pun">(</span><span class="str">'mylib.js'</span><span class="pun">),</span><span class="pln"><br />&nbsp; &nbsp; readFile</span><span class="pun">(</span><span class="str">'secretplans.txt'</span><span class="pun">),</span><span class="pln"><br /></span><span class="pun">])(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">source</span><span class="pun">,</span><span class="pln"> secrets</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="com">// Do something</span><span class="pln"><br /></span><span class="pun">},</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">error</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="com">// Handle Error</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /></span></code></pre>

<p>This does two async actions in parallel and reports when both are done. Note that it only fires success if there are no errors.  If there is an error, then it passes it to the common error handler.</p>

<p>You can also pass in an array of pre-made actions.</p>

<pre><code><span class="kwd">var</span><span class="pln"> files </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="str">"one.txt"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"two.txt"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"three.txt"</span><span class="pun">];</span><span class="pln"><br /></span><span class="kwd">var</span><span class="pln"> actions </span><span class="pun">=</span><span class="pln"> files</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">return</span><span class="pln"> readFile</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">);</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /><br /></span><span class="typ">Do</span><span class="pun">.</span><span class="pln">parallel</span><span class="pun">(</span><span class="pln">actions</span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> contents </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{},</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; args </span><span class="pun">=</span><span class="pln"> arguments</span><span class="pun">;</span><span class="pln"><br />&nbsp; files</span><span class="pun">.</span><span class="pln">forEach</span><span class="pun">(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">filename</span><span class="pun">,</span><span class="pln"> index</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; contents</span><span class="pun">[</span><span class="pln">filename</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> args</span><span class="pun">[</span><span class="pln">index</span><span class="pun">];</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; </span><span class="com">// Do something</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /></span><span class="com">// Let error thow exception.</span><span class="pln"><br /></span></code></pre>

<h3>Sequential Actions</h3>

<p>For serial actions, simply chain the action functions.</p>

<pre><code><span class="pln">readFile</span><span class="pun">(</span><span class="str">'names.txt'</span><span class="pun">)(</span><span class="pln"><br />&nbsp; </span><span class="kwd">function</span><span class="pln"> upcase_slowly</span><span class="pun">(</span><span class="kwd">string</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">next</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; setTimeout</span><span class="pun">(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="kwd">next</span><span class="pun">(</span><span class="kwd">string</span><span class="pun">.</span><span class="pln">toUpperCase</span><span class="pun">());</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">},</span><span class="pln"> </span><span class="lit">100</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">}}</span><span class="pln"><br /></span><span class="pun">)(</span><span class="pln"><br />&nbsp; </span><span class="kwd">function</span><span class="pln"> save_data</span><span class="pun">(</span><span class="kwd">string</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">next</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; writeFile</span><span class="pun">(</span><span class="str">'names_up.txt'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">string</span><span class="pun">)(</span><span class="kwd">next</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">}}</span><span class="pln"><br /></span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="com">// File was saved</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /></span></code></pre>

<p>This will read the file 'names.txt'.  When that's done it will call <code>upcase_slowly</code>. When that's done it will pass the new string to <code>save_data</code>, which wraps <code>writeFile</code>.  When <code>writeFile</code> is done our final callback will be invoked.</p>

<p>Just for fun, here is the same example translated to the <a href="http://github.com/creationix/jack">Jack</a> language (still in development).</p>

<pre><code><span class="pln">readFile names</span><span class="pun">.</span><span class="pln">txt<br /></span><span class="pun">|</span><span class="pln"> fun </span><span class="kwd">string</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="kwd">next</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"><br />&nbsp; timeout </span><span class="lit">100</span><span class="pun">,</span><span class="pln"> fun </span><span class="pun">-&gt;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">next</span><span class="pln"> </span><span class="kwd">string</span><span class="pun">.</span><span class="pln">toUpperCase</span><span class="pun">()</span><span class="pln"><br /></span><span class="pun">|</span><span class="pln"> fun </span><span class="kwd">string</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="kwd">next</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"><br />&nbsp; writeFile </span><span class="str">'names_up.txt'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> </span><span class="pun">|</span><span class="pln"> </span><span class="kwd">next</span><span class="pln"><br /></span><span class="pun">|</span><span class="pln"> fun </span><span class="pun">-&gt;</span><span class="pln"><br />&nbsp; </span><span class="com"># File was saved</span><span class="pln"><br /></span></code></pre>

<p><strong>UPDATE</strong> I have since made a more powerful library that embraces node's native callback style called Step.  Read more on it's article <a href="step-of-conductor.html">step-of-conductor</a>.</p><hr style="clear:both" /><div class="body" id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
var disqus_url = "http://howtonode.org/control-flow-part-ii";
//]]>
</script>
<script src="http://disqus.com/forums/howtonodeorg/embed.js" type="text/javascript"></script><a href="http://disqus.com/forums/howtonodeorg/?url=ref" class="view-thread">View the discussion thread.</a><a href="http://disqus.com/" class="dsq-brlink">blog comments powered by<span class="logo-disqus">Disqus</span></a>
<script type="text/javascript">
//<![CDATA[
(function() {
  var links = document.getElementsByTagName('a');
  var query = '?';
  for(var i = 0; i < links.length; i++) {
    if(links[i].href.indexOf('#disqus_thread') >= 0) {
      query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&amp;';
    }
  }
  document.write('<script charset="utf-8" type="text/javascript" src="//disqus.com/forums/howtonodeorg/get_num_replies.js' + query + '"></' + 'script>');
})();


//]]>
</script>
</div></div><div id="sidebar"><div class="aside author"><h4>About the Author</h4><img src="https://www.gravatar.com/avatar/c953ddd239707998340e1a6fbb3eeb46?r=pg&amp;s=200.jpg&amp;d=identicon" class="headshot" /><dl><dt>Name:</dt><dd>Tim Caswell</dd></dl><dl><dt>Github:</dt><dd><a href="https://github.com/creationix">creationix</a></dd></dl><dl><dt>Twitter:</dt><dd><a href="https://twitter.com/creationix">creationix</a></dd></dl><dl><dt>Location:</dt><dd>Red Lick, TX</dd></dl><dl><dt>Links:</dt><dd><a href="http://creationix.com/">Homepage</a></dd></dl></div><div class="aside"><h4>About this Article</h4><a href="http://twitter.com/share" data-count="horizontal" data-via="creationix" class="twitter-share-button">Tweet</a><script src="http://platform.twitter.com/widgets.js"></script><dl title="Thu Feb 04 2010 02:24:35 GMT-0600 (CST)"><dt>Date Released:</dt><dd>Thursday, February  4, 2010</dd></dl><dl><dt>Node Version:</dt><dd><a href="http://github.com/joyent/node/tree/v0.1.102">node v0.1.102</a></dd></dl><dl><dt>Code Samples:</dt><dd><ul><li><a href="control-flow-part-ii/callback.js">callback.js</a></li><li><a href="control-flow-part-ii/http-body.js">http-body.js</a></li><li><a href="control-flow-part-ii/continuable.js">continuable.js</a></li><li><a href="control-flow-part-ii/file-write.js">file-write.js</a></li><li><a href="control-flow-part-ii/do.js">do.js</a></li></ul></dd></dl><dl><dt>Revisions:</dt><dd><ul></ul></dd></dl></div><div class="bubble"><h3>About HowToNode.org</h3>

<p>HowToNode.org is a community supported blog created by <a href="http://creationix.com/">Tim Caswell</a>. The purpose of the blog is to teach how to do various tasks in <a href="http://nodejs.org/">node.js</a> as well as teach fundamental concepts that are needed to write effective code.</p>

<p>This site is powered by <a href="http://github.com/creationix/wheat">Wheat</a>, a git based blogging engine written in <a href="http://nodejs.org/">node.JS</a>.</p>

<p>The content for this site is stored in a <a href="http://github.com/creationix/howtonode.org">git repository</a> that anyone can fork, write an article, and send a pull request. If your article passes the quality standards it will be published and help support the greater node community.</p></div></div><div id="footer"><p>&copy; 2011-2014 Tim Caswell under the MIT license.</p><p>Content and articles are copyrighted to the individual authors. Design by&nbsp;<a href="https://bengourley.co.uk/">Ben Gourley</a>. All code snippets used in the examples are in the public domain.</p><p>Wheat v2 running on node.js v16.4.2</p></div></div>
<script type="text/javascript">
//<![CDATA[
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
//]]>
</script>

<script type="text/javascript">
//<![CDATA[
try {
var pageTracker = _gat._getTracker("UA-12824411-1");
pageTracker._trackPageview();
} catch(err) {}
//]]>
</script>
</body>
<!-- Mirrored from localhost:8080/control-flow-part-ii by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 13 Jul 2021 14:00:24 GMT -->
</html>