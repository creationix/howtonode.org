<!DOCTYPE html>
<html lang="en">
<!-- Mirrored from localhost:8080/node-redis-fun by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 13 Jul 2021 13:59:36 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset="utf-8" /><title>Node + Redis = Fun - How To Node - NodeJS</title><meta name="description" content="Learn the zen of coding in NodeJS." /><meta name="viewport" content="width=device-width" /><link href="style.css" rel="stylesheet" /><link href="print.css" rel="stylesheet" media="print" /><link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="feed.xml" /><link href="favicon.ico" rel="icon" type="image/x-icon" /></head><body><div id="container"><div id="header"><a href="index.html"><img src="logo.png" alt="How to Node" class="logo" /><div class="tagline">The zen of coding in node.js</div></a></div><div id="main"><div class="article"><h1><a href="node-redis-fun.html">Node + Redis = Fun</a></h1><p class="old-node-warning">HEADS UP! This article was written for an older version of node.&nbsp;More up-to-date information may be available elsewhere.</p><p>node brings asynchronous, evented I/O to the server. Redis gives you a blazing fast database with support for strings, lists and sets. Both Redis and Node.js follow certain patterns, Redis for data-storage, and node for event based programming. I hope to give an introduction to both in this article. By the time we are done, we will have built a <a href="http://en.wikipedia.org/wiki/Pastebin">Pastebin</a> service.</p>

<h2>Getting Started</h2>

<p>I will assume that the reader is comfortable with Javascript, including using events and passing around functions.</p>

<p>Before we get down to the code, here is the software you will need:</p>

<ul>
<li><a href="http://nodejs.org/">node</a> ( we will use <a href="http://github.com/ry/node/downloads">v0.2.0</a> )</li>
<li><a href="http://code.google.com/p/redis/">Redis</a></li>
<li><a href="http://github.com/fictorial/redis-node-client/">redis-node-client</a> - to connect to Redis from node. Already bundled within snip.</li>
<li><a href="http://github.com/gjritter/nerve/">nerve</a> - A micro-framework to handle routing. Use the bundled version which works with node v0.1.91.</li>
<li><a href="http://documentcloud.github.com/underscore/">underscore.js</a> - A collection of useful javascript functions, we will use only one.</li>
<li><a href="http://pygments.org/">Pygments</a> - Python program to syntax highlight code.</li>
</ul>

<p>Finally, here is how our code is organized.</p>

<pre><code><span class="pln">snip<br /></span><span class="pun">|-</span><span class="pln"> deps</span><span class="pun">/</span><span class="pln"><br />&nbsp; &nbsp;</span><span class="pun">|-</span><span class="pln"> redis</span><span class="pun">-</span><span class="pln">node</span><span class="pun">-</span><span class="pln">client</span><span class="pun">/</span><span class="pln"><br />&nbsp; &nbsp;</span><span class="pun">|-</span><span class="pln"> nerve</span><span class="pun">/</span><span class="pln"><br />&nbsp; &nbsp;</span><span class="pun">|-</span><span class="pln"> underscore</span><span class="pun">.</span><span class="pln">js<br /></span><span class="pun">|-</span><span class="pln"> run<br /></span><span class="pun">|-</span><span class="pln"> snip</span><span class="pun">.</span><span class="pln">js<br /></span></code></pre>

<h2>A note on the node module system</h2>

<p>Node modules are used by importing them into the current scope using <code>require()</code>. The <code>NODE_PATH</code> environment variable is used to search for modules. When you have lots of dependencies, it gets boring to keep entering the full paths in the requires all the time. So rather than directly invoking</p>

<pre><code><span class="pln">node </span><span class="str">&lt;script&gt;</span><span class="pln"><br /></span></code></pre>

<p>to test our application, we will be using this shell script, so that we can directly do</p>

<pre><code><span class="kwd">require</span><span class="pun">(</span><span class="pln"> </span><span class="str">'nerve'</span><span class="pln"> </span><span class="pun">)</span><span class="pln"><br /></span></code></pre>

<p>and have it work</p>

<pre><code><span class="com">#!/usr/bin/env sh</span><span class="pln"><br /></span><span class="kwd">export</span><span class="pln"> SNIP_PATH</span><span class="pun">=</span><span class="pln">$</span><span class="pun">(</span><span class="pln">dirname </span><span class="str">`readlink -f $0`</span><span class="pun">)</span><span class="pln"><br /><br /></span><span class="kwd">export</span><span class="pln"> NODE_PATH</span><span class="pun">=\</span><span class="pln"><br />$NODE_PATH</span><span class="pun">\</span><span class="pln"><br /></span><span class="pun">:</span><span class="pln">$SNIP_PATH</span><span class="pun">\</span><span class="pln"><br /></span><span class="pun">:</span><span class="pln">$SNIP_PATH</span><span class="pun">/</span><span class="pln">deps</span><span class="pun">/</span><span class="pln">redis</span><span class="pun">-</span><span class="pln">node</span><span class="pun">-</span><span class="pln">client</span><span class="pun">/</span><span class="pln">lib</span><span class="pun">\</span><span class="pln"><br /></span><span class="pun">:</span><span class="pln">$SNIP_PATH</span><span class="pun">/</span><span class="pln">deps</span><span class="pun">/</span><span class="pln">nerve</span><span class="pun">/</span><span class="pln">lib</span><span class="pun">\</span><span class="pln"><br /></span><span class="pun">:</span><span class="pln">$SNIP_PATH</span><span class="pun">/</span><span class="pln">deps</span><span class="pun">/</span><span class="pln"> </span><span class="com">#underscore.js</span><span class="pln"><br /><br />node </span><span class="str">"$@"</span><span class="pln"><br /></span></code></pre>

<h2>The Big Picture</h2>

<p>Here is how our application works</p>

<ol>
<li>You visit the http://localhost:8000/</li>
<li>Post your code snippet, and choose the language</li>
<li>Get a unique url http://localhost:8000/<code>id</code></li>
</ol>

<h2>Database Schema</h2>

<p><em>See the <a href="http://code.google.com/p/redis/wiki/CommandReference">full list of Redis commands</a>. redis-node-client will abstract the actual communication.</em></p>

<p>So how do we represent our data ( snippets ) so that we can do all the things we want to do?</p>

<p>Relational databases have rows and columns, where columns identify various parts of the data. But key-value stores, including Redis, don't have that. The solution is to encode the column in the key itself. So for each snippet we will have a key snippet:<code>id</code>. So how do we prevent two snippets from having the same <code>id</code>? In MySQL you would probably set the <code>id</code> column of the <code>snippets</code> table to <code>PRIMARY KEY AUTO_INCREMENT</code>. We will similarly use a key <em>nextid</em> which is a simple integer, to keep track of snippets. We will use Redis's <em>atomic</em> operation <code>INCR</code> to get an id:</p>

<pre><code><span class="pln">INCR nextid<br /></span><span class="typ">Now</span><span class="pln"> you can </span><span class="kwd">use</span><span class="pln"> the </span><span class="kwd">new</span><span class="pln"> returned id</span><span class="pun">,</span><span class="pln"> which will be unique<br /></span></code></pre>

<p>The snippet itself is stored as a JSON map. The inbuilt functions <code>JSON.stringify</code> and <code>JSON.parse</code> are used to convert to and fro.</p>

<pre><code><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="str">'language'</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="str">'&lt;language&gt;'</span><span class="pun">,</span><span class="pln"><br />&nbsp; </span><span class="str">'snippet'</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="str">'&lt;Actual data&gt;'</span><span class="pun">,</span><span class="pln"><br /></span><span class="pun">}</span><span class="pln"><br /></span></code></pre>

<p>Redis allows values to be upto 1GB in size, so we don't have to worry about that.</p>

<h2>First code</h2>

<p>First lets get nerve started so that we get something which works. nerve accepts a list of routes, based or regular expressions, and calls the associated function. For the first run lets just display the string 'Hello World'. Add the following to snip.js:</p>

<pre><code><span class="pln">nerve</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span><span class="pln"> </span><span class="pun">[</span><span class="pln"><br />&nbsp; </span><span class="pun">[</span><span class="pln"> </span><span class="str">/.*/</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln"> req</span><span class="pun">,</span><span class="pln"> res </span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> res</span><span class="pun">.</span><span class="pln">respond</span><span class="pun">(</span><span class="pln"> </span><span class="str">"Hello World"</span><span class="pln"> </span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln"> </span><span class="pun">]</span><span class="pln"><br /></span><span class="pun">]).</span><span class="pln">listen</span><span class="pun">(</span><span class="pln"> </span><span class="lit">8000</span><span class="pln"> </span><span class="pun">);</span><span class="pln"><br /></span></code></pre>

<p><code>./run snip.js</code> and point your browser to http://localhost:8000. Its as simple as that. <code>/.*/</code> means match any URL and invoke this function. Each function is passed two argIts as simple as that. <code>/.*/</code> means match any URL and invoke this function. Each function is passed two arguments, <code>request</code> and <code>response</code>. <code>request</code> will have lots of information about the client request, like headers and form data which we are interested in. <code>response</code> is used to send content back to the client. <code>respond.respond(data)</code> sends all the data to the browser and closes the connection.</p>

<p>Node relies on asynchronous I/O and so we will often be dealing with streaming data. The lower level methods <code>respond.sendHeader()</code>, <code>respond.write()</code> and <code>response.close()</code> will allow us to apply streaming. This will be used when we Syntax-highlight code.</p>

<h2>Adding Snippets</h2>

<p>Before we can do anything, we need some data, so let's create the form. Since it's pretty simple, we'll just put it as a string. Usually you would store all these <em>views</em> in files and stream them over the connection.</p>

<p>A particularly nasty part of our code is the list of languages, generated by <a href="http://gist.github.com/310877">getLanguageList</a>, which I haven't included here, but is present in the code. Ideally you wouldn't have this <em>data</em> in your <em>code</em>.</p>

<p>So this is a part of <code>snip.js</code></p>

<div class="snippet"><a href="node-redis-fun/snip.js" class="code-link">snip.js<span class="hash">#formHtml</span></a><pre><code><span class="kwd">var</span><span class="pln"> formHtml </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;form action="/add" method="post"&gt;'</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">+</span><span class="pln"> &nbsp;</span><span class="str">'&lt;label for="code"&gt;Paste code&lt;/label&gt;&lt;br&gt;'</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">+</span><span class="pln"> &nbsp;</span><span class="str">'&lt;textarea name="code" rows="25" cols="80"&gt;&lt;/textarea&gt;&lt;br&gt;'</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">+</span><span class="pln"> &nbsp;</span><span class="str">'&lt;label for="language"&gt;Language&lt;/label&gt;'</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">+</span><span class="pln"> &nbsp;</span><span class="str">'&lt;select name="language"&gt;'</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">+</span><span class="pln"> &nbsp;genLanguageList</span><span class="pun">()</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">+</span><span class="pln"> &nbsp;</span><span class="str">'&lt;/select&gt;'</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">+</span><span class="pln"> &nbsp;</span><span class="str">'&lt;input type="submit" value="Paste!" /&gt;&lt;/form&gt;'</span><span class="pun">;</span></code></pre></div>

<pre><code><span class="kwd">var</span><span class="pln"> addSnippet </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{}</span><span class="pln"><br /></span><span class="kwd">var</span><span class="pln"> showSnippet </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{}</span><span class="pln"><br /></span></code></pre>

<div class="snippet"><a href="node-redis-fun/snip.js" class="code-link">snip.js<span class="hash">#create</span></a><pre><code><span class="pln">nerve</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span><span class="pln"> </span><span class="pun">[</span><span class="pln"><br />&nbsp; </span><span class="pun">[</span><span class="pln"> </span><span class="str">/^\/([0-9]+)/</span><span class="pun">,</span><span class="pln"> showSnippet </span><span class="pun">],</span><span class="pln"><br />&nbsp; </span><span class="pun">[</span><span class="pln"> nerve</span><span class="pun">.</span><span class="pln">post</span><span class="pun">(</span><span class="str">"/add"</span><span class="pun">),</span><span class="pln"> addSnippet </span><span class="pun">],</span><span class="pln"><br />&nbsp; </span><span class="pun">[</span><span class="pln"> </span><span class="str">"/"</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln"> req</span><span class="pun">,</span><span class="pln"> res </span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> res</span><span class="pun">.</span><span class="pln">respond</span><span class="pun">(</span><span class="pln"> formHtml </span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln"> </span><span class="pun">]</span><span class="pln"><br /></span><span class="pun">]).</span><span class="pln">listen</span><span class="pun">(</span><span class="pln"> </span><span class="lit">8000</span><span class="pln"> </span><span class="pun">);</span></code></pre></div>

<h3>Handling post data</h3>

<p>Each <code>nerve</code> handler function receives two arguments, the first is a <a href="http://nodejs.org/api.html#_http">http.ServerRequest</a> object and the second is a <a href="http://nodejs.org/api.html#_http">http.ServerResponse</a>.</p>

<p>POST data is sent in the body of the Request. Since the data is streamed we have to add a listener function to collect all the data into a buffer. The Request will <em>emit</em> a <code>end</code> signal when all data has been received, so we know when to stop. Once we have all the data, we want to parse it and use it. To make this generic we pass <code>getPostParams</code> a <a href="http://howtonode.org/control-flow">callback</a> function, which it will call with the results of the query.</p>

<p>We can parse the form data using the querystring module, so that our function becomes:</p>

<div class="snippet"><a href="node-redis-fun/snip.js" class="code-link">snip.js<span class="hash">#getPostParams</span></a><pre><code><span class="kwd">var</span><span class="pln"> getPostParams </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">req</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">){</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> body </span><span class="pun">=</span><span class="pln"> </span><span class="str">''</span><span class="pun">;</span><span class="pln"><br />&nbsp; req</span><span class="pun">.</span><span class="pln">on</span><span class="pun">(</span><span class="str">'data'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">chunk</span><span class="pun">){</span><span class="pln"><br />&nbsp; &nbsp; &nbsp;body </span><span class="pun">+=</span><span class="pln"> chunk</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp;</span><span class="pun">})</span><span class="pln"><br />&nbsp; &nbsp;</span><span class="pun">.</span><span class="pln">on</span><span class="pun">(</span><span class="str">'end'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp;</span><span class="kwd">var</span><span class="pln"> obj </span><span class="pun">=</span><span class="pln"> qs</span><span class="pun">.</span><span class="pln">parse</span><span class="pun">(</span><span class="pln"> &nbsp;body</span><span class="pun">.</span><span class="pln">replace</span><span class="pun">(</span><span class="pln"> </span><span class="str">/\+/</span><span class="pln">g</span><span class="pun">,</span><span class="pln"> </span><span class="str">' '</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> </span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp;callback</span><span class="pun">(</span><span class="pln"> obj </span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp;</span><span class="pun">});</span><span class="pln"><br /></span><span class="pun">}</span></code></pre></div>

<p>Now lets just get <code>addSnippet()</code> to echo the form data:</p>

<pre><code><span class="kwd">var</span><span class="pln"> addSnippet </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln"> req</span><span class="pun">,</span><span class="pln"> res </span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; getPostParams</span><span class="pun">(</span><span class="pln">req</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln"> obj </span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; res</span><span class="pun">.</span><span class="pln">respond</span><span class="pun">(</span><span class="pln"> sys</span><span class="pun">.</span><span class="pln">inspect</span><span class="pun">(</span><span class="pln"> obj </span><span class="pun">)</span><span class="pln"> </span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /></span><span class="pun">}</span><span class="pln"><br /></span></code></pre>

<p>Now if you try posting some code you should see the object literal being echoed back.</p>

<h3>Store the snippet</h3>

<p>Instead of echoing back the POST data, lets now store it in Redis, thus finishing half the implementation of the pastebin. We have to:</p>

<ol>
<li>Get a unique id for the URL</li>
<li>Store the data</li>
<li>When both succeed, display the URL to the user.</li>
</ol>

<p>Again, fitting with node's asynchronous model, we will have to use a sequence of callbacks. Remember that each function introduces a scope with its own <em>this</em> reference, so make sure you save any this references in outer scopes as some other variable:</p>

<div class="snippet"><a href="node-redis-fun/snip.js" class="code-link">snip.js<span class="hash">#addSnippet</span></a><pre><code><span class="kwd">var</span><span class="pln"> addSnippet </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln"> req</span><span class="pun">,</span><span class="pln"> res </span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; getPostParams</span><span class="pun">(</span><span class="pln"> req</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln"> obj </span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> r </span><span class="pun">=</span><span class="pln"> redis</span><span class="pun">.</span><span class="pln">createClient</span><span class="pun">();</span><span class="pln"><br /><br />&nbsp; &nbsp; &nbsp; r</span><span class="pun">.</span><span class="pln">stream</span><span class="pun">.</span><span class="pln">on</span><span class="pun">(</span><span class="pln"> </span><span class="str">'connect'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; r</span><span class="pun">.</span><span class="pln">incr</span><span class="pun">(</span><span class="pln"> </span><span class="str">'nextid'</span><span class="pln"> </span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln"> err</span><span class="pun">,</span><span class="pln"> id </span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r</span><span class="pun">.</span><span class="kwd">set</span><span class="pun">(</span><span class="pln"> </span><span class="str">'snippet:'</span><span class="pun">+</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> JSON</span><span class="pun">.</span><span class="pln">stringify</span><span class="pun">(</span><span class="pln"> obj </span><span class="pun">),</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> msg </span><span class="pun">=</span><span class="pln"> </span><span class="str">'The snippet has been saved at &lt;a href="/'</span><span class="pun">+</span><span class="pln">id</span><span class="pun">+</span><span class="str">'"&gt;'</span><span class="pun">+</span><span class="pln">req</span><span class="pun">.</span><span class="pln">headers</span><span class="pun">.</span><span class="pln">host</span><span class="pun">+</span><span class="str">'/'</span><span class="pun">+</span><span class="pln">id</span><span class="pun">+</span><span class="str">'&lt;/a&gt;'</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res</span><span class="pun">.</span><span class="pln">respond</span><span class="pun">(</span><span class="pln"> msg </span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"> </span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"> </span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"> </span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br /></span><span class="pun">};</span></code></pre></div>

<p>The SET operation sets a key to the string value. We use JSON.stringify to get a nice string representation of the request object. Finally once the save is successful we notify the user. That's it, your snippet is saved and ready to show, which brings us to...</p>

<h3>Syntax highlighting</h3>

<p>Since <code>pygmentize</code> is an external program we are going to spawn a child process and pass it various options. Pygmentize will wait on stdin and write out to stdout. So we are going to do something similar to pipes in shells.</p>

<pre><code><span class="pln">pygmentize </span><span class="pun">[</span><span class="pln">options</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> redis data </span><span class="pun">&gt;</span><span class="pln"> browser<br /></span></code></pre>

<p>It would have been even cooler if redis-node-client supported streaming the data rather than buffering it, but you can't have everything... . Anyway this is how we call pygmentize:</p>

<pre><code><span class="com">// for now just assume we magically</span><span class="pln"><br /></span><span class="com">// got the snippet JSON parsed into obj</span><span class="pln"><br /><br /></span><span class="com">// get the language short code</span><span class="pln"><br /></span><span class="com">// not that languages is an array of</span><span class="pln"><br /></span><span class="com">// ["shortcode", "name"] elements and filter</span><span class="pln"><br /></span><span class="com">// returns a *list* so we need the 0th element.</span><span class="pln"><br /></span><span class="kwd">var</span><span class="pln"> shortcode </span><span class="pun">=</span><span class="pln"> languages</span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">el</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">return</span><span class="pln"> el</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> obj</span><span class="pun">.</span><span class="pln">language</span><span class="pun">;</span><span class="pln"><br /></span><span class="pun">})</span><span class="pln"> </span><span class="pun">[</span><span class="lit">0</span><span class="pun">][</span><span class="lit">0</span><span class="pun">];</span><span class="pln"><br /><br /><br /></span><span class="kwd">var</span><span class="pln"> pyg </span><span class="pun">=</span><span class="pln"> cp</span><span class="pun">.</span><span class="pln">spawn</span><span class="pun">(</span><span class="pln"> </span><span class="str">"pygmentize"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">[</span><span class="pln"> </span><span class="str">"-l"</span><span class="pun">,</span><span class="pln"> shortcode</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"-f"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"html"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"-O"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"full,style=pastie"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"-P"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"title=Snippet #"</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> id </span><span class="pun">]</span><span class="pln"> </span><span class="pun">);</span><span class="pln"><br />pyg</span><span class="pun">.</span><span class="pln">stdout</span><span class="pun">.</span><span class="pln">on</span><span class="pun">(</span><span class="pln"> </span><span class="str">"data"</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln"> coloured </span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln"> coloured </span><span class="pun">)</span><span class="pln"><br />&nbsp; &nbsp; res</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln"> coloured </span><span class="pun">);</span><span class="pln"><br /></span><span class="pun">}</span><span class="pln"> </span><span class="pun">);</span><span class="pln"><br /><br />pyg</span><span class="pun">.</span><span class="pln">on</span><span class="pun">(</span><span class="pln"> </span><span class="str">'exit'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; res</span><span class="pun">.</span><span class="kwd">end</span><span class="pun">();</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /><br />pyg</span><span class="pun">.</span><span class="pln">stdin</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln"> obj</span><span class="pun">.</span><span class="pln">code </span><span class="pun">);</span><span class="pln"><br />pyg</span><span class="pun">.</span><span class="pln">stdin</span><span class="pun">.</span><span class="kwd">end</span><span class="pun">();</span><span class="pln"><br /></span></code></pre>

<p>The first half is pretty self explanatory. We add a
listener <code>data</code> to watch for data on the child's <em>stdout</em>. Then we send the plain code to pygmentize via its <em>stdin</em>. It is necessary to close the stream otherwise pygmentize will keep waiting for data and won't generate output. We incrementally write out data as it is received. <code>coloured</code> will be null when done.</p>

<p>To get the actual snippet to fetch, we are going to
get nerve to pass us the id. In routing</p>

<div class="snippet"><a href="node-redis-fun/snip.js" class="code-link">snip.js<span class="hash">#create</span></a><pre><code><span class="pln">nerve</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span><span class="pln"> </span><span class="pun">[</span><span class="pln"><br />&nbsp; </span><span class="pun">[</span><span class="pln"> </span><span class="str">/^\/([0-9]+)/</span><span class="pun">,</span><span class="pln"> showSnippet </span><span class="pun">],</span><span class="pln"><br />&nbsp; </span><span class="pun">[</span><span class="pln"> nerve</span><span class="pun">.</span><span class="pln">post</span><span class="pun">(</span><span class="str">"/add"</span><span class="pun">),</span><span class="pln"> addSnippet </span><span class="pun">],</span><span class="pln"><br />&nbsp; </span><span class="pun">[</span><span class="pln"> </span><span class="str">"/"</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln"> req</span><span class="pun">,</span><span class="pln"> res </span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> res</span><span class="pun">.</span><span class="pln">respond</span><span class="pun">(</span><span class="pln"> formHtml </span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln"> </span><span class="pun">]</span><span class="pln"><br /></span><span class="pun">]).</span><span class="pln">listen</span><span class="pun">(</span><span class="pln"> </span><span class="lit">8000</span><span class="pln"> </span><span class="pun">);</span></code></pre></div>

<p>The <code>([0-9]+)</code> <em>match group</em> will be extracted by
nerve and passed to the handler as the third argument.
With that in place we are ready to show the output.</p>

<div class="snippet"><a href="node-redis-fun/snip.js" class="code-link">snip.js<span class="hash">#showSnippet</span></a><pre><code><span class="kwd">var</span><span class="pln"> showSnippet </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln"> req</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> id </span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> r </span><span class="pun">=</span><span class="pln"> redis</span><span class="pun">.</span><span class="pln">createClient</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; r</span><span class="pun">.</span><span class="pln">stream</span><span class="pun">.</span><span class="pln">on</span><span class="pun">(</span><span class="pln"> </span><span class="str">'connect'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; r</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="pln"> </span><span class="str">'snippet:'</span><span class="pun">+</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln"> err</span><span class="pun">,</span><span class="pln"> data </span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln">data </span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res</span><span class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span class="pln"> </span><span class="lit">404</span><span class="pln"> </span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln"> </span><span class="str">"No such snippet"</span><span class="pln"> </span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res</span><span class="pun">.</span><span class="kwd">end</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">return</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br /><br />&nbsp; &nbsp; &nbsp; &nbsp; res</span><span class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span class="pln"> </span><span class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="str">"Content-Type"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/html"</span><span class="pln"> </span><span class="pun">}</span><span class="pln"> </span><span class="pun">);</span><span class="pln"><br /><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> obj </span><span class="pun">=</span><span class="pln"> JSON</span><span class="pun">.</span><span class="pln">parse</span><span class="pun">(</span><span class="pln"> data</span><span class="pun">.</span><span class="pln">toString</span><span class="pun">()</span><span class="pln"> </span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> shortcode </span><span class="pun">=</span><span class="pln"> languages</span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">el</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> el</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> obj</span><span class="pun">.</span><span class="pln">language</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> </span><span class="pun">[</span><span class="lit">0</span><span class="pun">][</span><span class="lit">0</span><span class="pun">];</span><span class="pln"><br /><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> pyg </span><span class="pun">=</span><span class="pln"> cp</span><span class="pun">.</span><span class="pln">spawn</span><span class="pun">(</span><span class="pln"> </span><span class="str">"pygmentize"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">[</span><span class="pln"> </span><span class="str">"-l"</span><span class="pun">,</span><span class="pln"> shortcode</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"-f"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"html"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"-O"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"full,style=pastie"</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"-P"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"title=Snippet #"</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> id </span><span class="pun">]</span><span class="pln"> </span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; pyg</span><span class="pun">.</span><span class="pln">stdout</span><span class="pun">.</span><span class="pln">on</span><span class="pun">(</span><span class="pln"> </span><span class="str">"data"</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln"> coloured </span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln"> coloured </span><span class="pun">)</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln"> coloured </span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"> </span><span class="pun">);</span><span class="pln"><br /><br />&nbsp; &nbsp; &nbsp; &nbsp; pyg</span><span class="pun">.</span><span class="pln">on</span><span class="pun">(</span><span class="pln"> </span><span class="str">'exit'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res</span><span class="pun">.</span><span class="kwd">end</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br /><br />&nbsp; &nbsp; &nbsp; &nbsp; pyg</span><span class="pun">.</span><span class="pln">stdin</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln"> obj</span><span class="pun">.</span><span class="pln">code </span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; pyg</span><span class="pun">.</span><span class="pln">stdin</span><span class="pun">.</span><span class="kwd">end</span><span class="pun">();</span><span class="pln"><br /><br />&nbsp; &nbsp; &nbsp; &nbsp; r</span><span class="pun">.</span><span class="pln">close</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /></span><span class="pun">}</span></code></pre></div>

<p>The Redis related code is pretty similar to <code>addSnippet()</code>. In case the key doesn't exist, we will get a null. So we use <code>sendHeader()</code> to send a <em>404 Page Not Found</em>, and stop. Otherwise we send a healthy 200, tell the browser to expect HTML and then stream the data. Start the server, visit <code>/&lt;id&gt;</code> and get your freshly highlighted code!</p>

<h2>I want more</h2>

<p>Extend the simple pastebin to allow expiry (HINT: The Redis EXPIRE command), allow people to edit the bin and keep a diff history or more. One big improvement would be to cache the pygmentize results as that could really slow down a popular site with a large number of requests per second.</p>

<p><a href="http://howtonode.org/">How To Node</a> has more great articles about writing other web apps. Tinker around with writing JavaScript bindings for C/C++ libraries or go build  a Asynchronous, Distributed Googolplexbazillion search engine.</p>

<p>Full code for this article can be found at <a href="http://bitbucket.org/nikhilm/snip">Bitbucket</a></p><hr style="clear:both" /><div class="body" id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
var disqus_url = "http://howtonode.org/node-redis-fun";
//]]>
</script>
<script src="http://disqus.com/forums/howtonodeorg/embed.js" type="text/javascript"></script><a href="http://disqus.com/forums/howtonodeorg/?url=ref" class="view-thread">View the discussion thread.</a><a href="http://disqus.com/" class="dsq-brlink">blog comments powered by<span class="logo-disqus">Disqus</span></a>
<script type="text/javascript">
//<![CDATA[
(function() {
  var links = document.getElementsByTagName('a');
  var query = '?';
  for(var i = 0; i < links.length; i++) {
    if(links[i].href.indexOf('#disqus_thread') >= 0) {
      query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&amp;';
    }
  }
  document.write('<script charset="utf-8" type="text/javascript" src="//disqus.com/forums/howtonodeorg/get_num_replies.js' + query + '"></' + 'script>');
})();


//]]>
</script>
</div></div><div id="sidebar"><div class="aside author"><h4>About the Author</h4><img src="https://www.gravatar.com/avatar/9d2d8883a6f23209c0ae4f093e1a8a27?r=pg&amp;s=200.jpg&amp;d=identicon" class="headshot" /><dl><dt>Name:</dt><dd>Nikhil Marathe</dd></dl><dl><dt>Github:</dt><dd><a href="https://github.com/nikhilm">nikhilm</a></dd></dl><dl><dt>BitBucket:</dt><dd><a href="https://bitbucket.com/nikhilm">nikhilm</a></dd></dl><dl><dt>Links:</dt><dd><a href="http://kodeclutz.blogspot.com/">Homepage</a></dd></dl></div><div class="aside"><h4>About this Article</h4><a href="http://twitter.com/share" data-count="horizontal" data-via="creationix" class="twitter-share-button">Tweet</a><script src="http://platform.twitter.com/widgets.js"></script><dl title="Tue Feb 23 2010 21:20:20 GMT+530 (IST)"><dt>Date Released:</dt><dd>Tuesday, February 23, 2010</dd></dl><dl><dt>Node Version:</dt><dd><a href="http://github.com/joyent/node/tree/v0.2.0">node v0.2.0</a></dd></dl><dl><dt>Code Samples:</dt><dd><ul><li><a href="node-redis-fun/snip.js">snip.js</a></li></ul></dd></dl><dl><dt>Revisions:</dt><dd><ul></ul></dd></dl></div><div class="bubble"><h3>About HowToNode.org</h3>

<p>HowToNode.org is a community supported blog created by <a href="http://creationix.com/">Tim Caswell</a>. The purpose of the blog is to teach how to do various tasks in <a href="http://nodejs.org/">node.js</a> as well as teach fundamental concepts that are needed to write effective code.</p>

<p>This site is powered by <a href="http://github.com/creationix/wheat">Wheat</a>, a git based blogging engine written in <a href="http://nodejs.org/">node.JS</a>.</p>

<p>The content for this site is stored in a <a href="http://github.com/creationix/howtonode.org">git repository</a> that anyone can fork, write an article, and send a pull request. If your article passes the quality standards it will be published and help support the greater node community.</p></div></div><div id="footer"><p>&copy; 2011-2014 Tim Caswell under the MIT license.</p><p>Content and articles are copyrighted to the individual authors. Design by&nbsp;<a href="https://bengourley.co.uk/">Ben Gourley</a>. All code snippets used in the examples are in the public domain.</p><p>Wheat v2 running on node.js v16.4.2</p></div></div>
<script type="text/javascript">
//<![CDATA[
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
//]]>
</script>

<script type="text/javascript">
//<![CDATA[
try {
var pageTracker = _gat._getTracker("UA-12824411-1");
pageTracker._trackPageview();
} catch(err) {}
//]]>
</script>
</body>
<!-- Mirrored from localhost:8080/node-redis-fun by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 13 Jul 2021 13:59:37 GMT -->
</html>