<!DOCTYPE html>
<html lang="en">
<!-- Mirrored from localhost:8080/facebook-connect by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 13 Jul 2021 13:59:26 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset="utf-8" /><title>Facebook Connect with Node - How To Node - NodeJS</title><meta name="description" content="Learn the zen of coding in NodeJS." /><meta name="viewport" content="width=device-width" /><link href="style.css" rel="stylesheet" /><link href="print.css" rel="stylesheet" media="print" /><link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="feed.xml" /><link href="favicon.ico" rel="icon" type="image/x-icon" /></head><body><div id="container"><div id="header"><a href="index.html"><img src="logo.png" alt="How to Node" class="logo" /><div class="tagline">The zen of coding in node.js</div></a></div><div id="main"><div class="article"><h1><a href="facebook-connect.html">Facebook Connect with Node</a></h1><p class="old-node-warning">HEADS UP! This article was written for an older version of node.&nbsp;More up-to-date information may be available elsewhere.</p><p>A big part of building a new web application is repurposing common patterns, one such pattern is the ability for users to sign in and out. One way of solving this quickly is by using Facebook Connect. </p>

<h2>Background</h2>

<p>Unlike some APIs, the Facebook API is very Javascript friendly, but unfortunately it can be very time consuming to go through the maze of misdirected Facebook documentation. So in order to make Facebook integration quick and easy, I've wrapped a lot of under-the-hood code into a plugin called <a href="http://github.com/dominiek/node-facebook">node-facebook</a>. This plugin also provides examples and routines to get your Facebook Canvas application running quickly with Node, however, this article will focus on the FB Connect part.</p>

<blockquote>
  <p>Facebook's developer tools are increasingly going into the direction of more Javascript on the client-side. I also have a strong preference of offloading certain logic to the client-side. This article will also attempt to follow <a href="http://synaptify.com/?p=613702">that direction</a>.</p>
</blockquote>

<h2>Communication</h2>

<p>As you can see in this totally unnecessary diagram, most of the integration takes place on the client-side:</p>

<p><img src="http://github.com/dominiek/node-facebook/raw/master/doc/communication.png" alt="Awesome Diagram" title="Awesome Diagram" /></p>

<h2>Dependencies</h2>

<p><em>Note: For this article I've been using NodeJS version 0.1.31 and Express version 0.7.1</em></p>

<p>You need to install both <a href="http://nodejs.org/">NodeJS</a> and the <a href="http://github.com/visionmedia/express">Express Web Framework</a>. Assuming you've installed NodeJS, you can easily include express into your Git project by adding a submodule:</p>

<pre><code><span class="pln">mkdir </span><span class="pun">-</span><span class="pln">p lib</span><span class="pun">/</span><span class="pln">support<br />git submodule add git</span><span class="pun">:</span><span class="com">//github.com/visionmedia/express.git lib/support/express</span><span class="pln"><br />cd lib</span><span class="pun">/</span><span class="pln">support</span><span class="pun">/</span><span class="pln">express<br />git submodule init<br />git submodule update<br /></span></code></pre>

<p>Second, you need to include <a href="http://github.com/brainfucker/hashlib">Hashlib</a> into your project and compile it. Hashlib is a library that provides cryptographic routines like MD5:</p>

<pre><code><span class="pln">git submodule add git</span><span class="pun">:</span><span class="com">//github.com/brainfucker/hashlib.git lib/support/hashlib</span><span class="pln"><br />cd lib</span><span class="pun">/</span><span class="pln">support</span><span class="pun">/</span><span class="pln">hashlib<br />make<br /></span></code></pre>

<h2>1. Registering your Facebook Application</h2>

<p>In order to use Facebook Connect, you need to <a href="http://facebook.com/developer">register a new Facebook application</a> and set the FB Connect URL to the root of your application:</p>

<p><img src="http://github.com/dominiek/node-facebook/raw/master/doc/register_application.png" alt="Setting your FB Connect URL" title="Setting your FB Connect URL" /></p>

<h2>2. Setting up your Project</h2>

<p>For Facebook integration you need to place these three files into your project folder:</p>

<ol>
<li><a href="http://github.com/dominiek/node-facebook/raw/master/lib/facebook.js">facebook.js</a> - plugin for the Express framework - to be placed in /lib</li>
<li><a href="http://github.com/dominiek/node-facebook/raw/master/lib/jquery.facebook.js">jquery.facebook.js</a> - a simple jQuery plugin to interface with the <a href="http://wiki.developers.facebook.com/index.php/JavaScript_Client_Library">Facebook JS library</a> - to be placed in /public/javascripts</li>
<li><a href="http://github.com/dominiek/node-facebook/raw/master/examples/fb_iframe/public/xd_receiver.htm">xd_receiver.htm</a> - used by Facebook for opening up a <a href="http://wiki.developers.facebook.com/index.php/Cross_Domain_Communication_Channel">Cross-domain Communication Channel</a> - to be placed in /public</li>
</ol>

<p>After adding the dependencies and placing these files, your directory structure should look like this:</p>

<pre><code><span class="pln">myproject<br /></span><span class="pun">|--</span><span class="pln"> app</span><span class="pun">.</span><span class="pln">js </span><span class="com">/* new file */</span><span class="pln"><br /></span><span class="pun">|--</span><span class="pln"> lib<br /></span><span class="pun">|</span><span class="pln"> &nbsp; </span><span class="pun">|--</span><span class="pln"> support<br /></span><span class="pun">|</span><span class="pln"> &nbsp; </span><span class="pun">|</span><span class="pln"> &nbsp; </span><span class="pun">|--</span><span class="pln"> express<br /></span><span class="pun">|</span><span class="pln"> &nbsp; </span><span class="pun">|</span><span class="pln"> &nbsp; </span><span class="str">`-- hashlib<br />| &nbsp; |-- facebook.js<br />`</span><span class="pun">--</span><span class="pln"> </span><span class="kwd">public</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">|--</span><span class="pln"> index</span><span class="pun">.</span><span class="pln">html </span><span class="com">/* new file */</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">|--</span><span class="pln"> xd_receiver</span><span class="pun">.</span><span class="pln">htm<br />&nbsp; &nbsp; </span><span class="str">`-- javascript<br />&nbsp; &nbsp; &nbsp; &nbsp; `</span><span class="pun">--</span><span class="pln"> jquery</span><span class="pun">.</span><span class="pln">facebook</span><span class="pun">.</span><span class="pln">js<br /></span></code></pre>

<p>To make our application work, we only need to implement two files: index.html and app.js. That's right, we're only using AJAX calls and static files.</p>

<h2>3. In the Browser</h2>

<p>The provided jQuery plugin provides the following functions that we'll be using:</p>

<ul>
<li><strong>fbInit</strong> - initialize the JS lib and set up the cross-communication channel</li>
<li><strong>fbConnect</strong> - invoke the connect procedure and to synchronize sessions and profile information with our backend</li>
<li><strong>fbLogout</strong> - logout from both the Facebook Application and our NodeJS application</li>
<li><strong>fbIsAuthenticated</strong> - check whether a user is logged in or not</li>
</ul>

<p>First we start out with a simple skeleton that loads jQuery and the Facebook JS library. Please note that you need the div named <em>fb-root</em> right after the body tag for Facebook's lib to work:</p>

<pre><code><span class="tag">&lt;html&gt;</span><span class="pln"><br />&nbsp;</span><span class="tag">&lt;head&gt;</span><span class="pln"> <br />&nbsp; &nbsp; </span><span class="tag">&lt;script</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"text/javascript"</span><span class="pln"> </span><span class="atn">src</span><span class="pun">=</span><span class="atv">"http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"</span><span class="tag">&gt;&lt;/script&gt;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="tag">&lt;script</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"text/javascript"</span><span class="pln"> </span><span class="atn">src</span><span class="pun">=</span><span class="atv">"/javascripts/jquery.facebook.js"</span><span class="tag">&gt;&lt;/script&gt;</span><span class="pln"><br />&nbsp; </span><span class="tag">&lt;/head&gt;</span><span class="pln"><br /><br />&nbsp; </span><span class="tag">&lt;body&gt;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"fb-root"</span><span class="tag">&gt;&lt;/div&gt;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="tag">&lt;script</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"text/javascript"</span><span class="pln"> </span><span class="atn">src</span><span class="pun">=</span><span class="atv">"http://static.ak.connect.facebook.com/js/api_lib/v0.4/FeatureLoader.js.php"</span><span class="tag">&gt;&lt;/script&gt;</span><span class="pln"><br /><br />&nbsp; </span><span class="tag">&lt;/body&gt;</span><span class="pln"> <br /></span><span class="tag">&lt;/html&gt;</span><span class="pln"><br /></span></code></pre>

<p>Now let's implement a basic UI:</p>

<div class="snippet"><a href="facebook-connect/index.html" class="code-link">index.html</a><pre><code><span class="dec">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"<br />&nbsp; "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;</span><span class="pln"> <br /></span><span class="tag">&lt;html</span><span class="pln"> </span><span class="atn">xmlns</span><span class="pun">=</span><span class="atv">"http://www.w3.org/1999/xhtml"</span><span class="tag">&gt;</span><span class="pln"> <br />&nbsp;</span><span class="tag">&lt;head&gt;</span><span class="pln"> <br />&nbsp; &nbsp; </span><span class="tag">&lt;script</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"text/javascript"</span><span class="pln"> </span><span class="atn">src</span><span class="pun">=</span><span class="atv">"http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"</span><span class="tag">&gt;&lt;/script&gt;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="tag">&lt;script</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"text/javascript"</span><span class="pln"> </span><span class="atn">src</span><span class="pun">=</span><span class="atv">"/javascripts/jquery.facebook.js"</span><span class="tag">&gt;&lt;/script&gt;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="tag">&lt;script</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"text/javascript"</span><span class="tag">&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; $</span><span class="pun">(</span><span class="pln">document</span><span class="pun">).</span><span class="pln">ready</span><span class="pun">(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; $</span><span class="pun">.</span><span class="pln">fbInit</span><span class="pun">(</span><span class="str">'FACEBOOK_API_KEY'</span><span class="pun">);</span><span class="pln"><br /><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// FB Connect action</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; $</span><span class="pun">(</span><span class="str">'#fb-connect'</span><span class="pun">).</span><span class="pln">bind</span><span class="pun">(</span><span class="str">'click'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $</span><span class="pun">.</span><span class="pln">fbConnect</span><span class="pun">({</span><span class="str">'include'</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span><span class="str">'first_name'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'last_name'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'name'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'pic'</span><span class="pun">]},</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">fbSession</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $</span><span class="pun">(</span><span class="str">'.not_authenticated'</span><span class="pun">).</span><span class="pln">hide</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $</span><span class="pun">(</span><span class="str">'.authenticated'</span><span class="pun">).</span><span class="pln">show</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $</span><span class="pun">(</span><span class="str">'#fb-first_name'</span><span class="pun">).</span><span class="pln">html</span><span class="pun">(</span><span class="pln">fbSession</span><span class="pun">.</span><span class="pln">first_name</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br /><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// FB Logout action</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; $</span><span class="pun">(</span><span class="str">'#fb-logout'</span><span class="pun">).</span><span class="pln">bind</span><span class="pun">(</span><span class="str">'click'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $</span><span class="pun">.</span><span class="pln">fbLogout</span><span class="pun">(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $</span><span class="pun">(</span><span class="str">'.authenticated'</span><span class="pun">).</span><span class="pln">hide</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $</span><span class="pun">(</span><span class="str">'.not_authenticated'</span><span class="pun">).</span><span class="pln">show</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br /><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// Check whether we're logged in and arrange page accordingly</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; $</span><span class="pun">.</span><span class="pln">fbIsAuthenticated</span><span class="pun">(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">fbSession</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// Authenticated!</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $</span><span class="pun">(</span><span class="str">'.authenticated'</span><span class="pun">).</span><span class="pln">show</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $</span><span class="pun">(</span><span class="str">'#fb-first_name'</span><span class="pun">).</span><span class="pln">html</span><span class="pun">(</span><span class="pln">fbSession</span><span class="pun">.</span><span class="pln">first_name</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">},</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// Not authenticated</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $</span><span class="pun">(</span><span class="str">'.not_authenticated'</span><span class="pun">).</span><span class="pln">show</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br /><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="tag">&lt;/script&gt;</span><span class="pln"><br />&nbsp; </span><span class="tag">&lt;/head&gt;</span><span class="pln"><br /><br />&nbsp; </span><span class="tag">&lt;body&gt;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"fb-root"</span><span class="tag">&gt;&lt;/div&gt;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="tag">&lt;script</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"text/javascript"</span><span class="pln"> </span><span class="atn">src</span><span class="pun">=</span><span class="atv">"http://static.ak.connect.facebook.com/js/api_lib/v0.4/FeatureLoader.js.php"</span><span class="tag">&gt;&lt;/script&gt;</span><span class="pln"><br /><br />&nbsp; &nbsp; </span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"my-account"</span><span class="tag">&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"authenticated"</span><span class="pln"> </span><span class="atn">style</span><span class="pun">=</span><span class="atv">"</span><span class="pln">display</span><span class="pun">:</span><span class="pln"> none</span><span class="atv">"</span><span class="tag">&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; Hi there </span><span class="tag">&lt;span</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"fb-first_name"</span><span class="tag">&gt;&lt;/span&gt;</span><span class="pln">!<br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"#"</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"fb-logout"</span><span class="tag">&gt;</span><span class="pln">Logout</span><span class="tag">&lt;/a&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;/div&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"not_authenticated"</span><span class="pln"> </span><span class="atn">style</span><span class="pun">=</span><span class="atv">"</span><span class="pln">display</span><span class="pun">:</span><span class="pln"> none</span><span class="atv">"</span><span class="tag">&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"#"</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"fb-connect"</span><span class="tag">&gt;</span><span class="pln">Connect with Facebook</span><span class="tag">&lt;/a&gt;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="tag">&lt;/div&gt;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="tag">&lt;/div&gt;</span><span class="pln"><br />&nbsp; </span><span class="tag">&lt;/body&gt;</span><span class="pln"> <br /></span><span class="tag">&lt;/html&gt;</span></code></pre></div>

<h2>4. On the Server</h2>

<p>The <a href="http://github.com/visionmedia/express">Express</a> plugin is initialized like any other plugin in the environment configuration routine, but takes your Facebook API key and Secret as mandatory initialization arguments:</p>

<pre><code><span class="kwd">use</span><span class="pun">(</span><span class="kwd">require</span><span class="pun">(</span><span class="str">'facebook'</span><span class="pun">).</span><span class="typ">Facebook</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; apiKey</span><span class="pun">:</span><span class="pln"> </span><span class="str">'FACEBOOK_API_KEY'</span><span class="pun">,</span><span class="pln"> <br />&nbsp; apiSecret</span><span class="pun">:</span><span class="pln"> </span><span class="str">'FACEBOOK_API_SECRET'</span><span class="pln"><br /></span><span class="pun">})</span><span class="pln"><br /></span></code></pre>

<p>Next we need to implement 3 AJAX actions to make jquery.facebook.js work:</p>

<ul>
<li><strong>GET /fbSession</strong> - Is the current user logged in? Or is there a cookie/param present I can use to authenticate?</li>
<li><strong>POST /fbSession</strong> - Update additional information about the user (name, picture, etc)</li>
<li><strong>POST /fbLogout</strong> - Called after logout from the Facebook Application took place</li>
</ul>

<p>Here is an example Express application that uses no persistent storage:</p>

<div class="snippet"><a href="facebook-connect/app.js" class="code-link">app.js</a><pre><code><span class="kwd">require</span><span class="pun">.</span><span class="pln">paths</span><span class="pun">.</span><span class="pln">unshift</span><span class="pun">(</span><span class="pln">__dirname </span><span class="pun">+</span><span class="pln"> </span><span class="str">'/../../lib'</span><span class="pun">)</span><span class="pln"><br /></span><span class="kwd">require</span><span class="pun">.</span><span class="pln">paths</span><span class="pun">.</span><span class="pln">unshift</span><span class="pun">(</span><span class="pln">__dirname </span><span class="pun">+</span><span class="pln"> </span><span class="str">'/../../lib/support/express/lib'</span><span class="pun">)</span><span class="pln"><br /></span><span class="kwd">require</span><span class="pun">.</span><span class="pln">paths</span><span class="pun">.</span><span class="pln">unshift</span><span class="pun">(</span><span class="pln">__dirname </span><span class="pun">+</span><span class="pln"> </span><span class="str">'/../../lib/support/hashlib/build/default'</span><span class="pun">)</span><span class="pln"><br /><br /></span><span class="kwd">require</span><span class="pun">(</span><span class="str">'express'</span><span class="pun">)</span><span class="pln"><br /></span><span class="kwd">require</span><span class="pun">(</span><span class="str">'express/plugins'</span><span class="pun">)</span><span class="pln"><br /><br />configure</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(){</span><span class="pln"><br />&nbsp; </span><span class="kwd">use</span><span class="pun">(</span><span class="typ">MethodOverride</span><span class="pun">)</span><span class="pln"><br />&nbsp; </span><span class="kwd">use</span><span class="pun">(</span><span class="typ">ContentLength</span><span class="pun">)</span><span class="pln"><br />&nbsp; </span><span class="kwd">use</span><span class="pun">(</span><span class="typ">Cookie</span><span class="pun">)</span><span class="pln"><br />&nbsp; </span><span class="kwd">use</span><span class="pun">(</span><span class="typ">Session</span><span class="pun">)</span><span class="pln"><br />&nbsp; </span><span class="kwd">use</span><span class="pun">(</span><span class="typ">Logger</span><span class="pun">)</span><span class="pln"><br />&nbsp; </span><span class="kwd">use</span><span class="pun">(</span><span class="kwd">require</span><span class="pun">(</span><span class="str">'facebook'</span><span class="pun">).</span><span class="typ">Facebook</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; apiKey</span><span class="pun">:</span><span class="pln"> </span><span class="str">'FACEBOOK_API_KEY'</span><span class="pun">,</span><span class="pln"> <br />&nbsp; &nbsp; apiSecret</span><span class="pun">:</span><span class="pln"> </span><span class="str">'FACEBOOK_API_SECRET'</span><span class="pln"><br />&nbsp; </span><span class="pun">})</span><span class="pln"><br />&nbsp; </span><span class="kwd">set</span><span class="pun">(</span><span class="str">'root'</span><span class="pun">,</span><span class="pln"> __dirname</span><span class="pun">)</span><span class="pln"><br /></span><span class="pun">})</span><span class="pln"><br /><br /></span><span class="com">// Called to get information about the current authenticated user</span><span class="pln"><br /></span><span class="kwd">get</span><span class="pun">(</span><span class="str">'/fbSession'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(){</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> fbSession </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">fbSession</span><span class="pun">()</span><span class="pln"><br /><br />&nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">fbSession</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// Here would be a nice place to lookup userId in the database</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// and supply some additional information for the client to use</span><span class="pln"><br />&nbsp; </span><span class="pun">}</span><span class="pln"><br /><br />&nbsp; </span><span class="com">// The client will only assume authentication was OK if userId exists</span><span class="pln"><br />&nbsp; </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">contentType</span><span class="pun">(</span><span class="str">'json'</span><span class="pun">)</span><span class="pln"><br />&nbsp; </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">halt</span><span class="pun">(</span><span class="lit">200</span><span class="pun">,</span><span class="pln"> JSON</span><span class="pun">.</span><span class="pln">stringify</span><span class="pun">(</span><span class="pln">fbSession </span><span class="pun">||</span><span class="pln"> </span><span class="pun">{}))</span><span class="pln"><br /></span><span class="pun">})</span><span class="pln"><br /><br /></span><span class="com">// Called after a successful FB Connect</span><span class="pln"><br />post</span><span class="pun">(</span><span class="str">'/fbSession'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> fbSession </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">fbSession</span><span class="pun">()</span><span class="pln"> </span><span class="com">// Will return null if verification was unsuccesful</span><span class="pln"><br /><br />&nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">fbSession</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// Now that we have a Facebook Session, we might want to store this new user in the db</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// Also, in this.params there is additional information about the user (name, pic, first_name, etc)</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// Note of warning: unlike the data in fbSession, this additional information has not been verified</span><span class="pln"><br />&nbsp; &nbsp; fbSession</span><span class="pun">.</span><span class="pln">first_name </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">.</span><span class="pln">post</span><span class="pun">[</span><span class="str">'first_name'</span><span class="pun">]</span><span class="pln"><br />&nbsp; </span><span class="pun">}</span><span class="pln"><br /><br />&nbsp; </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">contentType</span><span class="pun">(</span><span class="str">'json'</span><span class="pun">)</span><span class="pln"><br />&nbsp; </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">halt</span><span class="pun">(</span><span class="lit">200</span><span class="pun">,</span><span class="pln"> JSON</span><span class="pun">.</span><span class="pln">stringify</span><span class="pun">(</span><span class="pln">fbSession </span><span class="pun">||</span><span class="pln"> </span><span class="pun">{}))</span><span class="pln"><br /></span><span class="pun">})</span><span class="pln"><br /><br /></span><span class="com">// Called on Facebook logout</span><span class="pln"><br />post</span><span class="pun">(</span><span class="str">'/fbLogout'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">fbLogout</span><span class="pun">();</span><span class="pln"><br />&nbsp; </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">halt</span><span class="pun">(</span><span class="lit">200</span><span class="pun">,</span><span class="pln"> JSON</span><span class="pun">.</span><span class="pln">stringify</span><span class="pun">({}))</span><span class="pln"><br /></span><span class="pun">})</span><span class="pln"><br /><br /></span><span class="com">// Static files in ./public</span><span class="pln"><br /></span><span class="kwd">get</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">file</span><span class="pun">){</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">sendfile</span><span class="pun">(</span><span class="pln">__dirname </span><span class="pun">+</span><span class="pln"> </span><span class="str">'/public/index.html'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">})</span><span class="pln"><br /></span><span class="kwd">get</span><span class="pun">(</span><span class="str">'/xd_receiver.htm'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">file</span><span class="pun">){</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">sendfile</span><span class="pun">(</span><span class="pln">__dirname </span><span class="pun">+</span><span class="pln"> </span><span class="str">'/public/xd_receiver.htm'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">})</span><span class="pln"><br /></span><span class="kwd">get</span><span class="pun">(</span><span class="str">'/javascripts/jquery.facebook.js'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">file</span><span class="pun">){</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">sendfile</span><span class="pun">(</span><span class="pln">__dirname </span><span class="pun">+</span><span class="pln"> </span><span class="str">'/public/javascripts/jquery.facebook.js'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">})</span><span class="pln"><br /><br />run</span><span class="pun">()</span></code></pre></div>

<blockquote>
  <p>The verification of Facebook data by the server-side is done by using the Application Secret and the signature that's sent along with the data. First, all parameters and cookies are put together in one string and then the Application Secret is appended to it. The MD5 hash of this string should match the signature that's included. <a href="http://wiki.developers.facebook.com/index.php/Verifying_The_Signature">more about verifying the signature</a></p>
</blockquote>

<p>In any subsequently added action, you can access the Facebook Session simply like this:</p>

<pre><code><span class="kwd">get</span><span class="pun">(</span><span class="str">'/hello'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> fbSession </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">fbSession</span><span class="pun">()</span><span class="pln"><br />&nbsp; </span><span class="kwd">return</span><span class="pln"> </span><span class="str">'Hello '</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">' user '</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> fbSession</span><span class="pun">.</span><span class="pln">userId </span><span class="pun">+</span><span class="pln"> </span><span class="str">'!'</span><span class="pun">;</span><span class="pln"><br /></span><span class="pun">})</span><span class="pln"><br /></span></code></pre>

<h2>6. Further Development</h2>

<p>In this article we went into the direction of putting a lot of UI flow and controller logic into the browser. This can be quite counter-intuitive. As a Rails-programmer and former RJS lover, I can attest to that. However, while there are still remaining issues like SEO and accessibility, this approach allows the server to really focus on data modelling/routing and has numerous scaling benefits.</p>

<p>All examples in this article and more can be found on the <a href="http://github.com/dominiek/node-facebook">node-facebook repository</a> I created. If you run into any obstacles, feel free to <a href="http://dominiek.com/">contact me</a> or fork the code. I hope to soon write a similar plugin for Twitter's OAUTH based login.</p>

<h2>Appendix A: Facebook Troubleshooting Checklist</h2>

<p>Debugging Facebook Application problems can be a real pain in the neck, here is a simple checklist distilled from many frustrating mind-cycles:</p>

<ul>
<li>Are you sure xd_receiver.htm is in place and being accessed?</li>
<li>Are you sure the <div id="root"></div> element is present in the body?</li>
<li>If you are using Safari with iFrames, there are some <a href="http://saizai.livejournal.com/897522.html">cookie hacks</a> you need to do</li>
<li>Are cookies being set successfully after FB connect?</li>
<li>Are you sure you're using the correct API keys?</li>
</ul><hr style="clear:both" /><div class="body" id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
var disqus_url = "http://howtonode.org/facebook-connect";
//]]>
</script>
<script src="http://disqus.com/forums/howtonodeorg/embed.js" type="text/javascript"></script><a href="http://disqus.com/forums/howtonodeorg/?url=ref" class="view-thread">View the discussion thread.</a><a href="http://disqus.com/" class="dsq-brlink">blog comments powered by<span class="logo-disqus">Disqus</span></a>
<script type="text/javascript">
//<![CDATA[
(function() {
  var links = document.getElementsByTagName('a');
  var query = '?';
  for(var i = 0; i < links.length; i++) {
    if(links[i].href.indexOf('#disqus_thread') >= 0) {
      query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&amp;';
    }
  }
  document.write('<script charset="utf-8" type="text/javascript" src="//disqus.com/forums/howtonodeorg/get_num_replies.js' + query + '"></' + 'script>');
})();


//]]>
</script>
</div></div><div id="sidebar"><div class="aside author"><h4>About the Author</h4><img src="https://www.gravatar.com/avatar/915536f4dd86d38a6334fd95e0845752?r=pg&amp;s=200.jpg&amp;d=identicon" class="headshot" /><dl><dt>Name:</dt><dd>Dominiek ter Heide</dd></dl><dl><dt>Github:</dt><dd><a href="https://github.com/dominiek">dominiek</a></dd></dl><dl><dt>Twitter:</dt><dd><a href="https://twitter.com/dominiek">dominiek</a></dd></dl></div><div class="aside"><h4>About this Article</h4><a href="http://twitter.com/share" data-count="horizontal" data-via="creationix" class="twitter-share-button">Tweet</a><script src="http://platform.twitter.com/widgets.js"></script><dl title="Thu Mar 18 2010 22:00:00 GMT+0000 (UTC)"><dt>Date Released:</dt><dd>Thursday, March 18, 2010</dd></dl><dl><dt>Node Version:</dt><dd><a href="http://github.com/joyent/node/tree/v0.1.31">node v0.1.31</a></dd></dl><dl><dt>Code Samples:</dt><dd><ul><li><a href="facebook-connect/index.html">index.html</a></li><li><a href="facebook-connect/app.js">app.js</a></li></ul></dd></dl><dl><dt>Revisions:</dt><dd><ul></ul></dd></dl></div><div class="bubble"><h3>About HowToNode.org</h3>

<p>HowToNode.org is a community supported blog created by <a href="http://creationix.com/">Tim Caswell</a>. The purpose of the blog is to teach how to do various tasks in <a href="http://nodejs.org/">node.js</a> as well as teach fundamental concepts that are needed to write effective code.</p>

<p>This site is powered by <a href="http://github.com/creationix/wheat">Wheat</a>, a git based blogging engine written in <a href="http://nodejs.org/">node.JS</a>.</p>

<p>The content for this site is stored in a <a href="http://github.com/creationix/howtonode.org">git repository</a> that anyone can fork, write an article, and send a pull request. If your article passes the quality standards it will be published and help support the greater node community.</p></div></div><div id="footer"><p>&copy; 2011-2014 Tim Caswell under the MIT license.</p><p>Content and articles are copyrighted to the individual authors. Design by&nbsp;<a href="https://bengourley.co.uk/">Ben Gourley</a>. All code snippets used in the examples are in the public domain.</p><p>Wheat v2 running on node.js v16.4.2</p></div></div>
<script type="text/javascript">
//<![CDATA[
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
//]]>
</script>

<script type="text/javascript">
//<![CDATA[
try {
var pageTracker = _gat._getTracker("UA-12824411-1");
pageTracker._trackPageview();
} catch(err) {}
//]]>
</script>
</body>
<!-- Mirrored from localhost:8080/facebook-connect by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 13 Jul 2021 13:59:28 GMT -->
</html>