<!DOCTYPE html>
<html lang="en">
<!-- Mirrored from localhost:8080/do-it-fast by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 13 Jul 2021 13:59:37 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset="utf-8" /><title>&quot;Do&quot; it fast! - How To Node - NodeJS</title><meta name="description" content="Learn the zen of coding in NodeJS." /><meta name="viewport" content="width=device-width" /><link href="style.css" rel="stylesheet" /><link href="print.css" rel="stylesheet" media="print" /><link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="feed.xml" /><link href="favicon.ico" rel="icon" type="image/x-icon" /></head><body><div id="container"><div id="header"><a href="index.html"><img src="logo.png" alt="How to Node" class="logo" /><div class="tagline">The zen of coding in node.js</div></a></div><div id="main"><div class="article"><h1><a href="do-it-fast.html">&quot;Do&quot; it fast!</a></h1><p class="old-node-warning">HEADS UP! This article was written for an older version of node.&nbsp;More up-to-date information may be available elsewhere.</p><p>Now with the release of <a href="http://groups.google.com/group/nodejs/browse_thread/thread/e6cc6f04cd0ddf14">Node v0.1.30</a> there is even more need for a library like <a href="http://github.com/creationix/do">Do</a>.  While working with the node community to decide on the best alternative to node promises, we decided that it's best left to library developers.  So as of this morning, node no longer ships with promises, but uses a simple callback interface for all async functions.</p>

<p>I took my async library that I've been developing throughout the Control Flow series and made it into a real library called <a href="http://github.com/creationix/do">Do</a>.</p>

<h2>Node callback interface</h2>

<p>All async functions in node now use a simple callback based interface:</p>

<div class="snippet"><a href="do-it-fast/async.js" class="code-link">async.js</a><pre><code><span class="kwd">var</span><span class="pln"> fs </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'fs'</span><span class="pun">);</span><span class="pln"><br /><br />fs</span><span class="pun">.</span><span class="pln">readdir</span><span class="pun">(</span><span class="str">"/usr"</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> files</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">throw</span><span class="pln"> err</span><span class="pun">;</span><span class="pln"><br />&nbsp; console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"/usr files: "</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> files</span><span class="pun">);</span><span class="pln"><br /></span><span class="pun">});</span></code></pre></div>

<p>That is, after the arguments, there is a callback function expected.  This callback function will be given the error if there was one, and if not, the result after that.</p>

<p>Creating an async function that exports this interface is simple too:</p>

<div class="snippet"><a href="do-it-fast/plain_callbacks.js" class="code-link">plain_callbacks.js</a><pre><code><span class="kwd">function</span><span class="pln"> errorHandler</span><span class="pun">(</span><span class="pln">error</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">throw</span><span class="pln"> error</span><span class="pun">;</span><span class="pln"><br /></span><span class="pun">}</span><span class="pln"><br /><br /></span><span class="com">// Load 'fs', a built-in node library that has async functions</span><span class="pln"><br /></span><span class="kwd">var</span><span class="pln"> fs </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'fs'</span><span class="pun">);</span><span class="pln"><br /><br /></span><span class="kwd">function</span><span class="pln"> safeRead</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; fs</span><span class="pun">.</span><span class="pln">readFile</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">error</span><span class="pun">.</span><span class="pln">errno </span><span class="pun">===</span><span class="pln"> process</span><span class="pun">.</span><span class="pln">ENOENT</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// Ignore file not found errors and return an empty result</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; callback</span><span class="pun">(</span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> </span><span class="str">""</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// Pass other errors through as is</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; callback</span><span class="pun">(</span><span class="pln">err</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="com">// Pass successes through as it too.</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; callback</span><span class="pun">(</span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; </span><span class="pun">})</span><span class="pln"><br /></span><span class="pun">}</span><span class="pln"><br /><br />safeRead</span><span class="pun">(</span><span class="pln">__filename</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> text</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; errorHandler</span><span class="pun">(</span><span class="pln">err</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">text</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">}</span><span class="pln"><br /></span><span class="pun">});</span></code></pre></div>

<p>These callbacks are fast, simple, and to-the-point.  However, your code can get pretty hairy when you start expanding beyond these trivial examples.  These simple callback based functions can't be used with aggregate utilities, they can't be implicitly chained or grouped either.</p>

<h2>We can <code>Do</code> better.</h2>

<p><code>Do</code> is a library that adds higher level abstraction and continuables.  What I mean by a continuable is explained by the following:</p>

<h3>Continuables</h3>

<div class="snippet"><a href="do-it-fast/divide.js" class="code-link">divide.js<span class="hash">#define</span></a><pre><code><span class="kwd">function</span><span class="pln"> divide</span><span class="pun">(</span><span class="pln">a</span><span class="pun">,</span><span class="pln"> b</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">callback</span><span class="pun">,</span><span class="pln"> errback</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="com">// Use nextTick to prove that we're working asynchronously</span><span class="pln"><br />&nbsp; process</span><span class="pun">.</span><span class="pln">nextTick</span><span class="pun">(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">b </span><span class="pun">===</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; errback</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Error</span><span class="pun">(</span><span class="str">"Cannot divide by 0"</span><span class="pun">));</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; callback</span><span class="pun">(</span><span class="pln">a </span><span class="pun">/</span><span class="pln"> b</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /></span><span class="pun">}}</span></code></pre></div>

<p><code>Do</code> expects async functions to not require the callback in the initial invocation, but instead return a continuable which can then be called with the <code>callback</code> and <code>errback</code>.  This is done by manually currying the function. The "continuable" is the function returned by the outer function.  The body of the function won't be executed until you finish the application by attaching a callback.</p>

<div class="snippet"><a href="do-it-fast/divide.js" class="code-link">divide.js<span class="hash">#use</span></a><pre><code><span class="pln">divide</span><span class="pun">(</span><span class="lit">100</span><span class="pun">,</span><span class="pln"> </span><span class="lit">10</span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">result</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"the result is "</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> result</span><span class="pun">);</span><span class="pln"><br /></span><span class="pun">},</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">error</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">throw</span><span class="pln"> error</span><span class="pun">;</span><span class="pln"><br /></span><span class="pun">});</span></code></pre></div>

<p>This style is extremely simple, and is fairly powerful.</p>

<ul>
<li>The initial function can have variable arguments.</li>
<li>The continuable itself is portable until it's invoked by attaching callbacks.</li>
</ul>

<h3>Why is this better than plain-ol-callbacks?</h3>

<p>Well, let's convert the <code>safeRead</code> example from above to continuables:</p>

<div class="snippet"><a href="do-it-fast/continuable_based.js" class="code-link">continuable_based.js</a><pre><code><span class="kwd">function</span><span class="pln"> errorHandler</span><span class="pun">(</span><span class="pln">error</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">throw</span><span class="pln"> error</span><span class="pun">;</span><span class="pln"><br /></span><span class="pun">}</span><span class="pln"><br /><br /></span><span class="kwd">var</span><span class="pln"> </span><span class="typ">Do</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'do'</span><span class="pun">);</span><span class="pln"><br /></span><span class="com">// Convert `readFile` from fs to use continuable style.</span><span class="pln"><br /></span><span class="kwd">var</span><span class="pln"> fs </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Do</span><span class="pun">.</span><span class="pln">convert</span><span class="pun">(</span><span class="kwd">require</span><span class="pun">(</span><span class="str">'fs'</span><span class="pun">),</span><span class="pln"> </span><span class="pun">[</span><span class="str">'readFile'</span><span class="pun">]);</span><span class="pln"><br /><br /></span><span class="kwd">function</span><span class="pln"> safeRead</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">callback</span><span class="pun">,</span><span class="pln"> errback</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; fs</span><span class="pun">.</span><span class="pln">readFile</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)(</span><span class="pln">callback</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">error</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">error</span><span class="pun">.</span><span class="pln">errno </span><span class="pun">===</span><span class="pln"> process</span><span class="pun">.</span><span class="pln">ENOENT</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; callback</span><span class="pun">(</span><span class="str">""</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; errback</span><span class="pun">(</span><span class="pln">error</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; </span><span class="pun">})</span><span class="pln"><br /></span><span class="pun">}}</span><span class="pln"><br /><br />safeRead</span><span class="pun">(</span><span class="pln">__filename</span><span class="pun">)(</span><span class="pln">console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">,</span><span class="pln"> errorHandler</span><span class="pun">);</span></code></pre></div>

<p>You'll notice that this is a lot shorter and you don't have to constantly check for the error argument or pad your success results with a <code>null</code> argument.  Also since we're passing through the success case as is, we can use the outer <code>callback</code> as the inner <code>callback</code>.  In most cases you won't do this for success, but you will for <code>errback</code>.</p>

<h3>What about the rest of <code>Do</code>?</h3>

<p>The real power of <code>Do</code> and continuables comes when you're dealing with several async functions as once.  Let's take our example from the <a href="http://howtonode.org/control-flow-part-iii">third control flow article</a> and convert it to use the new <code>Do</code> library:</p>

<h2>How to <code>Do</code> (API)</h2>

<p>The <code>Do</code> library makes doing higher-level abstractions easy.  All of these helpers are themselves continuables so you can attach callbacks by calling the returned, curried function.</p>

<h3>Do.parallel(actions) {...}</h3>

<p>Takes an array of actions and runs them all in parallel. You can either pass in an array of actions, or several actions as function arguments.</p>

<ul>
<li>If you pass in an array, then the output will be an array of all the results</li>
<li>If you pass in separate arguments, then the output will have several arguments.</li>
</ul>

<p><strong>Example:</strong></p>

<div class="snippet"><a href="do-it-fast/parallel-example.js" class="code-link">parallel-example.js</a><pre><code><span class="com">// Multiple arguments</span><span class="pln"><br /></span><span class="typ">Do</span><span class="pun">.</span><span class="pln">parallel</span><span class="pun">(</span><span class="pln"><br />&nbsp; </span><span class="typ">Do</span><span class="pun">.</span><span class="pln">read</span><span class="pun">(</span><span class="str">"/etc/passwd"</span><span class="pun">),</span><span class="pln"><br />&nbsp; </span><span class="typ">Do</span><span class="pun">.</span><span class="pln">read</span><span class="pun">(</span><span class="pln">__filename</span><span class="pun">)</span><span class="pln"><br /></span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">passwd</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="com">// Do something</span><span class="pln"><br /></span><span class="pun">},</span><span class="pln"> errorHandler</span><span class="pun">);</span><span class="pln"><br /><br /></span><span class="com">// Single argument</span><span class="pln"><br /></span><span class="kwd">var</span><span class="pln"> actions </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln"><br />&nbsp; </span><span class="typ">Do</span><span class="pun">.</span><span class="pln">read</span><span class="pun">(</span><span class="str">"/etc/passwd"</span><span class="pun">),</span><span class="pln"><br />&nbsp; </span><span class="typ">Do</span><span class="pun">.</span><span class="pln">read</span><span class="pun">(</span><span class="str">"__filename"</span><span class="pun">)</span><span class="pln"><br /></span><span class="pun">];</span><span class="pln"><br /></span><span class="typ">Do</span><span class="pun">.</span><span class="pln">parallel</span><span class="pun">(</span><span class="pln">actions</span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">results</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="com">// Do something</span><span class="pln"><br /></span><span class="pun">},</span><span class="pln"> errorHandler</span><span class="pun">);</span></code></pre></div>

<h3>Do.chain(actions) {...}</h3>

<p>Chains together several actions feeding the output of the first to the input of the second and the final output to the continuables callback.</p>

<p><strong>Example:</strong></p>

<div class="snippet"><a href="do-it-fast/chain-example.js" class="code-link">chain-example.js</a><pre><code><span class="com">// Multiple arguments</span><span class="pln"><br /></span><span class="typ">Do</span><span class="pun">.</span><span class="pln">chain</span><span class="pun">(</span><span class="pln"><br />&nbsp; </span><span class="typ">Do</span><span class="pun">.</span><span class="pln">read</span><span class="pun">(</span><span class="pln">__filename</span><span class="pun">),</span><span class="pln"><br />&nbsp; </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">text</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Do</span><span class="pun">.</span><span class="pln">save</span><span class="pun">(</span><span class="str">"newfile"</span><span class="pun">,</span><span class="pln"> text</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">},</span><span class="pln"><br />&nbsp; </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Do</span><span class="pun">.</span><span class="pln">stat</span><span class="pun">(</span><span class="str">"newfile"</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">}</span><span class="pln"><br /></span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">stat</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="com">// Do something</span><span class="pln"><br /></span><span class="pun">},</span><span class="pln"> errorHandler</span><span class="pun">);</span><span class="pln"><br /><br /></span><span class="com">// Single argument</span><span class="pln"><br /></span><span class="kwd">var</span><span class="pln"> actions </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln"><br />&nbsp; </span><span class="typ">Do</span><span class="pun">.</span><span class="pln">read</span><span class="pun">(</span><span class="pln">__filename</span><span class="pun">),</span><span class="pln"><br />&nbsp; </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">text</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Do</span><span class="pun">.</span><span class="pln">save</span><span class="pun">(</span><span class="str">"newfile"</span><span class="pun">,</span><span class="pln"> text</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">},</span><span class="pln"><br />&nbsp; </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Do</span><span class="pun">.</span><span class="pln">stat</span><span class="pun">(</span><span class="str">"newfile"</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">}</span><span class="pln"><br /></span><span class="pun">];</span><span class="pln"><br /></span><span class="typ">Do</span><span class="pun">.</span><span class="pln">chain</span><span class="pun">(</span><span class="pln">actions</span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">stat</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="com">// Do something</span><span class="pln"><br /></span><span class="pun">},</span><span class="pln"> errorHandler</span><span class="pun">);</span></code></pre></div>

<h3>Do.map(array, fn) {...}</h3>

<p>Takes an array and does an array map over it using the async callback <code>fn</code>. The signature of <code>fn</code> is <code>function fn(item, callback, errback)</code> or any regular continuable.</p>

<p><strong>Example:</strong></p>

<div class="snippet"><a href="do-it-fast/map-example.js" class="code-link">map-example.js</a><pre><code><span class="com">// Direct callback filter</span><span class="pln"><br /></span><span class="kwd">var</span><span class="pln"> files </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="str">'users.json'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'pages.json'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'products.json'</span><span class="pun">];</span><span class="pln"><br /></span><span class="kwd">function</span><span class="pln"> loadFile</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">,</span><span class="pln"> errback</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; fs</span><span class="pun">.</span><span class="pln">read</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; callback</span><span class="pun">([</span><span class="pln">filename</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">]);</span><span class="pln"><br />&nbsp; </span><span class="pun">},</span><span class="pln"> errback</span><span class="pun">);</span><span class="pln"><br /></span><span class="pun">}</span><span class="pln"><br /></span><span class="typ">Do</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="pln">files</span><span class="pun">,</span><span class="pln"> loadFile</span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">contents</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="com">// Do something</span><span class="pln"><br /></span><span class="pun">},</span><span class="pln"> errorHandler</span><span class="pun">);</span><span class="pln"><br /><br /></span><span class="com">// continuable based filter</span><span class="pln"><br /></span><span class="kwd">var</span><span class="pln"> files </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="str">'users.json'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'pages.json'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'products.json'</span><span class="pun">];</span><span class="pln"><br /></span><span class="typ">Do</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="pln">files</span><span class="pun">,</span><span class="pln"> fs</span><span class="pun">.</span><span class="pln">read</span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">contents</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="com">// Do something</span><span class="pln"><br /></span><span class="pun">},</span><span class="pln"> errorHandler</span><span class="pun">);</span></code></pre></div>

<h3>Do.filter(array, fn) {...}</h3>

<p>Takes an array and does an array filter over it using the async callback <code>fn</code>. The signature of <code>fn</code> is <code>function fn(item, callback, errback)</code> or any regular continuable.</p>

<p><strong>Example:</strong></p>

<div class="snippet"><a href="do-it-fast/filter-example.js" class="code-link">filter-example.js</a><pre><code><span class="com">// Direct callback filter</span><span class="pln"><br /></span><span class="kwd">var</span><span class="pln"> files </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="str">'users.json'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'pages.json'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'products.json'</span><span class="pun">];</span><span class="pln"><br /></span><span class="kwd">function</span><span class="pln"> isFile</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">,</span><span class="pln"> errback</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; fs</span><span class="pun">.</span><span class="pln">stat</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">stat</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; callback</span><span class="pun">(</span><span class="pln">stat</span><span class="pun">.</span><span class="pln">isFile</span><span class="pun">());</span><span class="pln"><br />&nbsp; </span><span class="pun">},</span><span class="pln"> errback</span><span class="pun">);</span><span class="pln"><br /></span><span class="pun">}</span><span class="pln"><br /></span><span class="typ">Do</span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="pln">files</span><span class="pun">,</span><span class="pln"> isFile</span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">filtered_files</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="com">// Do something</span><span class="pln"><br /></span><span class="pun">},</span><span class="pln"> errorHandler</span><span class="pun">);</span><span class="pln"><br /><br /></span><span class="com">// Continuable based filter</span><span class="pln"><br /></span><span class="kwd">var</span><span class="pln"> files </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="str">'users.json'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'pages.json'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'products.json'</span><span class="pun">];</span><span class="pln"><br /></span><span class="kwd">function</span><span class="pln"> isFile</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">callback</span><span class="pun">,</span><span class="pln"> errback</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; fs</span><span class="pun">.</span><span class="pln">stat</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">stat</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; callback</span><span class="pun">(</span><span class="pln">stat</span><span class="pun">.</span><span class="pln">isFile</span><span class="pun">());</span><span class="pln"><br />&nbsp; </span><span class="pun">},</span><span class="pln"> errback</span><span class="pun">);</span><span class="pln"><br /></span><span class="pun">}}</span><span class="pln"><br /></span><span class="typ">Do</span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="pln">files</span><span class="pun">,</span><span class="pln"> isFile</span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">filtered_files</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="com">// Do something</span><span class="pln"><br /></span><span class="pun">},</span><span class="pln"> errorHandler</span><span class="pun">);</span></code></pre></div>

<h3>Do.filterMap(array, fn) {...}</h3>

<p>Takes an array and does a combined filter and map over it.  If the result
of an item is undefined, then it's filtered out, otherwise it's mapped in.
The signature of <code>fn</code> is <code>function fn(item, callback, errback)</code> or any regular continuable.</p>

<p><strong>Example:</strong></p>

<div class="snippet"><a href="do-it-fast/filtermap-example.js" class="code-link">filtermap-example.js</a><pre><code><span class="com">// Direct callback filter</span><span class="pln"><br /></span><span class="kwd">var</span><span class="pln"> files </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="str">'users.json'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'pages.json'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'products.json'</span><span class="pun">];</span><span class="pln"><br /></span><span class="kwd">function</span><span class="pln"> check_and_load</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">,</span><span class="pln"> errback</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; fs</span><span class="pun">.</span><span class="pln">stat</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">stat</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">stat</span><span class="pun">.</span><span class="pln">isFile</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; loadFile</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">,</span><span class="pln"> errback</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; callback</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; </span><span class="pun">},</span><span class="pln"> errback</span><span class="pun">);</span><span class="pln"><br /></span><span class="pun">}</span><span class="pln"><br /></span><span class="typ">Do</span><span class="pun">.</span><span class="pln">filterMap</span><span class="pun">(</span><span class="pln">files</span><span class="pun">,</span><span class="pln"> check_and_load</span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">filtered_files_with_data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="com">// Do something</span><span class="pln"><br /></span><span class="pun">},</span><span class="pln"> errorHandler</span><span class="pun">);</span><span class="pln"><br /><br /></span><span class="com">// Continuable based filter</span><span class="pln"><br /></span><span class="kwd">var</span><span class="pln"> files </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="str">'users.json'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'pages.json'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'products.json'</span><span class="pun">];</span><span class="pln"><br /></span><span class="kwd">function</span><span class="pln"> check_and_load</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">callback</span><span class="pun">,</span><span class="pln"> errback</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; fs</span><span class="pun">.</span><span class="pln">stat</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">stat</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">stat</span><span class="pun">.</span><span class="pln">isFile</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; loadFile</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">,</span><span class="pln"> errback</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; callback</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; </span><span class="pun">},</span><span class="pln"> errback</span><span class="pun">);</span><span class="pln"><br /></span><span class="pun">}}</span><span class="pln"><br /></span><span class="typ">Do</span><span class="pun">.</span><span class="pln">filterMap</span><span class="pun">(</span><span class="pln">files</span><span class="pun">,</span><span class="pln"> check_and_load</span><span class="pun">)(</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">filtered_files_with_data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="com">// Do something</span><span class="pln"><br /></span><span class="pun">},</span><span class="pln"> errorHandler</span><span class="pun">);</span></code></pre></div>

<h2>Using with node libraries</h2>

<p>Do has a super nifty <code>Do.convert</code> function that takes a library and converts it to use Do style continuables.  For example, if you wanted to use <code>fs.readFile</code> and <code>fs.writeFile</code>, then you would do this:</p>

<pre><code><span class="kwd">var</span><span class="pln"> fs </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Do</span><span class="pun">.</span><span class="pln">convert</span><span class="pun">(</span><span class="kwd">require</span><span class="pun">(</span><span class="str">'fs'</span><span class="pun">),</span><span class="pln"> </span><span class="pun">[</span><span class="str">'readFile'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'writeFile'</span><span class="pun">]);</span><span class="pln"><br /></span></code></pre>

<p>Do will give you a copy of <code>fs</code> that has <code>readFile</code> and <code>writeFile</code> converted to Do style.  It's that easy!</p>

<h2>For library writers</h2>

<p>All async functions in node follow a common interface:</p>

<pre><code><span class="pln">method</span><span class="pun">(</span><span class="pln">arg1</span><span class="pun">,</span><span class="pln"> arg2</span><span class="pun">,</span><span class="pln"> arg3</span><span class="pun">,</span><span class="pln"> </span><span class="pun">...,</span><span class="pln"> callback</span><span class="pun">)</span><span class="pln"><br /></span></code></pre>

<p>Where <code>callback</code> is of the form:</p>

<pre><code><span class="pln">callback</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> result1</span><span class="pun">,</span><span class="pln"> result2</span><span class="pun">,</span><span class="pln"> </span><span class="pun">...)</span><span class="pln"><br /></span></code></pre>

<p>This is done to keep node simple and to allow for interoperability between the various async abstractions like Do continuables and CommonJS promises.</p>

<p>If you're writing a library, make sure to export all your async functions following the node interface.  Then anyone using your library can know what format to expect.</p><hr style="clear:both" /><div class="body" id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
var disqus_url = "http://howtonode.org/do-it-fast";
//]]>
</script>
<script src="http://disqus.com/forums/howtonodeorg/embed.js" type="text/javascript"></script><a href="http://disqus.com/forums/howtonodeorg/?url=ref" class="view-thread">View the discussion thread.</a><a href="http://disqus.com/" class="dsq-brlink">blog comments powered by<span class="logo-disqus">Disqus</span></a>
<script type="text/javascript">
//<![CDATA[
(function() {
  var links = document.getElementsByTagName('a');
  var query = '?';
  for(var i = 0; i < links.length; i++) {
    if(links[i].href.indexOf('#disqus_thread') >= 0) {
      query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&amp;';
    }
  }
  document.write('<script charset="utf-8" type="text/javascript" src="//disqus.com/forums/howtonodeorg/get_num_replies.js' + query + '"></' + 'script>');
})();


//]]>
</script>
</div></div><div id="sidebar"><div class="aside author"><h4>About the Author</h4><img src="https://www.gravatar.com/avatar/c953ddd239707998340e1a6fbb3eeb46?r=pg&amp;s=200.jpg&amp;d=identicon" class="headshot" /><dl><dt>Name:</dt><dd>Tim Caswell</dd></dl><dl><dt>Github:</dt><dd><a href="https://github.com/creationix">creationix</a></dd></dl><dl><dt>Twitter:</dt><dd><a href="https://twitter.com/creationix">creationix</a></dd></dl><dl><dt>Location:</dt><dd>Red Lick, TX</dd></dl><dl><dt>Links:</dt><dd><a href="http://creationix.com/">Homepage</a></dd></dl></div><div class="aside"><h4>About this Article</h4><a href="http://twitter.com/share" data-count="horizontal" data-via="creationix" class="twitter-share-button">Tweet</a><script src="http://platform.twitter.com/widgets.js"></script><dl title="Mon Feb 22 2010 10:52:08 GMT-0600 (CST)"><dt>Date Released:</dt><dd>Monday, February 22, 2010</dd></dl><dl><dt>Node Version:</dt><dd><a href="http://github.com/joyent/node/tree/v0.1.102">node v0.1.102</a></dd></dl><dl><dt>Code Samples:</dt><dd><ul><li><a href="do-it-fast/async.js">async.js</a></li><li><a href="do-it-fast/plain_callbacks.js">plain_callbacks.js</a></li><li><a href="do-it-fast/divide.js">divide.js</a></li><li><a href="do-it-fast/continuable_based.js">continuable_based.js</a></li><li><a href="do-it-fast/parallel-example.js">parallel-example.js</a></li><li><a href="do-it-fast/chain-example.js">chain-example.js</a></li><li><a href="do-it-fast/map-example.js">map-example.js</a></li><li><a href="do-it-fast/filter-example.js">filter-example.js</a></li><li><a href="do-it-fast/filtermap-example.js">filtermap-example.js</a></li></ul></dd></dl><dl><dt>Revisions:</dt><dd><ul></ul></dd></dl></div><div class="bubble"><h3>About HowToNode.org</h3>

<p>HowToNode.org is a community supported blog created by <a href="http://creationix.com/">Tim Caswell</a>. The purpose of the blog is to teach how to do various tasks in <a href="http://nodejs.org/">node.js</a> as well as teach fundamental concepts that are needed to write effective code.</p>

<p>This site is powered by <a href="http://github.com/creationix/wheat">Wheat</a>, a git based blogging engine written in <a href="http://nodejs.org/">node.JS</a>.</p>

<p>The content for this site is stored in a <a href="http://github.com/creationix/howtonode.org">git repository</a> that anyone can fork, write an article, and send a pull request. If your article passes the quality standards it will be published and help support the greater node community.</p></div></div><div id="footer"><p>&copy; 2011-2014 Tim Caswell under the MIT license.</p><p>Content and articles are copyrighted to the individual authors. Design by&nbsp;<a href="https://bengourley.co.uk/">Ben Gourley</a>. All code snippets used in the examples are in the public domain.</p><p>Wheat v2 running on node.js v16.4.2</p></div></div>
<script type="text/javascript">
//<![CDATA[
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
//]]>
</script>

<script type="text/javascript">
//<![CDATA[
try {
var pageTracker = _gat._getTracker("UA-12824411-1");
pageTracker._trackPageview();
} catch(err) {}
//]]>
</script>
</body>
<!-- Mirrored from localhost:8080/do-it-fast by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 13 Jul 2021 13:59:46 GMT -->
</html>